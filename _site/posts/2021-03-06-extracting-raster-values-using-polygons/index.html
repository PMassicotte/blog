<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.36">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Philippe Massicotte">
<meta name="dcterms.date" content="2021-03-06">
<title>Welcome to my blog - Extracting raster values using the stars R package</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><link rel="stylesheet" href="../../styles.css">
</head>
<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Welcome to my blog</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item">
    <a class="nav-link" href="../../about.html">About</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications.html">Publications</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../presentations.html">Presentations</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../workshops.html">Workshops and teaching</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pmassicotte"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/philmassicotte"><i class="bi bi-twitter" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../users/5558188/philippe-massicotte"><i class="bi bi-stack-overflow" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"><i class="bi bi-rss" role="img">
</i> 
 </a>
  </li>  
</ul>
<div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><header id="title-block-header" class="quarto-title-block default page-columns page-full"><div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Extracting raster values using the stars R package</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">R</div>
                <div class="quarto-category">geospatial</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Philippe Massicotte </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 6, 2021</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content"><section id="introduction" class="level2"><h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>For a long time, I have been using the <code>raster</code> package to manipulate raster data in R. Slowly, I am trying to work my way out with the <em>new</em> <code>stars</code> package. In this post, I am exploring different ways to extract values from a raster at different geographic locations. For this exercise, I am using a Landsat 7 image that is provided within the <code>stars</code> package. Each pixel has a resolution of 30 meters.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/">stars</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/PMassicotte/ggpmthemes">ggpmthemes</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ggpmthemes/man/theme_maven.html">theme_maven</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-2_926a0fcd9a20d228173c386dca529fa2">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create a palette for later</span></span>
<span><span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu">paletteer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/paletteer/man/paletteer_d.html">paletteer_d</a></span><span class="op">(</span><span class="st">"RColorBrewer::Pastel2"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Open the tif and extract the 1 band</span></span>
<span><span class="va">tif</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"tif/L7_ETMs.tif"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">tif</span><span class="op">)</span><span class="op">[</span>, , , <span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># What are the dimensions?</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">st_dimensions</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="co">#&gt;      from  to  offset delta                     refsys point values x/y</span></span>
<span><span class="co">#&gt; x       1 349  288776  28.5 SIRGAS 2000 / UTM zone 25S FALSE   NULL [x]</span></span>
<span><span class="co">#&gt; y       1 352 9120761 -28.5 SIRGAS 2000 / UTM zone 25S FALSE   NULL [y]</span></span>
<span><span class="co">#&gt; band    1   1      NA    NA                         NA    NA   NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is what the original image looks like.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-3_02f06a5a1f8f5177ba4339c872a8fe93">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">r</span>, key.pos <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>To better visualize the process of subsetting raster values, let’s crop the image so we can see the pixels.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-4_eed097b3483517559b631aa9da8280e9">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span><span class="co">#&gt;      xmin      ymin      xmax      ymax </span></span>
<span><span class="co">#&gt;  288776.3 9110728.8  298722.8 9120760.8</span></span>
<span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="va">r</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    xmin <span class="op">=</span> <span class="fl">294000</span>,</span>
<span>    xmax <span class="op">=</span> <span class="fl">294500</span>,</span>
<span>    ymin <span class="op">=</span> <span class="fl">9110800</span>,</span>
<span>    ymax <span class="op">=</span> <span class="fl">9111200</span></span>
<span>  <span class="op">)</span>, crs <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">r</span>, reset <span class="op">=</span> <span class="cn">FALSE</span>, key.pos <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>We can also display the value of each pixel by using <code>text_values = TRUE</code>. This is also where I am using the <code>pal</code> colour vector I created earlier.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-5_d3517a87a6d3fedac02ca9d4f2a9c1d2">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">r</span>, text_values <span class="op">=</span> <span class="cn">TRUE</span>, col <span class="op">=</span> <span class="va">pal</span>, key.pos <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="sampling-random-locations" class="level2"><h2 class="anchored" data-anchor-id="sampling-random-locations">Sampling random locations</h2>
<p>Using this new raster, let’s randomly sample four points.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-6_7edc31a56ec5f179b50f41cd18932456">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123456</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Random sampling of 4 points</span></span>
<span><span class="va">pts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html">st_sample</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html">st_as_sfc</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize them</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">r</span>, text_values <span class="op">=</span> <span class="cn">TRUE</span>, col <span class="op">=</span> <span class="va">pal</span>, key.pos <span class="op">=</span> <span class="cn">NULL</span>, reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">pts</span>,</span>
<span>  add <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  pch <span class="op">=</span> <span class="fl">21</span>,</span>
<span>  cex <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  bg <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="extracting-raster-values-using-the-sampled-points" class="level2"><h2 class="anchored" data-anchor-id="extracting-raster-values-using-the-sampled-points">Extracting raster values using the sampled points</h2>
<p>Extracting raster values at point locations can be done using the <code><a href="https://r-spatial.github.io/stars/reference/st_extract.html">st_extract()</a></code> function. As expected, four values have been extracted.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-7_ab8a7926e465e24b759a209189706cbf">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pts_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_extract.html">st_extract</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">pts</span><span class="op">)</span></span>
<span><span class="va">pts_values</span></span>
<span><span class="co">#&gt; Simple feature collection with 4 features and 1 field</span></span>
<span><span class="co">#&gt; Geometry type: POINT</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 294167 ymin: 9110827 xmax: 294401 ymax: 9111014</span></span>
<span><span class="co">#&gt; Projected CRS: SIRGAS 2000 / UTM zone 25S</span></span>
<span><span class="co">#&gt;   L7_ETMs.tif                 geometry</span></span>
<span><span class="co">#&gt; 1          71   POINT (294401 9110940)</span></span>
<span><span class="co">#&gt; 2          70 POINT (294378.3 9110871)</span></span>
<span><span class="co">#&gt; 3          72 POINT (294192.5 9111014)</span></span>
<span><span class="co">#&gt; 4          68   POINT (294167 9110827)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="extracting-raster-values-using-buffers-around-the-sampled-points" class="level2"><h2 class="anchored" data-anchor-id="extracting-raster-values-using-buffers-around-the-sampled-points">Extracting raster values using buffers around the sampled points</h2>
<p>I found that extracting raster values using polygons was a bit more tedious (at least at this stage of my understanding of the <code>stars</code> package).</p>
<section id="generate-buffers" class="level3"><h3 class="anchored" data-anchor-id="generate-buffers">Generate buffers</h3>
<p>Let’s generate buffers of 30 meters around each of the four sampled pixels.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-8_29f00a5bdcf12ba9934dfe7c6a5c66e1">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">poly</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="va">pts</span>, dist <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">poly</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "sfc_POLYGON" "sfc"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">r</span>, text_values <span class="op">=</span> <span class="cn">TRUE</span>, col <span class="op">=</span> <span class="va">pal</span>, key.pos <span class="op">=</span> <span class="cn">NULL</span>, reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="va">poly</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, border <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">pts</span>,</span>
<span>  add <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  pch <span class="op">=</span> <span class="fl">21</span>,</span>
<span>  cex <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  bg <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>We can visualize which pixels fall within each buffer. Looking at the next figure, one can ask why there are not always the same number of pixels in each buffer. The reason is that the arc of the circle must pass through the center of each pixel to be included in the buffer.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-9_ef7e3b710e500de30a8f55133de53123">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">r</span><span class="op">[</span><span class="va">poly</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">V1</span><span class="op">)</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"#3c3c3c"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="va">poly</span><span class="op">)</span>, fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pts</span>, color <span class="op">=</span> <span class="st">"red"</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">V1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">paletteer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/paletteer/man/ggplot2-scales-discrete.html">scale_fill_paletteer_d</a></span><span class="op">(</span><span class="st">"RColorBrewer::Pastel2"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"none"</span></span>
<span>  <span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="extracting-pixel-values-covered-by-the-polygons" class="level3"><h3 class="anchored" data-anchor-id="extracting-pixel-values-covered-by-the-polygons">Extracting pixel values covered by the polygons</h3>
<p>Now that we have defined four buffers with a 30 meters radius, we could be tempted to re-use <code><a href="https://r-spatial.github.io/stars/reference/st_extract.html">st_extract()</a></code>.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-10_37a81fbe228a74edd1ba73c24cc7945d">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_extract.html">st_extract</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">poly</span><span class="op">)</span></span>
<span><span class="co">#&gt; stars object with 2 dimensions and 1 attribute</span></span>
<span><span class="co">#&gt; attribute(s):</span></span>
<span><span class="co">#&gt;                  Min.  1st Qu. Median     Mean 3rd Qu. Max.</span></span>
<span><span class="co">#&gt; L7_ETMs.tif  68.33333 69.83333     71 70.95833  72.125 73.5</span></span>
<span><span class="co">#&gt; dimension(s):</span></span>
<span><span class="co">#&gt;          from to offset delta                     refsys point</span></span>
<span><span class="co">#&gt; geometry    1  4     NA    NA SIRGAS 2000 / UTM zone 25S FALSE</span></span>
<span><span class="co">#&gt; band        1  1     NA    NA                         NA    NA</span></span>
<span><span class="co">#&gt;                                                                     values</span></span>
<span><span class="co">#&gt; geometry POLYGON ((294431 9110940, 2...,...,POLYGON ((294197 9110827, 2...</span></span>
<span><span class="co">#&gt; band                                                                  NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Surprisingly, we can not use <code><a href="https://r-spatial.github.io/stars/reference/st_extract.html">st_extract()</a></code> with polygons. One option is to use <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code>. In our example, between three and four pixels are falling under each buffer. This is why we have to tell the <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code> function how to summarize the values within each buffer with the <code>FUN</code> parameter.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-11_03159a035dfeb0cde3835b66689d5345">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Extract the average value per polygon</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">poly</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 4 features and 1 field</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 294137 ymin: 9110797 xmax: 294431 ymax: 9111044</span></span>
<span><span class="co">#&gt; Projected CRS: SIRGAS 2000 / UTM zone 25S</span></span>
<span><span class="co">#&gt;         V1                       geometry</span></span>
<span><span class="co">#&gt; 1 68.33333 POLYGON ((294431 9110940, 2...</span></span>
<span><span class="co">#&gt; 2 70.33333 POLYGON ((294408.3 9110871,...</span></span>
<span><span class="co">#&gt; 3 73.50000 POLYGON ((294222.5 9111014,...</span></span>
<span><span class="co">#&gt; 4 71.66667 POLYGON ((294197 9110827, 2...</span></span>
<span></span>
<span><span class="co"># Extract the minimum value per polygon</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">poly</span>, FUN <span class="op">=</span> <span class="va">min</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 4 features and 1 field</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 294137 ymin: 9110797 xmax: 294431 ymax: 9111044</span></span>
<span><span class="co">#&gt; Projected CRS: SIRGAS 2000 / UTM zone 25S</span></span>
<span><span class="co">#&gt;   V1                       geometry</span></span>
<span><span class="co">#&gt; 1 67 POLYGON ((294431 9110940, 2...</span></span>
<span><span class="co">#&gt; 2 67 POLYGON ((294408.3 9110871,...</span></span>
<span><span class="co">#&gt; 3 72 POLYGON ((294222.5 9111014,...</span></span>
<span><span class="co">#&gt; 4 68 POLYGON ((294197 9110827, 2...</span></span>
<span></span>
<span><span class="co"># Extract the maximum value per polygon</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">poly</span>, FUN <span class="op">=</span> <span class="va">max</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 4 features and 1 field</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 294137 ymin: 9110797 xmax: 294431 ymax: 9111044</span></span>
<span><span class="co">#&gt; Projected CRS: SIRGAS 2000 / UTM zone 25S</span></span>
<span><span class="co">#&gt;   V1                       geometry</span></span>
<span><span class="co">#&gt; 1 71 POLYGON ((294431 9110940, 2...</span></span>
<span><span class="co">#&gt; 2 74 POLYGON ((294408.3 9110871,...</span></span>
<span><span class="co">#&gt; 3 76 POLYGON ((294222.5 9111014,...</span></span>
<span><span class="co">#&gt; 4 75 POLYGON ((294197 9110827, 2...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="overlapping-polygons" class="level3"><h3 class="anchored" data-anchor-id="overlapping-polygons">Overlapping polygons</h3>
<p>The method using the <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code> function is largely based on <a href="https://stackoverflow.com/questions/66283846/how-to-extract-values-from-a-raster-using-polygons-with-the-r-stars-package">an answer I received on stackoverflow</a>. As specified by the user who answered my question, there is one catch.</p>
<blockquote class="blockquote">
<p>Keep in mind that if there is overlap between polygons (unlike in this example) then each raster value is only “counted” once, in the first polygon it falls in (to comply with the ordinary behaviour of aggregate).</p>
</blockquote>
<p>To demonstrate it, we will increase the buffer radius to 90 meters. As seen in the next figure, two buffers are overlapping.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-12_a525146e06b1437b9aa33a8bab4514f5">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create 90 meters radius buffers</span></span>
<span><span class="va">poly</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="va">pts</span>, dist <span class="op">=</span> <span class="fl">90</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">r</span>, text_values <span class="op">=</span> <span class="cn">TRUE</span>, col <span class="op">=</span> <span class="va">pal</span>, key.pos <span class="op">=</span> <span class="cn">NULL</span>, reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op">(</span><span class="va">poly</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, border <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">pts_values</span>,</span>
<span>  add <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  pch <span class="op">=</span> <span class="fl">21</span>,</span>
<span>  cex <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  bg <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>  col <span class="op">=</span> <span class="fu"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Now let’s calculate the average pixel value in each polygon.</p>
<section id="using-the-aggregate-function" class="level4"><h4 class="anchored" data-anchor-id="using-the-aggregate-function">Using the <code>aggregate()</code> function</h4>
<p>As previously done with the smaller polygons, we can also use the <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code> function.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-13_5d7b0eb20cac77ece3cf9c6657674d17">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">averaged_using_aggregate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">poly</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">averaged_using_aggregate</span></span>
<span><span class="co">#&gt; Simple feature collection with 4 features and 1 field</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 294077 ymin: 9110737 xmax: 294491 ymax: 9111104</span></span>
<span><span class="co">#&gt; Projected CRS: SIRGAS 2000 / UTM zone 25S</span></span>
<span><span class="co">#&gt;         V1                       geometry</span></span>
<span><span class="co">#&gt; 1 71.48485 POLYGON ((294491 9110940, 2...</span></span>
<span><span class="co">#&gt; 2 71.40000 POLYGON ((294468.3 9110871,...</span></span>
<span><span class="co">#&gt; 3 71.90625 POLYGON ((294282.5 9111014,...</span></span>
<span><span class="co">#&gt; 4 70.92000 POLYGON ((294257 9110827, 2...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="using-the-st_join-function-manually" class="level4"><h4 class="anchored" data-anchor-id="using-the-st_join-function-manually">Using the <code>st_join()</code> function (manually)</h4>
<p>First, convert the polygons into a <code>sf</code> object and assign a unique id to each polygon.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-14_196d6efbd25040b6c0e4c5a82d4b2506">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">poly_sf</span> <span class="op">&lt;-</span> <span class="va">poly</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html">rowid_to_column</a></span><span class="op">(</span>var <span class="op">=</span> <span class="st">"poly_id"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">poly_sf</span></span>
<span><span class="co">#&gt; Simple feature collection with 4 features and 1 field</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 294077 ymin: 9110737 xmax: 294491 ymax: 9111104</span></span>
<span><span class="co">#&gt; Projected CRS: SIRGAS 2000 / UTM zone 25S</span></span>
<span><span class="co">#&gt;   poly_id                              x</span></span>
<span><span class="co">#&gt; 1       1 POLYGON ((294491 9110940, 2...</span></span>
<span><span class="co">#&gt; 2       2 POLYGON ((294468.3 9110871,...</span></span>
<span><span class="co">#&gt; 3       3 POLYGON ((294282.5 9111014,...</span></span>
<span><span class="co">#&gt; 4       4 POLYGON ((294257 9110827, 2...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Convert the raster into a <code>sf</code> object.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-15_be835d8dca2547c2bb3463e0cad9a903">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">r_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r_sf</span></span>
<span><span class="co">#&gt; Simple feature collection with 270 features and 1 field</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 293991.8 ymin: 9110786 xmax: 294504.8 ymax: 9111213</span></span>
<span><span class="co">#&gt; Projected CRS: SIRGAS 2000 / UTM zone 25S</span></span>
<span><span class="co">#&gt; First 10 features:</span></span>
<span><span class="co">#&gt;    V1                       geometry</span></span>
<span><span class="co">#&gt; 1  87 POLYGON ((293991.8 9111213,...</span></span>
<span><span class="co">#&gt; 2  83 POLYGON ((294020.3 9111213,...</span></span>
<span><span class="co">#&gt; 3  82 POLYGON ((294048.8 9111213,...</span></span>
<span><span class="co">#&gt; 4  76 POLYGON ((294077.3 9111213,...</span></span>
<span><span class="co">#&gt; 5  80 POLYGON ((294105.8 9111213,...</span></span>
<span><span class="co">#&gt; 6  85 POLYGON ((294134.3 9111213,...</span></span>
<span><span class="co">#&gt; 7  83 POLYGON ((294162.8 9111213,...</span></span>
<span><span class="co">#&gt; 8  87 POLYGON ((294191.3 9111213,...</span></span>
<span><span class="co">#&gt; 9  85 POLYGON ((294219.8 9111213,...</span></span>
<span><span class="co">#&gt; 10 79 POLYGON ((294248.3 9111213,...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Join the raster and the polygons together and drop the pixels that were not matched to any buffer.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-16_44a4e48eb5bb59209a448541dd8a61cc">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span><span class="va">r_sf</span>, <span class="va">poly_sf</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="va">poly_id</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now visualize the pixels in each buffer.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-17_69197634ff2d489ee28ffb85279f45f6">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">df_sf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">poly_id</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">NA</span>, color <span class="op">=</span> <span class="st">"black"</span>, size <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">poly_sf</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">V1</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"#3c3c3c"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span></span>
<span>    breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>    values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"red"</span>, <span class="st">"blue"</span>, <span class="st">"yellow"</span>, <span class="st">"green"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">poly_id</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="index_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Finally, we can calculate the average pixel values in each polygon.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-18_d865fd7ef58aa9fbb548b264c86717f8">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">averaged_using_st_join</span> <span class="op">&lt;-</span> <span class="va">df_sf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">poly_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>V1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">V1</span><span class="op">)</span>, n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">averaged_using_st_join</span></span>
<span><span class="co">#&gt; Simple feature collection with 4 features and 3 fields</span></span>
<span><span class="co">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 294048.8 ymin: 9110786 xmax: 294504.8 ymax: 9111128</span></span>
<span><span class="co">#&gt; Projected CRS: SIRGAS 2000 / UTM zone 25S</span></span>
<span><span class="co">#&gt; # A tibble: 4 × 4</span></span>
<span><span class="co">#&gt;   poly_id    V1     n                                                   geometry</span></span>
<span><span class="co">#&gt;     &lt;int&gt; &lt;dbl&gt; &lt;int&gt;                                              &lt;POLYGON [m]&gt;</span></span>
<span><span class="co">#&gt; 1       1  72.8    45 ((294305.3 9110871, 294305.3 9110900, 294305.3 9110928, 2…</span></span>
<span><span class="co">#&gt; 2       2  71.0    42 ((294276.8 9110814, 294276.8 9110843, 294276.8 9110871, 2…</span></span>
<span><span class="co">#&gt; 3       3  71.2    48 ((294077.3 9111014, 294077.3 9111042, 294105.8 9111042, 2…</span></span>
<span><span class="co">#&gt; 4       4  70.7    33 ((294048.8 9110843, 294077.3 9110843, 294077.3 9110871, 2…</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we compare both the <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code> and <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join()</a></code> methods, we can see that there are differences.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-19_d91b438d6292253dedc9924ed67f8f99">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">averaged_using_aggregate</span><span class="op">$</span><span class="va">V1</span></span>
<span><span class="co">#&gt; [1] 71.48485 71.40000 71.90625 70.92000</span></span>
<span><span class="va">averaged_using_st_join</span><span class="op">$</span><span class="va">V1</span></span>
<span><span class="co">#&gt; [1] 72.80000 71.02381 71.22917 70.72727</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>At this time of writing this, I can not find why I am getting different values. Please leave out a comment if you have an idea!</p>


</section></section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script><script src="https://utteranc.es/client.js" repo="pmassicotte/r-blog" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->



</body></html>