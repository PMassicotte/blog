<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Welcome to my blog</title>
<link>https://www.pmassicotte.com/index.html</link>
<atom:link href="https://www.pmassicotte.com/index.xml" rel="self" type="application/rss+xml"/>
<description>Numerical ecologist | Data visualization | R enthousiast</description>
<generator>quarto-1.0.36</generator>
<lastBuildDate>Thu, 28 Apr 2022 04:00:00 GMT</lastBuildDate>
<item>
  <title>Changing spatial resolution of a raster with terra</title>
  <dc:creator>Philippe Massicotte</dc:creator>
  <link>https://www.pmassicotte.com/posts/2022-04-28-changing-spatial-resolution-of-a-raster-with-terra/index.html</link>
  <description><![CDATA[ <p>Lately, I was working on a project and I needed to change the spatial resolution of a GeoTIFF to match that of another one. After looking around, I posted <a href="https://stackoverflow.com/questions/72044284/how-to-change-a-raster-to-a-specific-spatial-resolution/72044772#72044772">a question on Stackoverflow</a>. After experimenting around, I decided to blog about my experience of changing the spatial resolution of GeoTIFF rasters.</p>
<p>In this post, we will explore two ways to change the spatial resolution of a raster:</p>
<ol type="1">
<li>Aggregating/disaggregating pixels.</li>
<li>Resampling pixels from one geometry to another one.</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2022-04-28-changing-spatial-resolution-of-a-raster-with-terra/images/usgs-nSOZqxCIEAs-unsplash.jpg" class="img-fluid figure-img" style="width:75.0%"></p>
<p></p><figcaption class="figure-caption">Shimmering blues and greens accentuate the textures of the Sierra de Velasco Mountains of northern Argentina. The urban area (pinkish circle) near the lower left part of the mountain range is La Rioja, the capital of the province of La Rioja. Follow the foothills to the upper right, where the city of San Fernando del Valle de Catamarca lies near extensive vineyards and fruit-growing areas (blue blocky shapes).</figcaption><p></p>
</figure>
</div>
<center>
Photo by <a href="https://unsplash.com/@usgs?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">USGS</a> on <a href="https://unsplash.com/s/photos/landsat?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a>
</center>
<section id="aggregating-a-raster" class="level2"><h2 class="anchored" data-anchor-id="aggregating-a-raster">Aggregating a raster</h2>
<p>I like to think that aggregating is the process of combining/merging the pixels of a raster and hence <strong>reducing its spatial resolution</strong>. When combining a set of neighbour pixels into a single pixel, one needs to define the statistical summary to be applied to the ensemble of the combined pixel. Such function can be the mean, median, min, maximum or any other function that produces a single numerical value.</p>
<p>Let’s see how aggregation works using the <code>terra</code> R package. First, I will make a function that will be used to quickly display the pixel values of a raster.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">plot_raster</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="kw" style="color: #003B4F;">function</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">{</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r</span>, axes <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span>, legend <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;">as.polygons</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r</span>, dissolve <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span>, trunc <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span>, add <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r</span>, digits <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">}</span></span></code></pre></div>
</div>
<p>For simplicity purposes, I will create a 4 by 4 raster containing values between 1 and 16.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://rspatial.org/terra/">terra</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;"># Create a 4 x 4 matrix</span></span>
<span><span class="va" style="color: #111111;">m</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">:</span><span class="fl" style="color: #AD0000;">16</span>, ncol <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">4</span>, nrow <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;"># Convert the matrix into a raster</span></span>
<span><span class="va" style="color: #111111;">r16</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">m</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">r16</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; class       : SpatRaster </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; dimensions  : 4, 4, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; resolution  : 1, 1  (x, y)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; extent      : 0, 4, 0, 4  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; coord. ref. :  </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; source      : memory </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; name        : lyr.1 </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; min value   :     1 </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; max value   :    16</span></span></code></pre></div>
</div>
<p>Using <code>plot_raster()</code>, we can display the value of each pixel within the raster.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;">plot_raster</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r16</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2022-04-28-changing-spatial-resolution-of-a-raster-with-terra/index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Imagine now that we would like to aggregate the raster <code>r16</code> so it becomes a raster of 2 by 2 (i.e.&nbsp;4 pixels). To achieve this, we can combine pixels 2 by 2 (horizontally and vertically) using the <code><a href="https://rdrr.io/pkg/terra/man/aggregate.html">aggregate()</a></code> function and the argument <code>fact = 2</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co" style="color: #5E5E5E;"># Aggregate the raster using 2 pixels within the horizontal and the vertical directions</span></span>
<span><span class="va" style="color: #111111;">r4</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/terra/man/aggregate.html">aggregate</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r16</span>, fact <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">r4</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; class       : SpatRaster </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; dimensions  : 2, 2, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; resolution  : 2, 2  (x, y)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; extent      : 0, 4, 0, 4  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; coord. ref. :  </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; source      : memory </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; name        : lyr.1 </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; min value   :   3.5 </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; max value   :  13.5</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;">plot_raster</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r4</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2022-04-28-changing-spatial-resolution-of-a-raster-with-terra/index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>What happened is that, by default, the <code><a href="https://rdrr.io/pkg/terra/man/aggregate.html">aggregate()</a></code> function is using the <code><a href="https://rdrr.io/pkg/terra/man/summarize-generics.html">mean()</a></code> function to summarize the pixel values. Hence, the upper left pixel has a value of 3.5 which correspond to the average of 4 pixels <code>(1 + 5 + 2 + 6) / 4 = 3.5</code>. As mentioned previously, one can use any function that returns a single value such as the <code><a href="https://rdrr.io/r/base/Extremes.html">min()</a></code> function.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co" style="color: #5E5E5E;"># Aggregate using the min() function</span></span>
<span><span class="fu" style="color: #4758AB;">plot_raster</span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/terra/man/aggregate.html">aggregate</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r16</span>, fun <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"min"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2022-04-28-changing-spatial-resolution-of-a-raster-with-terra/index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="disaggregating-a-raster" class="level2"><h2 class="anchored" data-anchor-id="disaggregating-a-raster">Disaggregating a raster</h2>
<p>If aggregating is the process of combining pixels, disaggregating is the process of <strong>splitting</strong> pixels into smaller ones. This operation is done with <code><a href="https://rdrr.io/pkg/terra/man/disaggregate.html">disagg()</a></code>. Using the original 4 x 4 <code>r16</code>raster, each pixel will be disaggregated into 16 smaller pixels, once again using the <code>fact</code> argument.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">r256</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/terra/man/disaggregate.html">disagg</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r16</span>, fact <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="va" style="color: #111111;">r256</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; class       : SpatRaster </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; dimensions  : 16, 16, 1  (nrow, ncol, nlyr)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; resolution  : 0.25, 0.25  (x, y)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; extent      : 0, 4, 0, 4  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; coord. ref. :  </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; source      : memory </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; name        : lyr.1 </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; min value   :     1 </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; max value   :    16</span></span></code></pre></div>
</div>
<p>Here, each pixel of the original <code>r16</code> raster is divided into 16 smaller pixels (4 x 4), giving a total of 256 pixels (16 x 16).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;">plot_raster</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r256</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2022-04-28-changing-spatial-resolution-of-a-raster-with-terra/index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="resampling" class="level2"><h2 class="anchored" data-anchor-id="resampling">Resampling</h2>
<p>Resampling is the process of transferring the values from a raster into another raster that does not have the same geometry (i.e.&nbsp;cell size). This is often the case when working with remote-sensing products that are derived from sources with different spatial resolutions. For the following examples, I will use data from Sentinel-2 (10 meters resolution) and Landsat-8 (30 meters resolution). Both scenes are from the same area and <a href="taken%2015%20minutes%20apart">https://www.gisagmaps.com/l8-s2-comparison-and-download/</a>. Raster files can be downloaded on <a href="www.gisagmaps.com">https://www.gisagmaps.com/l8-s2-comparison-and-download/L8_S2_080415_Comparison.zip</a>. Images contain the top of atmosphere (TOA) reflectance and we will use the RGB bands.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">s2</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;">fs</span><span class="fu" style="color: #4758AB;">::</span><span class="fu" style="color: #4758AB;"><a href="https://fs.r-lib.org/reference/dir_ls.html">dir_ls</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"data/L8_S2_080415_Comparison/S2_080415_TOA"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="va" style="color: #111111;">s2</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; class       : SpatRaster </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; dimensions  : 451, 451, 3  (nrow, ncol, nlyr)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; resolution  : 10, 10  (x, y)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; extent      : 282040, 286550, 4564930, 4569440  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; coord. ref. : WGS 84 / UTM zone 17N (EPSG:32617) </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; sources     : S2_B2_10m_080415_TOA.tif  </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;               S2_B3_10m_080415_TOA.tif  </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;               S2_B4_10m_080415_TOA.tif  </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; names       : S2_B2_10m_080415_TOA, S2_B3_10m_080415_TOA, S2_B4_10m_080415_TOA</span></span>
<span></span>
<span><span class="va" style="color: #111111;">l8</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;">fs</span><span class="fu" style="color: #4758AB;">::</span><span class="fu" style="color: #4758AB;"><a href="https://fs.r-lib.org/reference/dir_ls.html">dir_ls</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"data/L8_S2_080415_Comparison/L8_080415_TOA"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="va" style="color: #111111;">l8</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; class       : SpatRaster </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; dimensions  : 150, 150, 3  (nrow, ncol, nlyr)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; resolution  : 30, 30  (x, y)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; extent      : 282045, 286545, 4564935, 4569435  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; coord. ref. : WGS 84 / UTM zone 17N (EPSG:32617) </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; sources     : L8_B2_080415_TOA.tif  </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;               L8_B3_080415_TOA.tif  </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;               L8_B4_080415_TOA.tif  </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; names       : L8_B2_080415_TOA, L8_B3_080415_TOA, L8_B4_080415_TOA</span></span></code></pre></div>
</div>
<p>We can easily see the difference in spatial resolution between the two images.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op" style="color: #5E5E5E;">(</span>mar <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">3</span>, <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span>, oma <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">3</span>, <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/terra/man/plotRGB.html">plotRGB</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">s2</span>, <span class="fl" style="color: #AD0000;">3</span>, <span class="fl" style="color: #AD0000;">2</span>, <span class="fl" style="color: #AD0000;">1</span>, stretch <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"lin"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/graphics/mtext.html">mtext</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Sentinel-2 (10 meters)"</span>, side <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op" style="color: #5E5E5E;">(</span>mar <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">3</span>, <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span>, oma <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">3</span>, <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/terra/man/plotRGB.html">plotRGB</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">l8</span>, <span class="fl" style="color: #AD0000;">3</span>, <span class="fl" style="color: #AD0000;">2</span>, <span class="fl" style="color: #AD0000;">1</span>, stretch <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"lin"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/graphics/mtext.html">mtext</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Landsat-8 (30 meters)"</span>, side <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2022-04-28-changing-spatial-resolution-of-a-raster-with-terra/index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2022-04-28-changing-spatial-resolution-of-a-raster-with-terra/index_files/figure-html/unnamed-chunk-9-2.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Because the two rasters (<code>s2</code> and <code>l8</code>) do not have the same geometry, algebra operations can not be performed.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">l8</span> <span class="op" style="color: #5E5E5E;">-</span> <span class="va" style="color: #111111;">s2</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Error: [-] extents do not match</span></span></code></pre></div>
</div>
<p>Given that the pixel resolution of the Landsat-8 image is exactly a factor of 3 compared to Sentinel-2, one can be tempted to use <code><a href="https://rdrr.io/pkg/terra/man/disaggregate.html">disagg()</a></code> to get the 10 m pixel resolution from the Landsat-8 so it matches the resolution of the Sentinel-2 image.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">l8_10m</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/terra/man/disaggregate.html">disagg</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">l8</span>, fact <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="va" style="color: #111111;">l8_10m</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; class       : SpatRaster </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; dimensions  : 450, 450, 3  (nrow, ncol, nlyr)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; resolution  : 10, 10  (x, y)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; extent      : 282045, 286545, 4564935, 4569435  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; coord. ref. : WGS 84 / UTM zone 17N (EPSG:32617) </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; source      : memory </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; names       : L8_B2_080415_TOA, L8_B3_080415_TOA, L8_B4_080415_TOA </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; min values  :       0.07772131,       0.05887134,       0.03377673 </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; max values  :        0.2687978,        0.3173852,        0.3191263</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/terra/man/dimensions.html">res</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">s2</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; [1] 10 10</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/terra/man/dimensions.html">res</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">l8_10m</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; [1] 10 10</span></span></code></pre></div>
</div>
<p>However, this is still not working because the two rasters do not have the exact extent.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">l8_10m</span> <span class="op" style="color: #5E5E5E;">-</span> <span class="va" style="color: #111111;">s2</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Error: [-] extents do not match</span></span></code></pre></div>
</div>
<p>The solution is to use <code><a href="https://rdrr.io/pkg/terra/man/resample.html">resample()</a></code> to transfer the values of <code>l8</code> into the same geometry of <code>s2</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">l8_resampled</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/terra/man/resample.html">resample</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">l8</span>, <span class="va" style="color: #111111;">s2</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">l8_resampled</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; class       : SpatRaster </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; dimensions  : 451, 451, 3  (nrow, ncol, nlyr)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; resolution  : 10, 10  (x, y)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; extent      : 282040, 286550, 4564930, 4569440  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; coord. ref. : WGS 84 / UTM zone 17N (EPSG:32617) </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; source      : memory </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; names       : L8_B2_080415_TOA, L8_B3_080415_TOA, L8_B4_080415_TOA </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; min values  :       0.07844353,       0.06003592,       0.03450089 </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; max values  :        0.2486627,        0.2781480,        0.2809660</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op" style="color: #5E5E5E;">(</span>mar <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">3</span>, <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span>, oma <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">3</span>, <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/terra/man/plotRGB.html">plotRGB</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">l8_resampled</span>, <span class="fl" style="color: #AD0000;">3</span>, <span class="fl" style="color: #AD0000;">2</span>, <span class="fl" style="color: #AD0000;">1</span>, stretch <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"lin"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/graphics/mtext.html">mtext</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"Landsat-8 (resampled to 10 meters)"</span>, side <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2022-04-28-changing-spatial-resolution-of-a-raster-with-terra/index_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Now, we can perform raster operations.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">l8_resampled</span> <span class="op" style="color: #5E5E5E;">-</span> <span class="va" style="color: #111111;">s2</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; class       : SpatRaster </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; dimensions  : 451, 451, 3  (nrow, ncol, nlyr)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; resolution  : 10, 10  (x, y)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; extent      : 282040, 286550, 4564930, 4569440  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; coord. ref. : WGS 84 / UTM zone 17N (EPSG:32617) </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; source      : memory </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; names       : L8_B2_080415_TOA, L8_B3_080415_TOA, L8_B4_080415_TOA </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; min values  :       -0.2693594,       -0.2698378,       -0.2766064 </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; max values  :        0.1274634,        0.1734840,        0.1898374</span></span></code></pre></div>
</div>
<section id="update-2022-07-30" class="level3"><h3 class="anchored" data-anchor-id="update-2022-07-30">UPDATE: 2022-07-30</h3>
<p><a href="https://twitter.com/mdsumner">Michael Sumner</a> on Twitter pointed out that the same resampling operation could be done using <code><a href="https://rdrr.io/pkg/terra/man/project.html">project()</a></code>.</p>
<blockquote class="twitter-tweet blockquote">
<p lang="en" dir="ltr">
project(l8, s2, method = "") uses the warper, resample() is a subset<br><br>bilinear is default method, gdal calls it -r resample, default there is "near"
</p>
— Michael Sumner (<span class="citation" data-cites="mdsumner">@mdsumner</span>) <a href="https://twitter.com/mdsumner/status/1529101265279795200?ref_src=twsrc%5Etfw">May 24, 2022</a>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>Let’s try resampling <code>l8</code> onto the same grid as <code>s2</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">l8_resampled_project</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/terra/man/project.html">project</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">l8</span>, <span class="va" style="color: #111111;">s2</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">l8_resampled_project</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; class       : SpatRaster </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; dimensions  : 451, 451, 3  (nrow, ncol, nlyr)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; resolution  : 10, 10  (x, y)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; extent      : 282040, 286550, 4564930, 4569440  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; coord. ref. : WGS 84 / UTM zone 17N (EPSG:32617) </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; source      : memory </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; names       : L8_B2_080415_TOA, L8_B3_080415_TOA, L8_B4_080415_TOA </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; min values  :       0.07844353,       0.06003592,       0.03450089 </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; max values  :        0.2486627,        0.2781480,        0.2809660</span></span>
<span><span class="va" style="color: #111111;">l8_resampled</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; class       : SpatRaster </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; dimensions  : 451, 451, 3  (nrow, ncol, nlyr)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; resolution  : 10, 10  (x, y)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; extent      : 282040, 286550, 4564930, 4569440  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; coord. ref. : WGS 84 / UTM zone 17N (EPSG:32617) </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; source      : memory </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; names       : L8_B2_080415_TOA, L8_B3_080415_TOA, L8_B4_080415_TOA </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; min values  :       0.07844353,       0.06003592,       0.03450089 </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; max values  :        0.2486627,        0.2781480,        0.2809660</span></span></code></pre></div>
</div>
<p>Indeed, this is working perfectly fine and we can see that <code>l8_resampled_project</code> is now on the same 10 m by 10 m grid as <code>s2</code>.</p>
<p>Whereas this is working fine, I thought it was worth mentioning that if you <strong>only want to reproject a raster</strong> and not change the dimensions of the grid, one should use the destination CRS rather than the raster itself. Here both <code>l8</code> and <code>s2</code> have the same CRS and hence only reprojecting (i.e.&nbsp;without resampling) will not change the coordinate system.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/terra/man/crs.html">crs</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">l8</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/terra/man/crs.html">crs</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">s2</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
<p>However, let’s do it for demonstration purposes.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/terra/man/project.html">project</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">l8</span>, <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/terra/man/crs.html">crs</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">s2</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; class       : SpatRaster </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; dimensions  : 150, 150, 3  (nrow, ncol, nlyr)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; resolution  : 30, 30  (x, y)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; extent      : 282045, 286545, 4564935, 4569435  (xmin, xmax, ymin, ymax)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; coord. ref. : WGS 84 / UTM zone 17N (EPSG:32617) </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; source      : memory </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; names       : L8_B2_080415_TOA, L8_B3_080415_TOA, L8_B4_080415_TOA </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; min values  :       0.07772131,       0.05887134,       0.03377673 </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; max values  :        0.2687978,        0.3173852,        0.3191263</span></span></code></pre></div>
</div>
<p>As we can see, using <code>project(l8, crs(s2))</code> instead of <code>project(l8, s2)</code> will not change the pixel resolution of the reprojected raster. The reprojected <code>l8</code> raster still has a pixel resolution of 30 m by 30 m.</p>
<details><summary>
Session info
</summary><div class="cell" data-layout-align="center">
<pre><code>#&gt; ─ Session info ───────────────────────────────────────────────────────────────────────────────────────────────────────
#&gt;  setting  value
#&gt;  version  R version 4.2.1 (2022-06-23)
#&gt;  os       Ubuntu 22.04 LTS
#&gt;  system   x86_64, linux-gnu
#&gt;  ui       X11
#&gt;  language en_CA:en
#&gt;  collate  en_CA.UTF-8
#&gt;  ctype    en_CA.UTF-8
#&gt;  tz       America/Toronto
#&gt;  date     2022-07-30
#&gt;  pandoc   2.18 @ /usr/lib/rstudio/bin/quarto/bin/tools/ (via rmarkdown)
#&gt; 
#&gt; ─ Packages ───────────────────────────────────────────────────────────────────────────────────────────────────────────
#&gt;  package     * version date (UTC) lib source
#&gt;  cachem        1.0.6   2021-08-19 [1] RSPM (R 4.2.0)
#&gt;  callr         3.7.1   2022-07-13 [1] RSPM (R 4.2.0)
#&gt;  cli           3.3.0   2022-04-25 [1] RSPM (R 4.2.0)
#&gt;  codetools     0.2-18  2020-11-04 [2] CRAN (R 4.2.1)
#&gt;  crayon        1.5.1   2022-03-26 [1] RSPM (R 4.2.0)
#&gt;  devtools      2.4.4   2022-07-20 [1] RSPM (R 4.2.0)
#&gt;  digest        0.6.29  2021-12-01 [1] RSPM (R 4.2.0)
#&gt;  ellipsis      0.3.2   2021-04-29 [1] RSPM (R 4.2.0)
#&gt;  evaluate      0.15    2022-02-18 [1] RSPM (R 4.2.0)
#&gt;  fastmap       1.1.0   2021-01-25 [1] RSPM (R 4.2.0)
#&gt;  fs            1.5.2   2021-12-08 [1] RSPM (R 4.2.0)
#&gt;  glue          1.6.2   2022-02-24 [1] RSPM (R 4.2.0)
#&gt;  htmltools     0.5.3   2022-07-18 [1] RSPM (R 4.2.0)
#&gt;  htmlwidgets   1.5.4   2021-09-08 [1] RSPM (R 4.2.0)
#&gt;  httpuv        1.6.5   2022-01-05 [1] RSPM (R 4.2.0)
#&gt;  jsonlite      1.8.0   2022-02-22 [1] RSPM (R 4.2.0)
#&gt;  knitr         1.39    2022-04-26 [1] RSPM (R 4.2.0)
#&gt;  later         1.3.0   2021-08-18 [1] CRAN (R 4.2.1)
#&gt;  lifecycle     1.0.1   2021-09-24 [1] RSPM (R 4.2.0)
#&gt;  magrittr      2.0.3   2022-03-30 [1] RSPM (R 4.2.0)
#&gt;  memoise       2.0.1   2021-11-26 [1] RSPM (R 4.2.0)
#&gt;  mime          0.12    2021-09-28 [1] RSPM (R 4.2.0)
#&gt;  miniUI        0.1.1.1 2018-05-18 [1] RSPM (R 4.2.0)
#&gt;  pkgbuild      1.3.1   2021-12-20 [1] RSPM (R 4.2.0)
#&gt;  pkgload       1.3.0   2022-06-27 [1] RSPM (R 4.2.0)
#&gt;  prettyunits   1.1.1   2020-01-24 [1] RSPM (R 4.2.0)
#&gt;  processx      3.7.0   2022-07-07 [1] RSPM (R 4.2.0)
#&gt;  profvis       0.3.7   2020-11-02 [1] RSPM (R 4.2.0)
#&gt;  promises      1.2.0.1 2021-02-11 [1] RSPM (R 4.2.0)
#&gt;  ps            1.7.1   2022-06-18 [1] RSPM (R 4.2.0)
#&gt;  purrr         0.3.4   2020-04-17 [1] RSPM (R 4.2.0)
#&gt;  R6            2.5.1   2021-08-19 [1] RSPM (R 4.2.0)
#&gt;  Rcpp          1.0.9   2022-07-08 [1] RSPM (R 4.2.0)
#&gt;  remotes       2.4.2   2021-11-30 [1] CRAN (R 4.2.1)
#&gt;  rlang         1.0.4   2022-07-12 [1] RSPM (R 4.2.0)
#&gt;  rmarkdown     2.14    2022-04-25 [1] RSPM (R 4.2.0)
#&gt;  rspm          0.1.0.3 2022-07-27 [1] Github (Enchufa2/rspm@ba091ae)
#&gt;  rstudioapi    0.13    2020-11-12 [1] RSPM (R 4.2.0)
#&gt;  sessioninfo   1.2.2   2021-12-06 [1] RSPM (R 4.2.0)
#&gt;  shiny         1.7.2   2022-07-19 [1] RSPM (R 4.2.0)
#&gt;  stringi       1.7.8   2022-07-11 [1] RSPM (R 4.2.0)
#&gt;  stringr       1.4.0   2019-02-10 [1] RSPM (R 4.2.0)
#&gt;  terra       * 1.6-3   2022-07-25 [1] RSPM (R 4.2.0)
#&gt;  urlchecker    1.0.1   2021-11-30 [1] RSPM (R 4.2.0)
#&gt;  usethis       2.1.6   2022-05-25 [1] CRAN (R 4.2.1)
#&gt;  xfun          0.31    2022-05-10 [1] RSPM (R 4.2.0)
#&gt;  xtable        1.8-4   2019-04-21 [1] CRAN (R 4.2.1)
#&gt;  yaml          2.3.5   2022-02-21 [1] RSPM (R 4.2.0)
#&gt; 
#&gt;  [1] /home/filoche/R/x86_64-pc-linux-gnu-library/4.2
#&gt;  [2] /opt/R/4.2.1/lib/R/library
#&gt; 
#&gt; ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
</details>

</section></section> ]]></description>
  <category>R</category>
  <category>geospatial</category>
  <guid>https://www.pmassicotte.com/posts/2022-04-28-changing-spatial-resolution-of-a-raster-with-terra/index.html</guid>
  <pubDate>Thu, 28 Apr 2022 04:00:00 GMT</pubDate>
  <media:content url="https://www.pmassicotte.com/posts/2022-04-28-changing-spatial-resolution-of-a-raster-with-terra/images/usgs-nSOZqxCIEAs-unsplash.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Reading multiples CSV files using readr</title>
  <dc:creator>Philippe Massicotte</dc:creator>
  <link>https://www.pmassicotte.com/posts/2022-02-15-reading-multiples-csv-files-in-r/index.html</link>
  <description><![CDATA[ <p>If you are beginning in R, chances are that you have used <code><a href="https://rdrr.io/r/utils/read.table.html">read.csv()</a></code> to import CSV files into R. While this function works perfectly fine, it can only read one file at a time. Hence, new R programmers often read multiple files successively and combine the data afterward.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-1_1a2104a9eb4b96475162bbc1e9c05ffb">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="co" style="color: #5E5E5E;"># Read all the data files</span></span>
<span><span class="va" style="color: #111111;">df1</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"file1.csv"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="va" style="color: #111111;">df2</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"file2.csv"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="va" style="color: #111111;">df3</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"file3.csv"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="va" style="color: #111111;">df4</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"file4.csv"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="va" style="color: #111111;">df5</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"file5.csv"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;"># Combine all the data frame together</span></span>
<span><span class="va" style="color: #111111;">big_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">df1</span>, <span class="va" style="color: #111111;">df2</span>, <span class="va" style="color: #111111;">df3</span>, <span class="va" style="color: #111111;">df4</span>, <span class="va" style="color: #111111;">df5</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>Whereas this can work fine if you have only a few files, this can become tedious when the number of files to read increases. A better approach would be to use a list of files and read them at once. For quite a while, I have been using a combination of <code>map_df()</code> from the <a href="https://purrr.tidyverse.org/reference/map.html">purrr package</a>.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-2_ba1910c154c6e7a9cf0dd1c8e52d2fb7">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co" style="color: #5E5E5E;"># Create a vector of file names</span></span>
<span><span class="va" style="color: #111111;">files</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"file1.csv"</span>, <span class="st" style="color: #20794D;">"file2.csv"</span>, <span class="st" style="color: #20794D;">"file3.csv"</span>, <span class="st" style="color: #20794D;">"file4.csv"</span>, <span class="st" style="color: #20794D;">"file5.csv"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;"># Read and combine all data files into a single data frame</span></span>
<span><span class="va" style="color: #111111;">big_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;">map_df</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">files</span>, <span class="va" style="color: #111111;">read_csv</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>In the release of <a href="https://www.tidyverse.org/blog/2021/07/readr-2-0-0/">readr 2.0.0</a>, the <code>read_csv()</code> function can directly take a list of files as input, eliminating the need to use the <code>mad_df()</code> function. Hence, we can now read multiples files as follow:</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-3_9da16dee42fa58d4ec837f768106acf8">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co" style="color: #5E5E5E;"># Read and combine all data files into a single data frame without using the</span></span>
<span><span class="co" style="color: #5E5E5E;"># map_df function</span></span>
<span><span class="va" style="color: #111111;">big_df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;">read_csv</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">files</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><a href="https://unsplash.com/photos/-Vqn2WrfxTQ"><img src="https://www.pmassicotte.com/posts/2022-02-15-reading-multiples-csv-files-in-r/images/img_marc_sendra_speed.jpg" class="img-fluid figure-img"></a></p>
<p></p><figcaption class="figure-caption">Lights in the night</figcaption><p></p>
</figure>
</div>
<p>In this short blog post, I wanted to benchmark the speed difference between <code>map_df(files, read_csv)</code> and <code>read_csv(files)</code>. To do it so let’s first <a href="https://www.tidyverse.org/blog/2021/07/readr-2-0-0/">generate some data files</a>.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-4_8614c5f7b6e6aa613a8d9243c1ae04e1">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/hadley/nycflights13">nycflights13</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;">purrr</span><span class="fu" style="color: #4758AB;">::</span><span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/imap.html">iwalk</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/split.html">split</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">flights</span>, <span class="va" style="color: #111111;">flights</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">carrier</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  <span class="op" style="color: #5E5E5E;">~</span> <span class="op" style="color: #5E5E5E;">{</span></span>
<span>    <span class="va" style="color: #111111;">.x</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">carrier</span><span class="op" style="color: #5E5E5E;">[[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">]</span></span>
<span>    <span class="fu" style="color: #4758AB;">data.table</span><span class="fu" style="color: #4758AB;">::</span><span class="fu" style="color: #4758AB;"><a href="https://Rdatatable.gitlab.io/data.table/reference/fwrite.html">fwrite</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.x</span>, <span class="fu" style="color: #4758AB;">glue</span><span class="fu" style="color: #4758AB;">::</span><span class="fu" style="color: #4758AB;"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"/tmp/flights_{.y}.csv"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">}</span></span>
<span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">files</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;">fs</span><span class="fu" style="color: #4758AB;">::</span><span class="fu" style="color: #4758AB;"><a href="https://fs.r-lib.org/reference/dir_ls.html">dir_ls</a></span><span class="op" style="color: #5E5E5E;">(</span>path <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"/tmp"</span>, glob <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"*flights*csv"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="va" style="color: #111111;">files</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; /tmp/flights_9E.csv /tmp/flights_AA.csv /tmp/flights_AS.csv /tmp/flights_B6.csv </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; /tmp/flights_DL.csv /tmp/flights_EV.csv /tmp/flights_F9.csv /tmp/flights_FL.csv </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; /tmp/flights_HA.csv /tmp/flights_MQ.csv /tmp/flights_OO.csv /tmp/flights_UA.csv </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; /tmp/flights_US.csv /tmp/flights_VX.csv /tmp/flights_WN.csv /tmp/flights_YV.csv</span></span></code></pre></div>
</div>
<p>We can look at what the data look like.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-5_9f9389f98464080ec85c1809a243bae0">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;">read_csv</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">files</span><span class="op" style="color: #5E5E5E;">[[</span><span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">]</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; # A tibble: 18,460 × 19</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;     year month   day dep_time sched_de…¹ dep_d…² arr_t…³ sched…⁴ arr_d…⁵ carrier</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;  1  2013     1     1      810        810       0    1048    1037      11       9</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;  2  2013     1     1     1451       1500      -9    1634    1636      -2       9</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;  3  2013     1     1     1452       1455      -3    1637    1639      -2       9</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;  4  2013     1     1     1454       1500      -6    1635    1636      -1       9</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;  5  2013     1     1     1507       1515      -8    1651    1656      -5       9</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;  6  2013     1     1     1530       1530       0    1650    1655      -5       9</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;  7  2013     1     1     1546       1540       6    1753    1748       5       9</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;  8  2013     1     1     1550       1550       0    1844    1831      13       9</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;  9  2013     1     1     1552       1600      -8    1749    1757      -8       9</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 10  2013     1     1     1554       1600      -6    1701    1734     -33       9</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; # … with 18,450 more rows, 9 more variables: flight &lt;dbl&gt;, tailnum &lt;chr&gt;,</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; #   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; #   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;, and abbreviated variable names</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; #   ¹​sched_dep_time, ²​dep_delay, ³​arr_time, ⁴​sched_arr_time, ⁵​arr_delay</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; # ℹ Use `print(n = ...)` to see more rows, and `colnames()` to see all variable names</span></span></code></pre></div>
</div>
<p>Now that data files have been successfully created, we can compare the two reading options.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-6_5a65da08467a665b532ef218db3ffbaa">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">res</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;">microbenchmark</span><span class="fu" style="color: #4758AB;">::</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>  map_df_read_csv <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">map_df</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">files</span>, <span class="va" style="color: #111111;">read_csv</span>, col_types <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">cols</span><span class="op" style="color: #5E5E5E;">(</span>carrier <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">col_character</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  read_csv <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">read_csv</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">files</span>, col_types <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">cols</span><span class="op" style="color: #5E5E5E;">(</span>carrier <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">col_character</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  times <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">100</span></span>
<span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">res</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Unit: milliseconds</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;             expr      min       lq     mean   median       uq      max neval</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;  map_df_read_csv 413.3536 441.4230 480.7377 497.3756 502.5032 521.7361   100</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;         read_csv 148.1041 153.3014 163.3054 156.3136 161.2407 251.3683   100</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;">autoplot</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">res</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2022-02-15-reading-multiples-csv-files-in-r/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Using <code>read_csv()</code> directly seems to be much (~two times) faster than the <code>map_df(files, read_csv)</code> combination.</p>
<details><summary>
Session info
</summary><div class="cell" data-layout-align="center" data-hash="index_cache/html/sessioninfo_507929d96331e7e94eeb3bad9a7b84e2">
<pre><code>#&gt; ─ Session info ───────────────────────────────────────────────────────────────────────────────────────────────────────
#&gt;  setting  value
#&gt;  version  R version 4.2.1 (2022-06-23)
#&gt;  os       Ubuntu 22.04 LTS
#&gt;  system   x86_64, linux-gnu
#&gt;  ui       X11
#&gt;  language en_CA:en
#&gt;  collate  en_CA.UTF-8
#&gt;  ctype    en_CA.UTF-8
#&gt;  tz       America/Toronto
#&gt;  date     2022-07-30
#&gt;  pandoc   2.18 @ /usr/lib/rstudio/bin/quarto/bin/tools/ (via rmarkdown)
#&gt; 
#&gt; ─ Packages ───────────────────────────────────────────────────────────────────────────────────────────────────────────
#&gt;  package        * version date (UTC) lib source
#&gt;  assertthat       0.2.1   2019-03-21 [1] RSPM (R 4.2.0)
#&gt;  backports        1.4.1   2021-12-13 [1] RSPM (R 4.2.0)
#&gt;  bit              4.0.4   2020-08-04 [1] RSPM (R 4.2.0)
#&gt;  bit64            4.0.5   2020-08-30 [1] RSPM (R 4.2.0)
#&gt;  broom            1.0.0   2022-07-01 [1] RSPM (R 4.2.0)
#&gt;  cachem           1.0.6   2021-08-19 [1] RSPM (R 4.2.0)
#&gt;  callr            3.7.1   2022-07-13 [1] RSPM (R 4.2.0)
#&gt;  cellranger       1.1.0   2016-07-27 [1] RSPM (R 4.2.0)
#&gt;  cli              3.3.0   2022-04-25 [1] RSPM (R 4.2.0)
#&gt;  codetools        0.2-18  2020-11-04 [2] CRAN (R 4.2.1)
#&gt;  colorspace       2.0-3   2022-02-21 [1] RSPM (R 4.2.0)
#&gt;  crayon           1.5.1   2022-03-26 [1] RSPM (R 4.2.0)
#&gt;  data.table       1.14.2  2021-09-27 [1] RSPM (R 4.2.0)
#&gt;  DBI              1.1.3   2022-06-18 [1] RSPM (R 4.2.0)
#&gt;  dbplyr           2.2.1   2022-06-27 [1] RSPM (R 4.2.0)
#&gt;  devtools         2.4.4   2022-07-20 [1] RSPM (R 4.2.0)
#&gt;  digest           0.6.29  2021-12-01 [1] RSPM (R 4.2.0)
#&gt;  dplyr          * 1.0.9   2022-04-28 [1] RSPM (R 4.2.0)
#&gt;  ellipsis         0.3.2   2021-04-29 [1] RSPM (R 4.2.0)
#&gt;  evaluate         0.15    2022-02-18 [1] RSPM (R 4.2.0)
#&gt;  extrafont        0.18    2022-04-12 [1] RSPM (R 4.2.0)
#&gt;  extrafontdb      1.0     2012-06-11 [1] RSPM (R 4.2.0)
#&gt;  fansi            1.0.3   2022-03-24 [1] RSPM (R 4.2.0)
#&gt;  farver           2.1.1   2022-07-06 [1] RSPM (R 4.2.0)
#&gt;  fastmap          1.1.0   2021-01-25 [1] RSPM (R 4.2.0)
#&gt;  forcats        * 0.5.1   2021-01-27 [1] RSPM (R 4.2.0)
#&gt;  fs               1.5.2   2021-12-08 [1] RSPM (R 4.2.0)
#&gt;  gargle           1.2.0   2021-07-02 [1] RSPM (R 4.2.0)
#&gt;  generics         0.1.3   2022-07-05 [1] RSPM (R 4.2.0)
#&gt;  ggplot2        * 3.3.6   2022-05-03 [1] RSPM (R 4.2.0)
#&gt;  ggpmthemes     * 0.0.2   2022-07-29 [1] Github (pmassicotte/ggpmthemes@993d61e)
#&gt;  glue             1.6.2   2022-02-24 [1] RSPM (R 4.2.0)
#&gt;  googledrive      2.0.0   2021-07-08 [1] RSPM (R 4.2.0)
#&gt;  googlesheets4    1.0.0   2021-07-21 [1] RSPM (R 4.2.0)
#&gt;  gtable           0.3.0   2019-03-25 [1] RSPM (R 4.2.0)
#&gt;  haven            2.5.0   2022-04-15 [1] RSPM (R 4.2.0)
#&gt;  hms              1.1.1   2021-09-26 [1] RSPM (R 4.2.0)
#&gt;  htmltools        0.5.3   2022-07-18 [1] RSPM (R 4.2.0)
#&gt;  htmlwidgets      1.5.4   2021-09-08 [1] RSPM (R 4.2.0)
#&gt;  httpuv           1.6.5   2022-01-05 [1] RSPM (R 4.2.0)
#&gt;  httr             1.4.3   2022-05-04 [1] RSPM (R 4.2.0)
#&gt;  jsonlite         1.8.0   2022-02-22 [1] RSPM (R 4.2.0)
#&gt;  knitr            1.39    2022-04-26 [1] RSPM (R 4.2.0)
#&gt;  later            1.3.0   2021-08-18 [1] CRAN (R 4.2.1)
#&gt;  lifecycle        1.0.1   2021-09-24 [1] RSPM (R 4.2.0)
#&gt;  lubridate        1.8.0   2021-10-07 [1] RSPM (R 4.2.0)
#&gt;  magrittr         2.0.3   2022-03-30 [1] RSPM (R 4.2.0)
#&gt;  memoise          2.0.1   2021-11-26 [1] RSPM (R 4.2.0)
#&gt;  microbenchmark   1.4.9   2021-11-09 [1] CRAN (R 4.2.1)
#&gt;  mime             0.12    2021-09-28 [1] RSPM (R 4.2.0)
#&gt;  miniUI           0.1.1.1 2018-05-18 [1] RSPM (R 4.2.0)
#&gt;  modelr           0.1.8   2020-05-19 [1] RSPM (R 4.2.0)
#&gt;  munsell          0.5.0   2018-06-12 [1] RSPM (R 4.2.0)
#&gt;  nycflights13   * 1.0.2   2021-04-12 [1] CRAN (R 4.2.1)
#&gt;  pillar           1.8.0   2022-07-18 [1] RSPM (R 4.2.0)
#&gt;  pkgbuild         1.3.1   2021-12-20 [1] RSPM (R 4.2.0)
#&gt;  pkgconfig        2.0.3   2019-09-22 [1] RSPM (R 4.2.0)
#&gt;  pkgload          1.3.0   2022-06-27 [1] RSPM (R 4.2.0)
#&gt;  prettyunits      1.1.1   2020-01-24 [1] RSPM (R 4.2.0)
#&gt;  processx         3.7.0   2022-07-07 [1] RSPM (R 4.2.0)
#&gt;  profvis          0.3.7   2020-11-02 [1] RSPM (R 4.2.0)
#&gt;  promises         1.2.0.1 2021-02-11 [1] RSPM (R 4.2.0)
#&gt;  ps               1.7.1   2022-06-18 [1] RSPM (R 4.2.0)
#&gt;  purrr          * 0.3.4   2020-04-17 [1] RSPM (R 4.2.0)
#&gt;  R6               2.5.1   2021-08-19 [1] RSPM (R 4.2.0)
#&gt;  Rcpp             1.0.9   2022-07-08 [1] RSPM (R 4.2.0)
#&gt;  readr          * 2.1.2   2022-01-30 [1] RSPM (R 4.2.0)
#&gt;  readxl           1.4.0   2022-03-28 [1] RSPM (R 4.2.0)
#&gt;  remotes          2.4.2   2021-11-30 [1] CRAN (R 4.2.1)
#&gt;  reprex           2.0.1   2021-08-05 [1] RSPM (R 4.2.0)
#&gt;  rlang            1.0.4   2022-07-12 [1] RSPM (R 4.2.0)
#&gt;  rmarkdown        2.14    2022-04-25 [1] RSPM (R 4.2.0)
#&gt;  rspm             0.1.0.3 2022-07-27 [1] Github (Enchufa2/rspm@ba091ae)
#&gt;  rstudioapi       0.13    2020-11-12 [1] RSPM (R 4.2.0)
#&gt;  Rttf2pt1         1.3.10  2022-02-07 [1] RSPM (R 4.2.0)
#&gt;  rvest            1.0.2   2021-10-16 [1] RSPM (R 4.2.0)
#&gt;  scales           1.2.0   2022-04-13 [1] RSPM (R 4.2.0)
#&gt;  sessioninfo      1.2.2   2021-12-06 [1] RSPM (R 4.2.0)
#&gt;  shiny            1.7.2   2022-07-19 [1] RSPM (R 4.2.0)
#&gt;  stringi          1.7.8   2022-07-11 [1] RSPM (R 4.2.0)
#&gt;  stringr        * 1.4.0   2019-02-10 [1] RSPM (R 4.2.0)
#&gt;  tibble         * 3.1.8   2022-07-22 [1] RSPM (R 4.2.0)
#&gt;  tidyr          * 1.2.0   2022-02-01 [1] RSPM (R 4.2.0)
#&gt;  tidyselect       1.1.2   2022-02-21 [1] RSPM (R 4.2.0)
#&gt;  tidyverse      * 1.3.2   2022-07-18 [1] RSPM (R 4.2.0)
#&gt;  tzdb             0.3.0   2022-03-28 [1] RSPM (R 4.2.0)
#&gt;  urlchecker       1.0.1   2021-11-30 [1] RSPM (R 4.2.0)
#&gt;  usethis          2.1.6   2022-05-25 [1] CRAN (R 4.2.1)
#&gt;  utf8             1.2.2   2021-07-24 [1] RSPM (R 4.2.0)
#&gt;  vctrs            0.4.1   2022-04-13 [1] RSPM (R 4.2.0)
#&gt;  vroom            1.5.7   2021-11-30 [1] RSPM (R 4.2.0)
#&gt;  withr            2.5.0   2022-03-03 [1] RSPM (R 4.2.0)
#&gt;  xfun             0.31    2022-05-10 [1] RSPM (R 4.2.0)
#&gt;  xml2             1.3.3   2021-11-30 [1] RSPM (R 4.2.0)
#&gt;  xtable           1.8-4   2019-04-21 [1] CRAN (R 4.2.1)
#&gt;  yaml             2.3.5   2022-02-21 [1] RSPM (R 4.2.0)
#&gt; 
#&gt;  [1] /home/filoche/R/x86_64-pc-linux-gnu-library/4.2
#&gt;  [2] /opt/R/4.2.1/lib/R/library
#&gt; 
#&gt; ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
</details>


 ]]></description>
  <category>R</category>
  <category>data manipulation</category>
  <guid>https://www.pmassicotte.com/posts/2022-02-15-reading-multiples-csv-files-in-r/index.html</guid>
  <pubDate>Tue, 15 Feb 2022 05:00:00 GMT</pubDate>
  <media:content url="https://www.pmassicotte.com/posts/2022-02-15-reading-multiples-csv-files-in-r/images/img_marc_sendra_speed.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Choosing the right geographic projection with the crsuggest R package</title>
  <dc:creator>Philippe Massicotte</dc:creator>
  <link>https://www.pmassicotte.com/posts/2021-11-12-choosing-the-right-projection/index.html</link>
  <description><![CDATA[ <p>When creating maps, choosing an appropriate geographical projection is often a difficult task (at least for me). <a href="https://www.geo-projections.com/">There are plenty of projections to choose from</a>, and <a href="https://www.axismaps.com/guide/map-projections">none can be qualified as the best one</a>. It all depends on what you are trying to achieve. Websites like <a href="https://projectionwizard.org/">the projection wizard website</a> offer a playground to experiment with different projections and how they look like depending on where you are looking at on the globe.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2021-11-12-choosing-the-right-projection/world.jpg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">A medieval depiction of the Ecumene (1482, Johannes Schnitzer, engraver), constructed after the coordinates in Ptolemy’s Geography and using his second map projection</figcaption><p></p>
</figure>
</div>
<p><small>Image from: https://en.wikipedia.org/wiki/Map_projection</small></p>
<p>The goal of this blog post is not to go into details and consideration on how to choose <em>a good</em> projection (it is out of my expertise), but rather present a quick overview of the <code>crsuggest</code> <a href="https://github.com/walkerke/crsuggest">R package</a> that can help to find a projection suited for the data to be displayed.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-1_be7a3f9184503893f94598b8bd02d0a0">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/ropenscilabs/rnaturalearth">rnaturalearth</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">crsuggest</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-2_b3f6e48e7af33e31969923392bfec126">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co" style="color: #5E5E5E;"># Download the Greenland shapefile</span></span>
<span><span class="va" style="color: #111111;">map</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/rnaturalearth/man/ne_countries.html">ne_countries</a></span><span class="op" style="color: #5E5E5E;">(</span>country <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"greenland"</span>, returnclass <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"sf"</span>, scale <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"medium"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;"># Looks at the projection</span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">map</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">proj4string</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; [1] "+proj=longlat +ellps=WGS84 +towgs84=0,0,0,0,0,0,0 +no_defs"</span></span></code></pre></div>
</div>
<p>We can see that WGS84 is used as the reference coordinate system. Plotting the shapefile immediately shows that the result is somewhat distorted.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-3_19b343e448d839be19fb83d1358e9463">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">p1</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;">ggplot</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;">geom_sf</span><span class="op" style="color: #5E5E5E;">(</span>data <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">map</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">p1</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2021-11-12-choosing-the-right-projection/index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Time to look at the <code>crsuggest</code> package. The function <code><a href="https://rdrr.io/pkg/crsuggest/man/suggest_crs.html">suggest_crs()</a></code> takes a spatial dataset as inputs (here the <code>map</code> object) and return a list (<em>n = 10</em> by default) of suggested coordinate systems in a <a href="https://tibble.tidyverse.org/">tibble</a>.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-4_5c05f7168eef2ba83d8e92acfc4d326c">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">suggested_crs</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/crsuggest/man/suggest_crs.html">suggest_crs</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">map</span>, limit <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="va" style="color: #111111;">suggested_crs</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; # A tibble: 3 × 6</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;   crs_code crs_name                              crs_t…¹ crs_gcs crs_u…² crs_p…³</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;   &lt;chr&gt;    &lt;chr&gt;                                 &lt;chr&gt;     &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;  </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 1 5922     WGS 84 / EPSG Arctic Regional zone A2 projec…    4326 m       +proj=…</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 2 6054     GR96 / EPSG Arctic zone 3-31          projec…    4747 m       +proj=…</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 3 6051     GR96 / EPSG Arctic zone 2-18          projec…    4747 m       +proj=…</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; # … with abbreviated variable names ¹​crs_type, ²​crs_units, ³​crs_proj4</span></span></code></pre></div>
</div>
<p>Let’s make some plots using the suggested CRS.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-5_85b462b36e1d1a130d7f79f1d561f0dd">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">plot_map</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="kw" style="color: #003B4F;">function</span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">crs</span>, <span class="va" style="color: #111111;">map</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">{</span></span>
<span>  <span class="fu" style="color: #4758AB;">ggplot</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;">geom_sf</span><span class="op" style="color: #5E5E5E;">(</span>data <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">map</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;">coord_sf</span><span class="op" style="color: #5E5E5E;">(</span>crs <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">crs</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>    <span class="fu" style="color: #4758AB;">labs</span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>      title <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"CRS:"</span>, <span class="va" style="color: #111111;">crs</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>    <span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">}</span></span>
<span></span>
<span><span class="va" style="color: #111111;">maps</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">suggested_crs</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">crs_code</span>, <span class="va" style="color: #111111;">plot_map</span>, map <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">map</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>We can see that the projected maps look more accurate than the original map.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-6_da811e26173073438b6bea8582ff97ac">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html">wrap_plots</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">maps</span>, ncol <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">3</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2021-11-12-choosing-the-right-projection/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>This is even more obvious when they are compared side by side.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/compare_crs_b538fdcfc78e514db449b73d8e204166">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">p2</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;">ggplot</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;">geom_sf</span><span class="op" style="color: #5E5E5E;">(</span>data <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">map</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;">coord_sf</span><span class="op" style="color: #5E5E5E;">(</span>crs <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">5922</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">p1</span> <span class="op" style="color: #5E5E5E;">+</span> <span class="va" style="color: #111111;">p2</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2021-11-12-choosing-the-right-projection/index_files/figure-html/compare_crs-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<details><summary>
Session info
</summary><div class="cell" data-layout-align="center" data-hash="index_cache/html/sessioninfo_507929d96331e7e94eeb3bad9a7b84e2">
<pre><code>#&gt; ─ Session info ───────────────────────────────────────────────────────────────────────────────────────────────────────
#&gt;  setting  value
#&gt;  version  R version 4.2.1 (2022-06-23)
#&gt;  os       Ubuntu 22.04 LTS
#&gt;  system   x86_64, linux-gnu
#&gt;  ui       X11
#&gt;  language en_CA:en
#&gt;  collate  en_CA.UTF-8
#&gt;  ctype    en_CA.UTF-8
#&gt;  tz       America/Toronto
#&gt;  date     2022-07-30
#&gt;  pandoc   2.18 @ /usr/lib/rstudio/bin/quarto/bin/tools/ (via rmarkdown)
#&gt; 
#&gt; ─ Packages ───────────────────────────────────────────────────────────────────────────────────────────────────────────
#&gt;  package           * version date (UTC) lib source
#&gt;  assertthat          0.2.1   2019-03-21 [1] RSPM (R 4.2.0)
#&gt;  backports           1.4.1   2021-12-13 [1] RSPM (R 4.2.0)
#&gt;  base64enc           0.1-3   2015-07-28 [1] RSPM (R 4.2.0)
#&gt;  broom               1.0.0   2022-07-01 [1] RSPM (R 4.2.0)
#&gt;  cachem              1.0.6   2021-08-19 [1] RSPM (R 4.2.0)
#&gt;  callr               3.7.1   2022-07-13 [1] RSPM (R 4.2.0)
#&gt;  cellranger          1.1.0   2016-07-27 [1] RSPM (R 4.2.0)
#&gt;  class               7.3-20  2022-01-16 [2] CRAN (R 4.2.1)
#&gt;  classInt            0.4-7   2022-06-10 [1] CRAN (R 4.2.1)
#&gt;  cli                 3.3.0   2022-04-25 [1] RSPM (R 4.2.0)
#&gt;  codetools           0.2-18  2020-11-04 [2] CRAN (R 4.2.1)
#&gt;  colorspace          2.0-3   2022-02-21 [1] RSPM (R 4.2.0)
#&gt;  crayon              1.5.1   2022-03-26 [1] RSPM (R 4.2.0)
#&gt;  crosstalk           1.2.0   2021-11-04 [1] RSPM (R 4.2.0)
#&gt;  crsuggest         * 0.4     2022-07-06 [1] RSPM (R 4.2.0)
#&gt;  DBI                 1.1.3   2022-06-18 [1] RSPM (R 4.2.0)
#&gt;  dbplyr              2.2.1   2022-06-27 [1] RSPM (R 4.2.0)
#&gt;  devtools            2.4.4   2022-07-20 [1] RSPM (R 4.2.0)
#&gt;  digest              0.6.29  2021-12-01 [1] RSPM (R 4.2.0)
#&gt;  dplyr             * 1.0.9   2022-04-28 [1] RSPM (R 4.2.0)
#&gt;  e1071               1.7-11  2022-06-07 [1] CRAN (R 4.2.1)
#&gt;  ellipsis            0.3.2   2021-04-29 [1] RSPM (R 4.2.0)
#&gt;  evaluate            0.15    2022-02-18 [1] RSPM (R 4.2.0)
#&gt;  extrafont           0.18    2022-04-12 [1] RSPM (R 4.2.0)
#&gt;  extrafontdb         1.0     2012-06-11 [1] RSPM (R 4.2.0)
#&gt;  fansi               1.0.3   2022-03-24 [1] RSPM (R 4.2.0)
#&gt;  farver              2.1.1   2022-07-06 [1] RSPM (R 4.2.0)
#&gt;  fastmap             1.1.0   2021-01-25 [1] RSPM (R 4.2.0)
#&gt;  forcats           * 0.5.1   2021-01-27 [1] RSPM (R 4.2.0)
#&gt;  fs                  1.5.2   2021-12-08 [1] RSPM (R 4.2.0)
#&gt;  gargle              1.2.0   2021-07-02 [1] RSPM (R 4.2.0)
#&gt;  generics            0.1.3   2022-07-05 [1] RSPM (R 4.2.0)
#&gt;  ggplot2           * 3.3.6   2022-05-03 [1] RSPM (R 4.2.0)
#&gt;  ggpmthemes        * 0.0.2   2022-07-29 [1] Github (pmassicotte/ggpmthemes@993d61e)
#&gt;  glue                1.6.2   2022-02-24 [1] RSPM (R 4.2.0)
#&gt;  googledrive         2.0.0   2021-07-08 [1] RSPM (R 4.2.0)
#&gt;  googlesheets4       1.0.0   2021-07-21 [1] RSPM (R 4.2.0)
#&gt;  gtable              0.3.0   2019-03-25 [1] RSPM (R 4.2.0)
#&gt;  haven               2.5.0   2022-04-15 [1] RSPM (R 4.2.0)
#&gt;  hms                 1.1.1   2021-09-26 [1] RSPM (R 4.2.0)
#&gt;  htmltools           0.5.3   2022-07-18 [1] RSPM (R 4.2.0)
#&gt;  htmlwidgets         1.5.4   2021-09-08 [1] RSPM (R 4.2.0)
#&gt;  httpuv              1.6.5   2022-01-05 [1] RSPM (R 4.2.0)
#&gt;  httr                1.4.3   2022-05-04 [1] RSPM (R 4.2.0)
#&gt;  jsonlite            1.8.0   2022-02-22 [1] RSPM (R 4.2.0)
#&gt;  KernSmooth          2.23-20 2021-05-03 [2] CRAN (R 4.2.1)
#&gt;  knitr               1.39    2022-04-26 [1] RSPM (R 4.2.0)
#&gt;  later               1.3.0   2021-08-18 [1] CRAN (R 4.2.1)
#&gt;  lattice             0.20-45 2021-09-22 [2] CRAN (R 4.2.1)
#&gt;  leafem              0.2.0   2022-04-16 [1] RSPM (R 4.2.0)
#&gt;  leaflet             2.1.1   2022-03-23 [1] RSPM (R 4.2.0)
#&gt;  lifecycle           1.0.1   2021-09-24 [1] RSPM (R 4.2.0)
#&gt;  lubridate           1.8.0   2021-10-07 [1] RSPM (R 4.2.0)
#&gt;  magrittr            2.0.3   2022-03-30 [1] RSPM (R 4.2.0)
#&gt;  mapview             2.11.0  2022-04-16 [1] RSPM (R 4.2.0)
#&gt;  memoise             2.0.1   2021-11-26 [1] RSPM (R 4.2.0)
#&gt;  mime                0.12    2021-09-28 [1] RSPM (R 4.2.0)
#&gt;  miniUI              0.1.1.1 2018-05-18 [1] RSPM (R 4.2.0)
#&gt;  modelr              0.1.8   2020-05-19 [1] RSPM (R 4.2.0)
#&gt;  munsell             0.5.0   2018-06-12 [1] RSPM (R 4.2.0)
#&gt;  patchwork         * 1.1.1   2020-12-17 [1] RSPM (R 4.2.0)
#&gt;  pillar              1.8.0   2022-07-18 [1] RSPM (R 4.2.0)
#&gt;  pkgbuild            1.3.1   2021-12-20 [1] RSPM (R 4.2.0)
#&gt;  pkgconfig           2.0.3   2019-09-22 [1] RSPM (R 4.2.0)
#&gt;  pkgload             1.3.0   2022-06-27 [1] RSPM (R 4.2.0)
#&gt;  png                 0.1-7   2013-12-03 [1] RSPM (R 4.2.0)
#&gt;  prettyunits         1.1.1   2020-01-24 [1] RSPM (R 4.2.0)
#&gt;  processx            3.7.0   2022-07-07 [1] RSPM (R 4.2.0)
#&gt;  profvis             0.3.7   2020-11-02 [1] RSPM (R 4.2.0)
#&gt;  promises            1.2.0.1 2021-02-11 [1] RSPM (R 4.2.0)
#&gt;  proxy               0.4-27  2022-06-09 [1] CRAN (R 4.2.1)
#&gt;  ps                  1.7.1   2022-06-18 [1] RSPM (R 4.2.0)
#&gt;  purrr             * 0.3.4   2020-04-17 [1] RSPM (R 4.2.0)
#&gt;  R6                  2.5.1   2021-08-19 [1] RSPM (R 4.2.0)
#&gt;  raster              3.5-21  2022-06-27 [1] RSPM (R 4.2.0)
#&gt;  Rcpp                1.0.9   2022-07-08 [1] RSPM (R 4.2.0)
#&gt;  readr             * 2.1.2   2022-01-30 [1] RSPM (R 4.2.0)
#&gt;  readxl              1.4.0   2022-03-28 [1] RSPM (R 4.2.0)
#&gt;  remotes             2.4.2   2021-11-30 [1] CRAN (R 4.2.1)
#&gt;  reprex              2.0.1   2021-08-05 [1] RSPM (R 4.2.0)
#&gt;  rlang               1.0.4   2022-07-12 [1] RSPM (R 4.2.0)
#&gt;  rmarkdown           2.14    2022-04-25 [1] RSPM (R 4.2.0)
#&gt;  rnaturalearth     * 0.1.0   2017-03-21 [1] RSPM (R 4.2.0)
#&gt;  rnaturalearthdata   0.1.0   2017-02-21 [1] RSPM (R 4.2.0)
#&gt;  rspm                0.1.0.3 2022-07-27 [1] Github (Enchufa2/rspm@ba091ae)
#&gt;  rstudioapi          0.13    2020-11-12 [1] RSPM (R 4.2.0)
#&gt;  Rttf2pt1            1.3.10  2022-02-07 [1] RSPM (R 4.2.0)
#&gt;  rvest               1.0.2   2021-10-16 [1] RSPM (R 4.2.0)
#&gt;  s2                  1.1.0   2022-07-18 [1] CRAN (R 4.2.1)
#&gt;  satellite           1.0.4   2021-10-12 [1] RSPM (R 4.2.0)
#&gt;  scales              1.2.0   2022-04-13 [1] RSPM (R 4.2.0)
#&gt;  sessioninfo         1.2.2   2021-12-06 [1] RSPM (R 4.2.0)
#&gt;  sf                * 1.0-8   2022-07-14 [1] RSPM (R 4.2.0)
#&gt;  shiny               1.7.2   2022-07-19 [1] RSPM (R 4.2.0)
#&gt;  sp                  1.5-0   2022-06-05 [1] RSPM (R 4.2.0)
#&gt;  stringi             1.7.8   2022-07-11 [1] RSPM (R 4.2.0)
#&gt;  stringr           * 1.4.0   2019-02-10 [1] RSPM (R 4.2.0)
#&gt;  terra               1.6-3   2022-07-25 [1] RSPM (R 4.2.0)
#&gt;  tibble            * 3.1.8   2022-07-22 [1] RSPM (R 4.2.0)
#&gt;  tidyr             * 1.2.0   2022-02-01 [1] RSPM (R 4.2.0)
#&gt;  tidyselect          1.1.2   2022-02-21 [1] RSPM (R 4.2.0)
#&gt;  tidyverse         * 1.3.2   2022-07-18 [1] RSPM (R 4.2.0)
#&gt;  tzdb                0.3.0   2022-03-28 [1] RSPM (R 4.2.0)
#&gt;  units               0.8-0   2022-02-05 [1] RSPM (R 4.2.0)
#&gt;  urlchecker          1.0.1   2021-11-30 [1] RSPM (R 4.2.0)
#&gt;  usethis             2.1.6   2022-05-25 [1] CRAN (R 4.2.1)
#&gt;  utf8                1.2.2   2021-07-24 [1] RSPM (R 4.2.0)
#&gt;  vctrs               0.4.1   2022-04-13 [1] RSPM (R 4.2.0)
#&gt;  webshot             0.5.3   2022-04-14 [1] CRAN (R 4.2.1)
#&gt;  withr               2.5.0   2022-03-03 [1] RSPM (R 4.2.0)
#&gt;  wk                  0.6.0   2022-01-03 [1] CRAN (R 4.2.1)
#&gt;  xfun                0.31    2022-05-10 [1] RSPM (R 4.2.0)
#&gt;  xml2                1.3.3   2021-11-30 [1] RSPM (R 4.2.0)
#&gt;  xtable              1.8-4   2019-04-21 [1] CRAN (R 4.2.1)
#&gt;  yaml                2.3.5   2022-02-21 [1] RSPM (R 4.2.0)
#&gt; 
#&gt;  [1] /home/filoche/R/x86_64-pc-linux-gnu-library/4.2
#&gt;  [2] /opt/R/4.2.1/lib/R/library
#&gt; 
#&gt; ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
</details>


 ]]></description>
  <category>R</category>
  <category>geospatial</category>
  <guid>https://www.pmassicotte.com/posts/2021-11-12-choosing-the-right-projection/index.html</guid>
  <pubDate>Fri, 12 Nov 2021 05:00:00 GMT</pubDate>
  <media:content url="https://www.pmassicotte.com/posts/2021-11-12-choosing-the-right-projection/world.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Extracting raster values using the stars R package</title>
  <dc:creator>Philippe Massicotte</dc:creator>
  <link>https://www.pmassicotte.com/posts/2021-03-06-extracting-raster-values-using-polygons/index.html</link>
  <description><![CDATA[ <section id="introduction" class="level2"><h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>For a long time, I have been using the <code>raster</code> package to manipulate raster data in R. Slowly, I am trying to work my way out with the <em>new</em> <code>stars</code> package. In this post, I am exploring different ways to extract values from a raster at different geographic locations. For this exercise, I am using a Landsat 7 image that is provided within the <code>stars</code> package. Each pixel has a resolution of 30 meters.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://r-spatial.github.io/stars/">stars</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/PMassicotte/ggpmthemes">ggpmthemes</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/ggpmthemes/man/theme_maven.html">theme_maven</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-2_926a0fcd9a20d228173c386dca529fa2">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co" style="color: #5E5E5E;"># Create a palette for later</span></span>
<span><span class="va" style="color: #111111;">pal</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;">paletteer</span><span class="fu" style="color: #4758AB;">::</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/paletteer/man/paletteer_d.html">paletteer_d</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"RColorBrewer::Pastel2"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;"># Open the tif and extract the 1 band</span></span>
<span><span class="va" style="color: #111111;">tif</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"tif/L7_ETMs.tif"</span>, package <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"stars"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="va" style="color: #111111;">r</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">tif</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">[</span>, , , <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">]</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;"># What are the dimensions?</span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/stars/reference/st_dimensions.html">st_dimensions</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;      from  to  offset delta                     refsys point values x/y</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; x       1 349  288776  28.5 SIRGAS 2000 / UTM zone 25S FALSE   NULL [x]</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; y       1 352 9120761 -28.5 SIRGAS 2000 / UTM zone 25S FALSE   NULL [y]</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; band    1   1      NA    NA                         NA    NA   NULL</span></span></code></pre></div>
</div>
<p>This is what the original image looks like.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-3_02f06a5a1f8f5177ba4339c872a8fe93">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r</span>, key.pos <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2021-03-06-extracting-raster-values-using-polygons/index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>To better visualize the process of subsetting raster values, let’s crop the image so we can see the pixels.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-4_eed097b3483517559b631aa9da8280e9">
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;      xmin      ymin      xmax      ymax </span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;  288776.3 9110728.8  298722.8 9120760.8</span></span>
<span></span>
<span><span class="va" style="color: #111111;">r</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">r</span> <span class="op" style="color: #5E5E5E;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/sf/reference/st_crop.html">st_crop</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    xmin <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">294000</span>,</span>
<span>    xmax <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">294500</span>,</span>
<span>    ymin <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">9110800</span>,</span>
<span>    ymax <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">9111200</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span>, crs <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r</span>, reset <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span>, key.pos <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2021-03-06-extracting-raster-values-using-polygons/index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>We can also display the value of each pixel by using <code>text_values = TRUE</code>. This is also where I am using the <code>pal</code> colour vector I created earlier.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-5_d3517a87a6d3fedac02ca9d4f2a9c1d2">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r</span>, text_values <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>, col <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">pal</span>, key.pos <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2021-03-06-extracting-raster-values-using-polygons/index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="sampling-random-locations" class="level2"><h2 class="anchored" data-anchor-id="sampling-random-locations">Sampling random locations</h2>
<p>Using this new raster, let’s randomly sample four points.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-6_7edc31a56ec5f179b50f41cd18932456">
<div class="sourceCode" id="cb6" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">123456</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;"># Random sampling of 4 points</span></span>
<span><span class="va" style="color: #111111;">pts</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/sf/reference/st_sample.html">st_sample</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html">st_as_sfc</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>, <span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;"># Visualize them</span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r</span>, text_values <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>, col <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">pal</span>, key.pos <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, reset <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>  <span class="va" style="color: #111111;">pts</span>,</span>
<span>  add <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>,</span>
<span>  pch <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">21</span>,</span>
<span>  cex <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span>,</span>
<span>  bg <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"red"</span>, <span class="fl" style="color: #AD0000;">0.5</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  col <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"red"</span>, <span class="fl" style="color: #AD0000;">0.5</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2021-03-06-extracting-raster-values-using-polygons/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="extracting-raster-values-using-the-sampled-points" class="level2"><h2 class="anchored" data-anchor-id="extracting-raster-values-using-the-sampled-points">Extracting raster values using the sampled points</h2>
<p>Extracting raster values at point locations can be done using the <code><a href="https://r-spatial.github.io/stars/reference/st_extract.html">st_extract()</a></code> function. As expected, four values have been extracted.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-7_ab8a7926e465e24b759a209189706cbf">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">pts_values</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/stars/reference/st_extract.html">st_extract</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r</span>, <span class="va" style="color: #111111;">pts</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="va" style="color: #111111;">pts_values</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Simple feature collection with 4 features and 1 field</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Geometry type: POINT</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Dimension:     XY</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Bounding box:  xmin: 294167 ymin: 9110827 xmax: 294401 ymax: 9111014</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Projected CRS: SIRGAS 2000 / UTM zone 25S</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;   L7_ETMs.tif                 geometry</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 1          71   POINT (294401 9110940)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 2          70 POINT (294378.3 9110871)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 3          72 POINT (294192.5 9111014)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 4          68   POINT (294167 9110827)</span></span></code></pre></div>
</div>
</section><section id="extracting-raster-values-using-buffers-around-the-sampled-points" class="level2"><h2 class="anchored" data-anchor-id="extracting-raster-values-using-buffers-around-the-sampled-points">Extracting raster values using buffers around the sampled points</h2>
<p>I found that extracting raster values using polygons was a bit more tedious (at least at this stage of my understanding of the <code>stars</code> package).</p>
<section id="generate-buffers" class="level3"><h3 class="anchored" data-anchor-id="generate-buffers">Generate buffers</h3>
<p>Let’s generate buffers of 30 meters around each of the four sampled pixels.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-8_29f00a5bdcf12ba9934dfe7c6a5c66e1">
<div class="sourceCode" id="cb8" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">poly</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">pts</span>, dist <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">30</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">poly</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; [1] "sfc_POLYGON" "sfc"</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r</span>, text_values <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>, col <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">pal</span>, key.pos <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, reset <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">poly</span><span class="op" style="color: #5E5E5E;">)</span>, add <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>, border <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"red"</span>, lwd <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span>, col <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NA</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>  <span class="va" style="color: #111111;">pts</span>,</span>
<span>  add <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>,</span>
<span>  pch <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">21</span>,</span>
<span>  cex <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span>,</span>
<span>  bg <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"red"</span>, <span class="fl" style="color: #AD0000;">0.5</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  col <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"red"</span>, <span class="fl" style="color: #AD0000;">0.5</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2021-03-06-extracting-raster-values-using-polygons/index_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>We can visualize which pixels fall within each buffer. Looking at the next figure, one can ask why there are not always the same number of pixels in each buffer. The reason is that the arc of the circle must pass through the center of each pixel to be included in the buffer.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-9_ef7e3b710e500de30a8f55133de53123">
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">r</span><span class="op" style="color: #5E5E5E;">[</span><span class="va" style="color: #111111;">poly</span><span class="op" style="color: #5E5E5E;">]</span> <span class="op" style="color: #5E5E5E;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">V1</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span>, color <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"#3c3c3c"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op" style="color: #5E5E5E;">(</span>data <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">poly</span><span class="op" style="color: #5E5E5E;">)</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NA</span>, color <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"blue"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op" style="color: #5E5E5E;">(</span>data <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">pts</span>, color <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"red"</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf_text</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">V1</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;">paletteer</span><span class="fu" style="color: #4758AB;">::</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/paletteer/man/ggplot2-scales-discrete.html">scale_fill_paletteer_d</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"RColorBrewer::Pastel2"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    legend.position <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"none"</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2021-03-06-extracting-raster-values-using-polygons/index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="extracting-pixel-values-covered-by-the-polygons" class="level3"><h3 class="anchored" data-anchor-id="extracting-pixel-values-covered-by-the-polygons">Extracting pixel values covered by the polygons</h3>
<p>Now that we have defined four buffers with a 30 meters radius, we could be tempted to re-use <code><a href="https://r-spatial.github.io/stars/reference/st_extract.html">st_extract()</a></code>.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-10_37a81fbe228a74edd1ba73c24cc7945d">
<div class="sourceCode" id="cb10" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/stars/reference/st_extract.html">st_extract</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r</span>, <span class="va" style="color: #111111;">poly</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; stars object with 2 dimensions and 1 attribute</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; attribute(s):</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;                  Min.  1st Qu. Median     Mean 3rd Qu. Max.</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; L7_ETMs.tif  68.33333 69.83333     71 70.95833  72.125 73.5</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; dimension(s):</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;          from to offset delta                     refsys point</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; geometry    1  4     NA    NA SIRGAS 2000 / UTM zone 25S FALSE</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; band        1  1     NA    NA                         NA    NA</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;                                                                     values</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; geometry POLYGON ((294431 9110940, 2...,...,POLYGON ((294197 9110827, 2...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; band                                                                  NULL</span></span></code></pre></div>
</div>
<p>Surprisingly, we can not use <code><a href="https://r-spatial.github.io/stars/reference/st_extract.html">st_extract()</a></code> with polygons. One option is to use <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code>. In our example, between three and four pixels are falling under each buffer. This is why we have to tell the <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code> function how to summarize the values within each buffer with the <code>FUN</code> parameter.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-11_03159a035dfeb0cde3835b66689d5345">
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co" style="color: #5E5E5E;"># Extract the average value per polygon</span></span>
<span><span class="va" style="color: #111111;">x</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r</span>, <span class="va" style="color: #111111;">poly</span>, FUN <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">mean</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Simple feature collection with 4 features and 1 field</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Dimension:     XY</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Bounding box:  xmin: 294137 ymin: 9110797 xmax: 294431 ymax: 9111044</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Projected CRS: SIRGAS 2000 / UTM zone 25S</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;         V1                       geometry</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 1 68.33333 POLYGON ((294431 9110940, 2...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 2 70.33333 POLYGON ((294408.3 9110871,...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 3 73.50000 POLYGON ((294222.5 9111014,...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 4 71.66667 POLYGON ((294197 9110827, 2...</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;"># Extract the minimum value per polygon</span></span>
<span><span class="va" style="color: #111111;">x</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r</span>, <span class="va" style="color: #111111;">poly</span>, FUN <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">min</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Simple feature collection with 4 features and 1 field</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Dimension:     XY</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Bounding box:  xmin: 294137 ymin: 9110797 xmax: 294431 ymax: 9111044</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Projected CRS: SIRGAS 2000 / UTM zone 25S</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;   V1                       geometry</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 1 67 POLYGON ((294431 9110940, 2...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 2 67 POLYGON ((294408.3 9110871,...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 3 72 POLYGON ((294222.5 9111014,...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 4 68 POLYGON ((294197 9110827, 2...</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;"># Extract the maximum value per polygon</span></span>
<span><span class="va" style="color: #111111;">x</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r</span>, <span class="va" style="color: #111111;">poly</span>, FUN <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">max</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">x</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Simple feature collection with 4 features and 1 field</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Dimension:     XY</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Bounding box:  xmin: 294137 ymin: 9110797 xmax: 294431 ymax: 9111044</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Projected CRS: SIRGAS 2000 / UTM zone 25S</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;   V1                       geometry</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 1 71 POLYGON ((294431 9110940, 2...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 2 74 POLYGON ((294408.3 9110871,...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 3 76 POLYGON ((294222.5 9111014,...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 4 75 POLYGON ((294197 9110827, 2...</span></span></code></pre></div>
</div>
</section><section id="overlapping-polygons" class="level3"><h3 class="anchored" data-anchor-id="overlapping-polygons">Overlapping polygons</h3>
<p>The method using the <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code> function is largely based on <a href="https://stackoverflow.com/questions/66283846/how-to-extract-values-from-a-raster-using-polygons-with-the-r-stars-package">an answer I received on stackoverflow</a>. As specified by the user who answered my question, there is one catch.</p>
<blockquote class="blockquote">
<p>Keep in mind that if there is overlap between polygons (unlike in this example) then each raster value is only “counted” once, in the first polygon it falls in (to comply with the ordinary behaviour of aggregate).</p>
</blockquote>
<p>To demonstrate it, we will increase the buffer radius to 90 meters. As seen in the next figure, two buffers are overlapping.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-12_a525146e06b1437b9aa33a8bab4514f5">
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co" style="color: #5E5E5E;"># Create 90 meters radius buffers</span></span>
<span><span class="va" style="color: #111111;">poly</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">pts</span>, dist <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">90</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r</span>, text_values <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>, col <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">pal</span>, key.pos <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NULL</span>, reset <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/sf/reference/sfc.html">st_sfc</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">poly</span><span class="op" style="color: #5E5E5E;">)</span>, add <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>, border <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"red"</span>, lwd <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span>, col <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NA</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>  <span class="va" style="color: #111111;">pts_values</span>,</span>
<span>  add <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span>,</span>
<span>  pch <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">21</span>,</span>
<span>  cex <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2</span>,</span>
<span>  bg <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"red"</span>, <span class="fl" style="color: #AD0000;">0.5</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  col <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://scales.r-lib.org/reference/alpha.html">alpha</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"red"</span>, <span class="fl" style="color: #AD0000;">0.5</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2021-03-06-extracting-raster-values-using-polygons/index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Now let’s calculate the average pixel value in each polygon.</p>
<section id="using-the-aggregate-function" class="level4"><h4 class="anchored" data-anchor-id="using-the-aggregate-function">Using the <code>aggregate()</code> function</h4>
<p>As previously done with the smaller polygons, we can also use the <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code> function.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-13_5d7b0eb20cac77ece3cf9c6657674d17">
<div class="sourceCode" id="cb13" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">averaged_using_aggregate</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/stats/aggregate.html">aggregate</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r</span>, <span class="va" style="color: #111111;">poly</span>, FUN <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">mean</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">averaged_using_aggregate</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Simple feature collection with 4 features and 1 field</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Dimension:     XY</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Bounding box:  xmin: 294077 ymin: 9110737 xmax: 294491 ymax: 9111104</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Projected CRS: SIRGAS 2000 / UTM zone 25S</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;         V1                       geometry</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 1 71.48485 POLYGON ((294491 9110940, 2...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 2 71.40000 POLYGON ((294468.3 9110871,...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 3 71.90625 POLYGON ((294282.5 9111014,...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 4 70.92000 POLYGON ((294257 9110827, 2...</span></span></code></pre></div>
</div>
</section><section id="using-the-st_join-function-manually" class="level4"><h4 class="anchored" data-anchor-id="using-the-st_join-function-manually">Using the <code>st_join()</code> function (manually)</h4>
<p>First, convert the polygons into a <code>sf</code> object and assign a unique id to each polygon.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-14_196d6efbd25040b6c0e4c5a82d4b2506">
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">poly_sf</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">poly</span> <span class="op" style="color: #5E5E5E;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tibble.tidyverse.org/reference/rownames.html">rowid_to_column</a></span><span class="op" style="color: #5E5E5E;">(</span>var <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"poly_id"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">poly_sf</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Simple feature collection with 4 features and 1 field</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Dimension:     XY</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Bounding box:  xmin: 294077 ymin: 9110737 xmax: 294491 ymax: 9111104</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Projected CRS: SIRGAS 2000 / UTM zone 25S</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;   poly_id                              x</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 1       1 POLYGON ((294491 9110940, 2...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 2       2 POLYGON ((294468.3 9110871,...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 3       3 POLYGON ((294282.5 9111014,...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 4       4 POLYGON ((294257 9110827, 2...</span></span></code></pre></div>
</div>
<p>Convert the raster into a <code>sf</code> object.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-15_be835d8dca2547c2bb3463e0cad9a903">
<div class="sourceCode" id="cb15" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">r_sf</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">r_sf</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Simple feature collection with 270 features and 1 field</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Dimension:     XY</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Bounding box:  xmin: 293991.8 ymin: 9110786 xmax: 294504.8 ymax: 9111213</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Projected CRS: SIRGAS 2000 / UTM zone 25S</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; First 10 features:</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;    V1                       geometry</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 1  87 POLYGON ((293991.8 9111213,...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 2  83 POLYGON ((294020.3 9111213,...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 3  82 POLYGON ((294048.8 9111213,...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 4  76 POLYGON ((294077.3 9111213,...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 5  80 POLYGON ((294105.8 9111213,...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 6  85 POLYGON ((294134.3 9111213,...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 7  83 POLYGON ((294162.8 9111213,...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 8  87 POLYGON ((294191.3 9111213,...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 9  85 POLYGON ((294219.8 9111213,...</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 10 79 POLYGON ((294248.3 9111213,...</span></span></code></pre></div>
</div>
<p>Join the raster and the polygons together and drop the pixels that were not matched to any buffer.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-16_44a4e48eb5bb59209a448541dd8a61cc">
<div class="sourceCode" id="cb16" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">df_sf</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">r_sf</span>, <span class="va" style="color: #111111;">poly_sf</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">poly_id</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>We can now visualize the pixels in each buffer.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-17_69197634ff2d489ee28ffb85279f45f6">
<div class="sourceCode" id="cb17" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">df_sf</span> <span class="op" style="color: #5E5E5E;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>color <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">poly_id</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NA</span>, color <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"black"</span>, size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.25</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op" style="color: #5E5E5E;">(</span>data <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">poly_sf</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">NA</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf_text</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op" style="color: #5E5E5E;">(</span>label <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">V1</span><span class="op" style="color: #5E5E5E;">)</span>, color <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"#3c3c3c"</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    breaks <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fl" style="color: #AD0000;">1</span>, <span class="fl" style="color: #AD0000;">2</span>, <span class="fl" style="color: #AD0000;">3</span>, <span class="fl" style="color: #AD0000;">4</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    values <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"red"</span>, <span class="st" style="color: #20794D;">"blue"</span>, <span class="st" style="color: #20794D;">"yellow"</span>, <span class="st" style="color: #20794D;">"green"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">~</span><span class="va" style="color: #111111;">poly_id</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2021-03-06-extracting-raster-values-using-polygons/index_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Finally, we can calculate the average pixel values in each polygon.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-18_d865fd7ef58aa9fbb548b264c86717f8">
<div class="sourceCode" id="cb18" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">averaged_using_st_join</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">df_sf</span> <span class="op" style="color: #5E5E5E;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">poly_id</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op" style="color: #5E5E5E;">(</span>V1 <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">V1</span><span class="op" style="color: #5E5E5E;">)</span>, n <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span> </span>
<span></span>
<span><span class="va" style="color: #111111;">averaged_using_st_join</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Simple feature collection with 4 features and 3 fields</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Geometry type: POLYGON</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Dimension:     XY</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Bounding box:  xmin: 294048.8 ymin: 9110786 xmax: 294504.8 ymax: 9111128</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; Projected CRS: SIRGAS 2000 / UTM zone 25S</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; # A tibble: 4 × 4</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;   poly_id    V1     n                                                   geometry</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt;     &lt;int&gt; &lt;dbl&gt; &lt;int&gt;                                              &lt;POLYGON [m]&gt;</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 1       1  72.8    45 ((294305.3 9110871, 294305.3 9110900, 294305.3 9110928, 2…</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 2       2  71.0    42 ((294276.8 9110814, 294276.8 9110843, 294276.8 9110871, 2…</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 3       3  71.2    48 ((294077.3 9111014, 294077.3 9111042, 294105.8 9111042, 2…</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; 4       4  70.7    33 ((294048.8 9110843, 294077.3 9110843, 294077.3 9110871, 2…</span></span></code></pre></div>
</div>
<p>If we compare both the <code><a href="https://rdrr.io/r/stats/aggregate.html">aggregate()</a></code> and <code><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join()</a></code> methods, we can see that there are differences.</p>
<div class="cell" data-layout-align="center" data-hash="index_cache/html/unnamed-chunk-19_d91b438d6292253dedc9924ed67f8f99">
<div class="sourceCode" id="cb19" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">averaged_using_aggregate</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">V1</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; [1] 71.48485 71.40000 71.90625 70.92000</span></span>
<span><span class="va" style="color: #111111;">averaged_using_st_join</span><span class="op" style="color: #5E5E5E;">$</span><span class="va" style="color: #111111;">V1</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; [1] 72.80000 71.02381 71.22917 70.72727</span></span></code></pre></div>
</div>
<p>At this time of writing this, I can not find why I am getting different values. Please leave out a comment if you have an idea!</p>


</section></section></section> ]]></description>
  <category>R</category>
  <category>geospatial</category>
  <guid>https://www.pmassicotte.com/posts/2021-03-06-extracting-raster-values-using-polygons/index.html</guid>
  <pubDate>Sat, 06 Mar 2021 05:00:00 GMT</pubDate>
  <media:content url="https://www.pmassicotte.com/posts/2021-03-06-extracting-raster-values-using-polygons/preview.png" medium="image" type="image/png" height="89" width="144"/>
</item>
<item>
  <title>Removing borders around ggplot2 graphs</title>
  <dc:creator>Philippe Massicotte</dc:creator>
  <link>https://www.pmassicotte.com/posts/2019-12-20-removing-borders-around-ggplot2-graphs/index.html</link>
  <description><![CDATA[ <p>Recently I was participating in the <em>30DayMapChallenge</em> where people were invited to make a map based on a different daily theme for one whole month.</p>
<blockquote class="twitter-tweet blockquote">
<p lang="en" dir="ltr">
Announcing <a href="https://twitter.com/hashtag/30DayMapChallenge?src=hash&amp;ref_src=twsrc%5Etfw">#30DayMapChallenge</a> in November 2019! Create a map each day of the month with the following themes 🌍🌎🌏<br><br>No restriction on tools. All maps should be created by you. Doing less than 30 maps is fine. <a href="https://twitter.com/hashtag/gischat?src=hash&amp;ref_src=twsrc%5Etfw">#gischat</a> <a href="https://twitter.com/hashtag/geography?src=hash&amp;ref_src=twsrc%5Etfw">#geography</a> <a href="https://twitter.com/hashtag/cartography?src=hash&amp;ref_src=twsrc%5Etfw">#cartography</a> <a href="https://twitter.com/hashtag/dataviz?src=hash&amp;ref_src=twsrc%5Etfw">#dataviz</a> <a href="https://t.co/6Go4VFWcJB">pic.twitter.com/6Go4VFWcJB</a>
</p>
— Topi Tjukanov (<span class="citation" data-cites="tjukanov">@tjukanov</span>) <a href="https://twitter.com/tjukanov/status/1187713840550744066?ref_src=twsrc%5Etfw">October 25, 2019</a>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>When making a geographical map, or any other visualization where I wanted to use a <em>forced</em> coordinate system), choosing the right aspect ratio to save my graphics has always been challenging. Lately, when participating in the map challenge, <a href="https://cedricscherer.netlify.com/">Cédric Scherer</a> made me realize that I was really struggling with white borders around my plots when it came the time to export them. <strong>He was right!</strong> :smile:</p>
<blockquote class="twitter-tweet blockquote">
<p lang="en" dir="ltr">
One question though: always wondering about your white space, do you not care and avoid to play around with the aspect ratio or is it on purpose?
</p>
— Cédric Scherer (<span class="citation" data-cites="CedScherer">@CedScherer</span>) <a href="https://twitter.com/CedScherer/status/1204062911016112128?ref_src=twsrc%5Etfw">December 9, 2019</a>
</blockquote>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><section id="the-problem-with-choosing-the-right-aspect-ratio" class="level2"><h2 class="anchored" data-anchor-id="the-problem-with-choosing-the-right-aspect-ratio">The problem with choosing the right aspect ratio</h2>
<p>Let’s make a simple map of the USA to illustrate the problem. In a markdown document, the generated graph looks good (i.e.&nbsp;no extra border) because <code>knitr</code> is taking care of this for me (more on that later).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co" style="color: #5E5E5E;"># Load the US shapefile</span></span>
<span><span class="va" style="color: #111111;">states</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;">st_as_sf</span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;">maps</span><span class="fu" style="color: #4758AB;">::</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/maps/man/map.html">map</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"state"</span>, plot <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">FALSE</span>, fill <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">p</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="va" style="color: #111111;">states</span> <span class="op" style="color: #5E5E5E;">%&gt;%</span></span>
<span>  <span class="fu" style="color: #4758AB;">ggplot</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;">geom_sf</span><span class="op" style="color: #5E5E5E;">(</span>size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">0.25</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span> <span class="co" style="color: #5E5E5E;">#&lt;&lt;</span></span>
<span>  <span class="fu" style="color: #4758AB;">coord_sf</span><span class="op" style="color: #5E5E5E;">(</span>crs <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">2163</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">+</span></span>
<span>  <span class="fu" style="color: #4758AB;">theme</span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>    panel.border <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">element_blank</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    axis.text <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">element_blank</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    panel.grid <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">element_blank</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    axis.ticks <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">element_blank</span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    plot.background <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">element_rect</span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"#3c3c3c"</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>    panel.background <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;">element_rect</span><span class="op" style="color: #5E5E5E;">(</span>fill <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">"#3c3c3c"</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span>  <span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">p</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2019-12-20-removing-borders-around-ggplot2-graphs/index_files/figure-html/map_ggplot2-1.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>When it comes time to save my plots, I usually use the PDF format file unless they contain too much point. In that case, I will use the PNG format. When saving a graph in a file, however, it is difficult to find the right aspect ratio when using coordinate system that forces a specified ratio between the physical representation of data units on the axes (ex.: <code>coord_fixed()</code>, <code>geom_sf()</code> or <code>coord_equal()</code>). To visualize the problem, I will save the previous plot using two different aspect ratios and then import them in my document to show you the difficulty of finding the right aspect ratio.</p>
<section id="aspect-ratio-of-74" class="level3"><h3 class="anchored" data-anchor-id="aspect-ratio-of-74">Aspect ratio of 7/4</h3>
<p>Choosing an aspect ratio of 7/4 creates white borders on the sides of the plot.</p>
<div class="cell" data-layout-align="center">

</div>
<p><img src="https://www.pmassicotte.com/posts/2019-12-20-removing-borders-around-ggplot2-graphs/images/fig_border_7_4.png" style="border:2px solid red;" width="800"></p>
</section><section id="aspect-ratio-of-67" class="level3"><h3 class="anchored" data-anchor-id="aspect-ratio-of-67">Aspect ratio of 6/7</h3>
<p>Choosing an aspect ratio of 6/7 creates white borders at the bottom and the top of the plot.</p>
<div class="cell" data-layout-align="center">

</div>
<p><img src="https://www.pmassicotte.com/posts/2019-12-20-removing-borders-around-ggplot2-graphs/images/fig_border_6_7.png" style="border:2px solid red;" width="800"></p>
<p>As it can be seen in the two figures above, there are two large white borders located either on the sides or above/below of the graph. It is because I have used <code>geom_sf()</code> which set automatically the aspect ratio of the plot to respect the chosen geographical coordinate system. Of course, I could play around with trials and errors to find the <em>best</em> <strong>width</strong> and <strong>hight</strong> to use to save my plot.</p>
<p>But wait! <strong>There is a much better way to do it!</strong> :smirk: Actually, I found out there was a hidden gem in <code>knitr</code> that allows cropping (using either <em>pdfcrop</em> or <em>convert</em> functions) to remove borders around an image. In fact, this is the function that is used to automatically remove borders around images when knitting an R Markdown document in R (see the initial plot of this post without borders). The function <code>knitr::plot_crop(x)</code> (where <em>x</em> is the filename of the plot to be cropped) will trim any existing images on your hard drive.</p>
<p>First, let’s create our plot in PDF format and use <code><a href="https://rdrr.io/pkg/knitr/man/plot_crop.html">knitr::plot_crop()</a></code> to remove the borders.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">pdf_file</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">"images/fig_border.pdf"</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;">ggsave</span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>  <span class="va" style="color: #111111;">pdf_file</span>,</span>
<span>  device <span class="op" style="color: #5E5E5E;">=</span> <span class="va" style="color: #111111;">cairo_pdf</span>,</span>
<span>  width <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">5.51</span>,</span>
<span>  height <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">4.68</span></span>
<span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;">knitr</span><span class="fu" style="color: #4758AB;">::</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/knitr/man/plot_crop.html">plot_crop</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">pdf_file</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="co" style="color: #5E5E5E;">#&gt; [1] "images/fig_border.pdf"</span></span></code></pre></div>
</div>
<p>At this point, the borders have been removed from the original PDF. But what if you want to export this PDF into a bitmap image? This can be achieved using a combination of <code><a href="https://docs.ropensci.org/pdftools/reference/pdf_render_page.html">pdftools::pdf_render_page()</a></code> and <code><a href="https://rdrr.io/pkg/png/man/writePNG.html">png::writePNG()</a></code>. <code><a href="https://docs.ropensci.org/pdftools/reference/pdf_render_page.html">pdftools::pdf_render_page()</a></code> will take the filename of a PDF file and render into a raw bitmap array whereas <code><a href="https://rdrr.io/pkg/png/man/writePNG.html">png::writePNG()</a></code> will actually save the bitmap into a file.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">png_file</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="st" style="color: #20794D;">"images/fig_border_cropped.png"</span></span>
<span></span>
<span><span class="va" style="color: #111111;">bitmap</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;">pdftools</span><span class="fu" style="color: #4758AB;">::</span><span class="fu" style="color: #4758AB;"><a href="https://docs.ropensci.org/pdftools/reference/pdf_render_page.html">pdf_render_page</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">pdf_file</span>, dpi <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">600</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="fu" style="color: #4758AB;">png</span><span class="fu" style="color: #4758AB;">::</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/png/man/writePNG.html">writePNG</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">bitmap</span>, <span class="va" style="color: #111111;">png_file</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p><img src="https://www.pmassicotte.com/posts/2019-12-20-removing-borders-around-ggplot2-graphs/images/fig_border_cropped.png" style="border:2px solid red;" width="800"></p>
<p>Bang! No more borders around our plot 👍</p>
<details><summary>
Session info
</summary><div class="cell" data-layout-align="center">
<pre><code>#&gt; ─ Session info ───────────────────────────────────────────────────────────────────────────────────────────────────────
#&gt;  setting  value
#&gt;  version  R version 4.2.1 (2022-06-23)
#&gt;  os       Ubuntu 22.04 LTS
#&gt;  system   x86_64, linux-gnu
#&gt;  ui       X11
#&gt;  language en_CA:en
#&gt;  collate  en_CA.UTF-8
#&gt;  ctype    en_CA.UTF-8
#&gt;  tz       America/Toronto
#&gt;  date     2022-07-30
#&gt;  pandoc   2.18 @ /usr/lib/rstudio/bin/quarto/bin/tools/ (via rmarkdown)
#&gt; 
#&gt; ─ Packages ───────────────────────────────────────────────────────────────────────────────────────────────────────────
#&gt;  package       * version date (UTC) lib source
#&gt;  askpass         1.1     2019-01-13 [1] RSPM (R 4.2.0)
#&gt;  assertthat      0.2.1   2019-03-21 [1] RSPM (R 4.2.0)
#&gt;  backports       1.4.1   2021-12-13 [1] RSPM (R 4.2.0)
#&gt;  broom           1.0.0   2022-07-01 [1] RSPM (R 4.2.0)
#&gt;  cachem          1.0.6   2021-08-19 [1] RSPM (R 4.2.0)
#&gt;  callr           3.7.1   2022-07-13 [1] RSPM (R 4.2.0)
#&gt;  cellranger      1.1.0   2016-07-27 [1] RSPM (R 4.2.0)
#&gt;  class           7.3-20  2022-01-16 [2] CRAN (R 4.2.1)
#&gt;  classInt        0.4-7   2022-06-10 [1] CRAN (R 4.2.1)
#&gt;  cli             3.3.0   2022-04-25 [1] RSPM (R 4.2.0)
#&gt;  colorspace      2.0-3   2022-02-21 [1] RSPM (R 4.2.0)
#&gt;  crayon          1.5.1   2022-03-26 [1] RSPM (R 4.2.0)
#&gt;  DBI             1.1.3   2022-06-18 [1] RSPM (R 4.2.0)
#&gt;  dbplyr          2.2.1   2022-06-27 [1] RSPM (R 4.2.0)
#&gt;  devtools        2.4.4   2022-07-20 [1] RSPM (R 4.2.0)
#&gt;  digest          0.6.29  2021-12-01 [1] RSPM (R 4.2.0)
#&gt;  dplyr         * 1.0.9   2022-04-28 [1] RSPM (R 4.2.0)
#&gt;  e1071           1.7-11  2022-06-07 [1] CRAN (R 4.2.1)
#&gt;  ellipsis        0.3.2   2021-04-29 [1] RSPM (R 4.2.0)
#&gt;  evaluate        0.15    2022-02-18 [1] RSPM (R 4.2.0)
#&gt;  extrafont       0.18    2022-04-12 [1] RSPM (R 4.2.0)
#&gt;  extrafontdb     1.0     2012-06-11 [1] RSPM (R 4.2.0)
#&gt;  fansi           1.0.3   2022-03-24 [1] RSPM (R 4.2.0)
#&gt;  farver          2.1.1   2022-07-06 [1] RSPM (R 4.2.0)
#&gt;  fastmap         1.1.0   2021-01-25 [1] RSPM (R 4.2.0)
#&gt;  forcats       * 0.5.1   2021-01-27 [1] RSPM (R 4.2.0)
#&gt;  fs              1.5.2   2021-12-08 [1] RSPM (R 4.2.0)
#&gt;  gargle          1.2.0   2021-07-02 [1] RSPM (R 4.2.0)
#&gt;  generics        0.1.3   2022-07-05 [1] RSPM (R 4.2.0)
#&gt;  ggplot2       * 3.3.6   2022-05-03 [1] RSPM (R 4.2.0)
#&gt;  ggpmthemes    * 0.0.2   2022-07-29 [1] Github (pmassicotte/ggpmthemes@993d61e)
#&gt;  glue            1.6.2   2022-02-24 [1] RSPM (R 4.2.0)
#&gt;  googledrive     2.0.0   2021-07-08 [1] RSPM (R 4.2.0)
#&gt;  googlesheets4   1.0.0   2021-07-21 [1] RSPM (R 4.2.0)
#&gt;  gtable          0.3.0   2019-03-25 [1] RSPM (R 4.2.0)
#&gt;  haven           2.5.0   2022-04-15 [1] RSPM (R 4.2.0)
#&gt;  hms             1.1.1   2021-09-26 [1] RSPM (R 4.2.0)
#&gt;  htmltools       0.5.3   2022-07-18 [1] RSPM (R 4.2.0)
#&gt;  htmlwidgets     1.5.4   2021-09-08 [1] RSPM (R 4.2.0)
#&gt;  httpuv          1.6.5   2022-01-05 [1] RSPM (R 4.2.0)
#&gt;  httr            1.4.3   2022-05-04 [1] RSPM (R 4.2.0)
#&gt;  jsonlite        1.8.0   2022-02-22 [1] RSPM (R 4.2.0)
#&gt;  KernSmooth      2.23-20 2021-05-03 [2] CRAN (R 4.2.1)
#&gt;  knitr           1.39    2022-04-26 [1] RSPM (R 4.2.0)
#&gt;  later           1.3.0   2021-08-18 [1] CRAN (R 4.2.1)
#&gt;  lifecycle       1.0.1   2021-09-24 [1] RSPM (R 4.2.0)
#&gt;  lubridate       1.8.0   2021-10-07 [1] RSPM (R 4.2.0)
#&gt;  magrittr        2.0.3   2022-03-30 [1] RSPM (R 4.2.0)
#&gt;  maps            3.4.0   2021-09-25 [1] CRAN (R 4.2.1)
#&gt;  memoise         2.0.1   2021-11-26 [1] RSPM (R 4.2.0)
#&gt;  mime            0.12    2021-09-28 [1] RSPM (R 4.2.0)
#&gt;  miniUI          0.1.1.1 2018-05-18 [1] RSPM (R 4.2.0)
#&gt;  modelr          0.1.8   2020-05-19 [1] RSPM (R 4.2.0)
#&gt;  munsell         0.5.0   2018-06-12 [1] RSPM (R 4.2.0)
#&gt;  pdftools        3.3.0   2022-07-07 [1] RSPM (R 4.2.0)
#&gt;  pillar          1.8.0   2022-07-18 [1] RSPM (R 4.2.0)
#&gt;  pkgbuild        1.3.1   2021-12-20 [1] RSPM (R 4.2.0)
#&gt;  pkgconfig       2.0.3   2019-09-22 [1] RSPM (R 4.2.0)
#&gt;  pkgload         1.3.0   2022-06-27 [1] RSPM (R 4.2.0)
#&gt;  png             0.1-7   2013-12-03 [1] RSPM (R 4.2.0)
#&gt;  prettyunits     1.1.1   2020-01-24 [1] RSPM (R 4.2.0)
#&gt;  processx        3.7.0   2022-07-07 [1] RSPM (R 4.2.0)
#&gt;  profvis         0.3.7   2020-11-02 [1] RSPM (R 4.2.0)
#&gt;  promises        1.2.0.1 2021-02-11 [1] RSPM (R 4.2.0)
#&gt;  proxy           0.4-27  2022-06-09 [1] CRAN (R 4.2.1)
#&gt;  ps              1.7.1   2022-06-18 [1] RSPM (R 4.2.0)
#&gt;  purrr         * 0.3.4   2020-04-17 [1] RSPM (R 4.2.0)
#&gt;  qpdf            1.2.0   2022-05-29 [1] CRAN (R 4.2.1)
#&gt;  R6              2.5.1   2021-08-19 [1] RSPM (R 4.2.0)
#&gt;  ragg            1.2.2   2022-02-21 [1] RSPM (R 4.2.0)
#&gt;  Rcpp            1.0.9   2022-07-08 [1] RSPM (R 4.2.0)
#&gt;  readr         * 2.1.2   2022-01-30 [1] RSPM (R 4.2.0)
#&gt;  readxl          1.4.0   2022-03-28 [1] RSPM (R 4.2.0)
#&gt;  remotes         2.4.2   2021-11-30 [1] CRAN (R 4.2.1)
#&gt;  reprex          2.0.1   2021-08-05 [1] RSPM (R 4.2.0)
#&gt;  rlang           1.0.4   2022-07-12 [1] RSPM (R 4.2.0)
#&gt;  rmarkdown       2.14    2022-04-25 [1] RSPM (R 4.2.0)
#&gt;  rspm            0.1.0.3 2022-07-27 [1] Github (Enchufa2/rspm@ba091ae)
#&gt;  rstudioapi      0.13    2020-11-12 [1] RSPM (R 4.2.0)
#&gt;  Rttf2pt1        1.3.10  2022-02-07 [1] RSPM (R 4.2.0)
#&gt;  rvest           1.0.2   2021-10-16 [1] RSPM (R 4.2.0)
#&gt;  s2              1.1.0   2022-07-18 [1] CRAN (R 4.2.1)
#&gt;  scales          1.2.0   2022-04-13 [1] RSPM (R 4.2.0)
#&gt;  sessioninfo     1.2.2   2021-12-06 [1] RSPM (R 4.2.0)
#&gt;  sf            * 1.0-8   2022-07-14 [1] RSPM (R 4.2.0)
#&gt;  shiny           1.7.2   2022-07-19 [1] RSPM (R 4.2.0)
#&gt;  stringi         1.7.8   2022-07-11 [1] RSPM (R 4.2.0)
#&gt;  stringr       * 1.4.0   2019-02-10 [1] RSPM (R 4.2.0)
#&gt;  systemfonts     1.0.4   2022-02-11 [1] CRAN (R 4.2.1)
#&gt;  textshaping     0.3.6   2021-10-13 [1] RSPM (R 4.2.0)
#&gt;  tibble        * 3.1.8   2022-07-22 [1] RSPM (R 4.2.0)
#&gt;  tidyr         * 1.2.0   2022-02-01 [1] RSPM (R 4.2.0)
#&gt;  tidyselect      1.1.2   2022-02-21 [1] RSPM (R 4.2.0)
#&gt;  tidyverse     * 1.3.2   2022-07-18 [1] RSPM (R 4.2.0)
#&gt;  tzdb            0.3.0   2022-03-28 [1] RSPM (R 4.2.0)
#&gt;  units           0.8-0   2022-02-05 [1] RSPM (R 4.2.0)
#&gt;  urlchecker      1.0.1   2021-11-30 [1] RSPM (R 4.2.0)
#&gt;  usethis         2.1.6   2022-05-25 [1] CRAN (R 4.2.1)
#&gt;  utf8            1.2.2   2021-07-24 [1] RSPM (R 4.2.0)
#&gt;  vctrs           0.4.1   2022-04-13 [1] RSPM (R 4.2.0)
#&gt;  withr           2.5.0   2022-03-03 [1] RSPM (R 4.2.0)
#&gt;  wk              0.6.0   2022-01-03 [1] CRAN (R 4.2.1)
#&gt;  xfun            0.31    2022-05-10 [1] RSPM (R 4.2.0)
#&gt;  xml2            1.3.3   2021-11-30 [1] RSPM (R 4.2.0)
#&gt;  xtable          1.8-4   2019-04-21 [1] CRAN (R 4.2.1)
#&gt;  yaml            2.3.5   2022-02-21 [1] RSPM (R 4.2.0)
#&gt; 
#&gt;  [1] /home/filoche/R/x86_64-pc-linux-gnu-library/4.2
#&gt;  [2] /opt/R/4.2.1/lib/R/library
#&gt; 
#&gt; ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
</details>

</section></section> ]]></description>
  <category>R</category>
  <category>ggplot2</category>
  <guid>https://www.pmassicotte.com/posts/2019-12-20-removing-borders-around-ggplot2-graphs/index.html</guid>
  <pubDate>Fri, 20 Dec 2019 05:00:00 GMT</pubDate>
  <media:content url="https://www.pmassicotte.com/posts/2019-12-20-removing-borders-around-ggplot2-graphs/images/fig_border_7_4.png" medium="image" type="image/png" height="82" width="144"/>
</item>
<item>
  <title>Visualizing the decrease of Artic sea ice extent</title>
  <dc:creator>Philippe Massicotte</dc:creator>
  <link>https://www.pmassicotte.com/posts/2019-08-23-visualizing-the-decrease-of-artic-sea-ice-extent/index.html</link>
  <description><![CDATA[ <div class="cell" data-layout-align="center">

</div>
<div class="cell" data-layout-align="center">

</div>
<section id="arctic-sea-ice-extent" class="level2"><h2 class="anchored" data-anchor-id="arctic-sea-ice-extent">Arctic sea ice extent</h2>
<p>It is well known that the Arctic sea ice extent is decreasing at an increasing pace. As stated by the <a href="https://nsidc.org/cryosphere/seaice/characteristics/difference.html">National Snow &amp; Ice Data Center</a>:</p>
<blockquote class="blockquote">
<p>According to scientific measurements, both the thickness and extent of summer sea ice in the Arctic have shown a dramatic decline over the past thirty years. This is consistent with observations of a warming Arctic.</p>
</blockquote>
<p>Thanks to the NSIDC, their data is <a href="ftp://sidads.colorado.edu/DATASETS/NOAA/G02135/">available for download</a>. For this post, I was interested in visualizing these scientific measurements.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2019-08-23-visualizing-the-decrease-of-artic-sea-ice-extent/preview.jpg" class="img-fluid figure-img" alt="Icebirg floating in the Arctic" width="800"></p>
</figure>
</div>
<p>Photo by <a href="https://unsplash.com/@anniespratt?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Annie Spratt</a> on <a href="https://unsplash.com/s/photos/arctic?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></p>
</section><section id="the-data" class="level2"><h2 class="anchored" data-anchor-id="the-data">The data</h2>
<p>The data consist of four variables:</p>
<ul>
<li>
<code>Year</code>, <code>Month</code>, <code>Day</code>: Period of the measurements.</li>
<li>
<code>Extent</code>: Sea ice extent in millions km<sup>2</sup>.</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">

<table class="table" style="margin-left: auto; margin-right: auto;">
<caption>Few observations of the downloaded data.</caption>
 <thead><tr>
<th style="text-align:right;"> Year </th>
   <th style="text-align:right;"> Month </th>
   <th style="text-align:right;"> Day </th>
   <th style="text-align:right;"> Extent </th>
  </tr></thead>
<tbody>
<tr>
<td style="text-align:right;"> 1978 </td>
   <td style="text-align:right;"> 10 </td>
   <td style="text-align:right;"> 26 </td>
   <td style="text-align:right;"> 10.231 </td>
  </tr>
<tr>
<td style="text-align:right;"> 1978 </td>
   <td style="text-align:right;"> 10 </td>
   <td style="text-align:right;"> 28 </td>
   <td style="text-align:right;"> 10.420 </td>
  </tr>
<tr>
<td style="text-align:right;"> 1978 </td>
   <td style="text-align:right;"> 10 </td>
   <td style="text-align:right;"> 30 </td>
   <td style="text-align:right;"> 10.557 </td>
  </tr>
<tr>
<td style="text-align:right;"> 1978 </td>
   <td style="text-align:right;"> 11 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 10.670 </td>
  </tr>
<tr>
<td style="text-align:right;"> 1978 </td>
   <td style="text-align:right;"> 11 </td>
   <td style="text-align:right;"> 3 </td>
   <td style="text-align:right;"> 10.777 </td>
  </tr>
<tr>
<td style="text-align:right;"> 1978 </td>
   <td style="text-align:right;"> 11 </td>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:right;"> 10.968 </td>
  </tr>
<tr>
<td style="text-align:right;"> 1978 </td>
   <td style="text-align:right;"> 11 </td>
   <td style="text-align:right;"> 7 </td>
   <td style="text-align:right;"> 11.080 </td>
  </tr>
<tr>
<td style="text-align:right;"> 1978 </td>
   <td style="text-align:right;"> 11 </td>
   <td style="text-align:right;"> 9 </td>
   <td style="text-align:right;"> 11.189 </td>
  </tr>
<tr>
<td style="text-align:right;"> 1978 </td>
   <td style="text-align:right;"> 11 </td>
   <td style="text-align:right;"> 11 </td>
   <td style="text-align:right;"> 11.314 </td>
  </tr>
<tr>
<td style="text-align:right;"> 1978 </td>
   <td style="text-align:right;"> 11 </td>
   <td style="text-align:right;"> 13 </td>
   <td style="text-align:right;"> 11.460 </td>
  </tr>
</tbody>
</table>
</div>
</div>
</section><section id="temporal-evolution-of-the-arctic-sea-ice-extent" class="level2"><h2 class="anchored" data-anchor-id="temporal-evolution-of-the-arctic-sea-ice-extent">Temporal evolution of the Arctic sea ice extent</h2>
<p>For the following visualization, I calculated the average and the standard deviation of sea ice extent for each month and each year.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2019-08-23-visualizing-the-decrease-of-artic-sea-ice-extent/index_files/figure-html/unnamed-chunk-3-1.svg" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="rate-of-change-of-the-arctic-sea-ice-extent" class="level2"><h2 class="anchored" data-anchor-id="rate-of-change-of-the-arctic-sea-ice-extent">Rate of change of the Arctic sea ice extent</h2>
<p>The previous graph has shown that Arctic sea ice is undoubtedly decreasing for the past few decades. But at which rate is it decreasing? Is the decreasing rate the same for all the months? The average decreasing rate of sea ice extent can be calculated by using the slope of a linear regression between <code>year</code> and <code>sea ice extent</code>.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2019-08-23-visualizing-the-decrease-of-artic-sea-ice-extent/index_files/figure-html/unnamed-chunk-4-1.svg" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Now, we can visualize the yearly average sea ice extent decrease for each month.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2019-08-23-visualizing-the-decrease-of-artic-sea-ice-extent/index_files/figure-html/unnamed-chunk-5-1.svg" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Another way of visualizing the decrease in sea ice extent consists of using heat maps. In the following graphs, the minimum and maximum sea ice extent for each combination of month/year are presented. The graphs show that both the minimum and maximum sea ice extent are decreasing over time, which is more striking for the September month.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="https://www.pmassicotte.com/posts/2019-08-23-visualizing-the-decrease-of-artic-sea-ice-extent/index_files/figure-html/unnamed-chunk-6-1.svg" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>


</section> ]]></description>
  <category>R</category>
  <guid>https://www.pmassicotte.com/posts/2019-08-23-visualizing-the-decrease-of-artic-sea-ice-extent/index.html</guid>
  <pubDate>Fri, 23 Aug 2019 04:00:00 GMT</pubDate>
  <media:content url="https://www.pmassicotte.com/posts/2019-08-23-visualizing-the-decrease-of-artic-sea-ice-extent/preview.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Trying the new R vroom Package</title>
  <dc:creator>Philippe Massicotte</dc:creator>
  <link>https://www.pmassicotte.com/posts/2019-07-17-trying-the-vroom-package/index.html</link>
  <description><![CDATA[ <p>Many R packages can be used to read plain rectangular data files. Among them, <code>readr</code> and <code>data.table</code> are quite popular options. Recently, the <a href="https://github.com/r-lib/vroom">vroom</a> package have been published on CRAN by <a href="https://twitter.com/jimhester_?lang=en">Jim Hester</a>. While I do not know much about the technology behind the scene, Jim says:</p>
<blockquote class="blockquote">
<p>But that’s impossible! How can it be so fast?</p>
<p>vroom doesn’t stop to actually read all of your data, it simply indexes where each record is located so it can be read later. The vectors returned use the Altrep framework to lazily load the data on-demand when it is accessed, so you only pay for what you use. This lazy access is done automatically, so no changes to your R data-manipulation code are needed.</p>
</blockquote>
<p>Because I often have to read large data files, I decided to try this new promising package.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-1_28aad3e26197ca1951385496904bd93b">
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://vroom.r-lib.org">vroom</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://r-datatable.com">data.table</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/PMassicotte/ggpmthemes">ggpmthemes</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/ggpmthemes/man/theme_poppins.html">theme_poppins</a></span><span class="op" style="color: #5E5E5E;">(</span>base_size <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">14</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
</div>
<p>In the next sections, I will compare several methods to read a plain CSV file. The file I will be using contains bike commute data from <a href="https://www.capitalbikeshare.com/system-data">capital bike share</a>. The file contains roughly 170 000 observations and 9 variables.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-2_ac174870f192daf7a24d85570c347001">
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">file</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;">curl</span><span class="fu" style="color: #4758AB;">::</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/curl/man/curl_download.html">curl_download</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="st" style="color: #20794D;">"https://s3.amazonaws.com/capitalbikeshare-data/201801-capitalbikeshare-tripdata.zip"</span>, destfile <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op" style="color: #5E5E5E;">(</span>fileext <span class="op" style="color: #5E5E5E;">=</span> <span class="st" style="color: #20794D;">".zip"</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="va" style="color: #111111;">file</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/utils/unzip.html">unzip</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">file</span>, exdir <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">file</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 168590 Columns: 9
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (4): Start station, End station, Bike number, Member type
dbl  (3): Duration, Start station number, End station number
dttm (2): Start date, End date

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 168,590 × 9
   Duration `Start date`        `End date`          Start stat…¹ Start…² End s…³
      &lt;dbl&gt; &lt;dttm&gt;              &lt;dttm&gt;                     &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt;
 1      552 2018-01-01 00:05:06 2018-01-01 00:14:18        31104 Adams …   31400
 2     1282 2018-01-01 00:14:30 2018-01-01 00:35:53        31321 15th S…   31321
 3     1265 2018-01-01 00:14:53 2018-01-01 00:35:58        31321 15th S…   31321
 4      578 2018-01-01 00:15:31 2018-01-01 00:25:09        31406 14th &amp;…   31103
 5      372 2018-01-01 00:18:02 2018-01-01 00:24:15        31618 4th &amp; …   31619
 6      369 2018-01-01 00:18:07 2018-01-01 00:24:17        31618 4th &amp; …   31619
 7      486 2018-01-01 00:19:07 2018-01-01 00:27:14        31042 Market…   31098
 8     1615 2018-01-01 00:21:55 2018-01-01 00:48:50        31042 Market…   31045
 9     1598 2018-01-01 00:22:02 2018-01-01 00:48:41        31042 Market…   31045
10      483 2018-01-01 00:22:10 2018-01-01 00:30:14        31115 Columb…   31509
# … with 168,580 more rows, 3 more variables: `End station` &lt;chr&gt;,
#   `Bike number` &lt;chr&gt;, `Member type` &lt;chr&gt;, and abbreviated variable names
#   ¹​`Start station number`, ²​`Start station`, ³​`End station number`
# ℹ Use `print(n = ...)` to see more rows, and `colnames()` to see all variable names</code></pre>
</div>
</div>
<p>Because the <code><a href="https://vroom.r-lib.org/reference/vroom.html">vroom()</a></code> function can use a vector of files, I will duplicate <code>file</code> 10 times.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-3_0f4507b27bb657e8d75dffffc749f28a">
<div class="sourceCode" id="cb5" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">files</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">file</span>, <span class="fl" style="color: #AD0000;">10</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span><span class="va" style="color: #111111;">files</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "/tmp/RtmpMRMqo4/201801_capitalbikeshare_tripdata.csv"
 [2] "/tmp/RtmpMRMqo4/201801_capitalbikeshare_tripdata.csv"
 [3] "/tmp/RtmpMRMqo4/201801_capitalbikeshare_tripdata.csv"
 [4] "/tmp/RtmpMRMqo4/201801_capitalbikeshare_tripdata.csv"
 [5] "/tmp/RtmpMRMqo4/201801_capitalbikeshare_tripdata.csv"
 [6] "/tmp/RtmpMRMqo4/201801_capitalbikeshare_tripdata.csv"
 [7] "/tmp/RtmpMRMqo4/201801_capitalbikeshare_tripdata.csv"
 [8] "/tmp/RtmpMRMqo4/201801_capitalbikeshare_tripdata.csv"
 [9] "/tmp/RtmpMRMqo4/201801_capitalbikeshare_tripdata.csv"
[10] "/tmp/RtmpMRMqo4/201801_capitalbikeshare_tripdata.csv"</code></pre>
</div>
</div>
<p>I can now simply use this character vector with <code><a href="https://vroom.r-lib.org/reference/vroom.html">vroom()</a></code>. Note that I can also use the <code>.name_repair</code> argument to clean column names.</p>
<div class="cell" data-hash="index_cache/html/unnamed-chunk-4_a270ca4ce0a5bab12323e65af8cb9056">
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">df</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;"><a href="https://vroom.r-lib.org/reference/vroom.html">vroom</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">files</span>, .name_repair <span class="op" style="color: #5E5E5E;">=</span> <span class="op" style="color: #5E5E5E;">~</span><span class="fu" style="color: #4758AB;">janitor</span><span class="fu" style="color: #4758AB;">::</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/janitor/man/make_clean_names.html">make_clean_names</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">.</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 1685900 Columns: 9
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (4): start_station, end_station, bike_number, member_type
dbl  (3): duration, start_station_number, end_station_number
dttm (2): start_date, end_date

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode" id="cb9" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">df</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,685,900 × 9
   duration start_date          end_date            start_stat…¹ start…² end_s…³
      &lt;dbl&gt; &lt;dttm&gt;              &lt;dttm&gt;                     &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt;
 1      552 2018-01-01 00:05:06 2018-01-01 00:14:18        31104 Adams …   31400
 2     1282 2018-01-01 00:14:30 2018-01-01 00:35:53        31321 15th S…   31321
 3     1265 2018-01-01 00:14:53 2018-01-01 00:35:58        31321 15th S…   31321
 4      578 2018-01-01 00:15:31 2018-01-01 00:25:09        31406 14th &amp;…   31103
 5      372 2018-01-01 00:18:02 2018-01-01 00:24:15        31618 4th &amp; …   31619
 6      369 2018-01-01 00:18:07 2018-01-01 00:24:17        31618 4th &amp; …   31619
 7      486 2018-01-01 00:19:07 2018-01-01 00:27:14        31042 Market…   31098
 8     1615 2018-01-01 00:21:55 2018-01-01 00:48:50        31042 Market…   31045
 9     1598 2018-01-01 00:22:02 2018-01-01 00:48:41        31042 Market…   31045
10      483 2018-01-01 00:22:10 2018-01-01 00:30:14        31115 Columb…   31509
# … with 1,685,890 more rows, 3 more variables: end_station &lt;chr&gt;,
#   bike_number &lt;chr&gt;, member_type &lt;chr&gt;, and abbreviated variable names
#   ¹​start_station_number, ²​start_station, ³​end_station_number
# ℹ Use `print(n = ...)` to see more rows, and `colnames()` to see all variable names</code></pre>
</div>
</div>
<section id="benchmark" class="level2"><h2 class="anchored" data-anchor-id="benchmark">Benchmark</h2>
<p>One advantage of <code>vroom</code> is its speed. In what follows, I will compare different methods to read the <code>files</code> vector that contains 10 files. I will also use the <code>furrr</code> package to use map in parallel.</p>
<div class="cell" data-hash="index_cache/html/benchmark1_aa01c313121467d00496cef3f70d452e">
<div class="sourceCode" id="cb11" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw" style="color: #003B4F;"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;"><a href="https://github.com/DavisVaughan/furrr">furrr</a></span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="co" style="color: #5E5E5E;"># How many cores to use</span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="fu" style="color: #4758AB;"><a href="https://future.futureverse.org/reference/multiprocess.html">multiprocess</a></span><span class="op" style="color: #5E5E5E;">(</span>workers <span class="op" style="color: #5E5E5E;">=</span> <span class="fu" style="color: #4758AB;"><a href="https://parallelly.futureverse.org/reference/availableCores.html">availableCores</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="op" style="color: #5E5E5E;">)</span> <span class="op" style="color: #5E5E5E;">-</span> <span class="fl" style="color: #AD0000;">1</span><span class="op" style="color: #5E5E5E;">)</span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="va" style="color: #111111;">res</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;">microbenchmark</span><span class="fu" style="color: #4758AB;">::</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://vroom.r-lib.org/reference/vroom.html">vroom</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">files</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map.html">map_df</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">files</span>, <span class="va" style="color: #111111;">read_csv</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://purrr.tidyverse.org/reference/map.html">map_df</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">files</span>, <span class="va" style="color: #111111;">fread</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://furrr.futureverse.org/reference/future_map.html">future_map_dfr</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">files</span>, <span class="va" style="color: #111111;">vroom</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://furrr.futureverse.org/reference/future_map.html">future_map_dfr</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">files</span>, <span class="va" style="color: #111111;">read_csv</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://furrr.futureverse.org/reference/future_map.html">future_map_dfr</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">files</span>, <span class="va" style="color: #111111;">fread</span><span class="op" style="color: #5E5E5E;">)</span>, </span>
<span>  times <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">10</span></span>
<span><span class="op" style="color: #5E5E5E;">)</span></span>
<span></span>
<span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">res</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.pmassicotte.com/posts/2019-07-17-trying-the-vroom-package/index_files/figure-html/benchmark1-1.svg" class="img-fluid" width="672"></p>
</div>
</div>
<p>As we can see, the <code>vroom</code> package is the winner. It is even considerably faster than the versions using map in parallel, which surprises me! Please leave a message below if you have an explanation.</p>
</section><section id="using-altrep" class="level2"><h2 class="anchored" data-anchor-id="using-altrep">Using Altrep</h2>
<p>Another feature of the <code><a href="https://vroom.r-lib.org/reference/vroom.html">vroom()</a></code> function is that we can decide which column types are using Altrep. Setting <code>altrep_opts = TRUE</code> will enable Altrep for all column types. As seen below, this increases further the speed of the <code><a href="https://vroom.r-lib.org/reference/vroom.html">vroom()</a></code> function.</p>
<div class="cell" data-hash="index_cache/html/benchmark2_b179fb7ce8decd1d744d83e63085895c">
<div class="sourceCode" id="cb12" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va" style="color: #111111;">res</span> <span class="op" style="color: #5E5E5E;">&lt;-</span> <span class="fu" style="color: #4758AB;">microbenchmark</span><span class="fu" style="color: #4758AB;">::</span><span class="fu" style="color: #4758AB;"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html">microbenchmark</a></span><span class="op" style="color: #5E5E5E;">(</span></span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://vroom.r-lib.org/reference/vroom.html">vroom</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">files</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  <span class="fu" style="color: #4758AB;"><a href="https://vroom.r-lib.org/reference/vroom.html">vroom</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">files</span>, altrep_opts <span class="op" style="color: #5E5E5E;">=</span> <span class="cn" style="color: #8f5902;">TRUE</span><span class="op" style="color: #5E5E5E;">)</span>,</span>
<span>  times <span class="op" style="color: #5E5E5E;">=</span> <span class="fl" style="color: #AD0000;">10</span></span>
<span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The `altrep_opts` argument of `vroom()` is deprecated as of vroom 1.1.0.
Please use the `altrep` argument instead.
This warning is displayed once every 8 hours.
Call `lifecycle::last_lifecycle_warnings()` to see where this warning was generated.</code></pre>
</div>
<div class="sourceCode" id="cb14" style="background: #f1f3f5;"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu" style="color: #4758AB;"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op" style="color: #5E5E5E;">(</span><span class="va" style="color: #111111;">res</span><span class="op" style="color: #5E5E5E;">)</span></span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.pmassicotte.com/posts/2019-07-17-trying-the-vroom-package/index_files/figure-html/benchmark2-1.svg" class="img-fluid" width="672"></p>
</div>
</div>
<p>Based on these results, I think that <code>vroom</code> will become part of my daily workflow from now on.</p>


</section> ]]></description>
  <category>R</category>
  <category>packages</category>
  <guid>https://www.pmassicotte.com/posts/2019-07-17-trying-the-vroom-package/index.html</guid>
  <pubDate>Wed, 17 Jul 2019 04:00:00 GMT</pubDate>
</item>
</channel>
</rss>
