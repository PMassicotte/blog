{"title":"Changing spatial resolution of a raster with terra","markdown":{"yaml":{"title":" Changing spatial resolution of a raster with terra","author":"Philippe Massicotte","date":"2022-04-28","categories":["R","Geospatial"],"image":"img/preview.png"},"headingText":"Aggregating a raster","containsRefs":false,"markdown":"\n\nLately, I was working on a project and I needed to change the spatial resolution of a GeoTIFF to match that of another one. After looking around, I posted [a question on Stackoverflow](https://stackoverflow.com/questions/72044284/how-to-change-a-raster-to-a-specific-spatial-resolution/72044772#72044772). After experimenting around, I decided to blog about my experience of changing the spatial resolution of GeoTIFF rasters.\n\nIn this post, we will explore two ways to change the spatial resolution of a raster:\n\n1. Aggregating/disaggregating pixels.\n2. Resampling pixels from one geometry to another one.\n\n![Shimmering blues and greens accentuate the textures of the Sierra de Velasco Mountains of northern Argentina. The urban area (pinkish circle) near the lower left part of the mountain range is La Rioja, the capital of the province of La Rioja. Follow the foothills to the upper right, where the city of San Fernando del Valle de Catamarca lies near extensive vineyards and fruit-growing areas (blue blocky shapes).](img/preview.png){width=75%}\n<center>Photo by <a href=\"https://unsplash.com/@usgs?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText\">USGS</a> on <a href=\"https://unsplash.com/s/photos/landsat?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText\">Unsplash</a></center>\n\n\nI like to think that aggregating is the process of combining/merging the pixels of a raster and hence **reducing its spatial resolution**. When combining a set of neighbour pixels into a single pixel, one needs to define the statistical summary to be applied to the ensemble of the combined pixel. Such function can be the mean, median, min, maximum or any other function that produces a single numerical value.\n\nLet's see how aggregation works using the `terra` R package. First, I will make a function that will be used to quickly display the pixel values of a raster.\n\n```{r}\nplot_raster <- function(r) {\n  plot(r, axes = FALSE, legend = FALSE)\n  plot(as.polygons(r, dissolve = FALSE, trunc = FALSE), add = TRUE)\n  text(r, digits = 2)\n}\n```\n\nFor simplicity purposes, I will create a 4 by 4 raster containing values between 1 and 16.\n\n```{r}\nlibrary(terra)\n\n# Create a 4 x 4 matrix\nm <- matrix(1:16, ncol = 4, nrow = 4)\n\n# Convert the matrix into a raster\nr16 <- rast(m)\n\nr16\n```\n\nUsing `plot_raster()`, we can display the value of each pixel within the raster. \n\n```{r}\nplot_raster(r16)\n```\n\nImagine now that we would like to aggregate the raster `r16` so it becomes a raster of 2 by 2 (i.e. 4 pixels). To achieve this, we can combine pixels 2 by 2 (horizontally and vertically) using the `aggregate()` function and the argument `fact = 2`.\n\n```{r}\n# Aggregate the raster using 2 pixels within the horizontal and the vertical directions\nr4 <- aggregate(r16, fact = 2)\n\nr4\n\nplot_raster(r4)\n```\n\nWhat happened is that, by default, the `aggregate()` function is using the `mean()` function to summarize the pixel values. Hence, the upper left pixel has a value of 3.5 which correspond to the average of 4 pixels `(1 + 5 + 2 + 6) / 4 = 3.5`. As mentioned previously, one can use any function that returns a single value such as the `min()` function. \n\n```{r}\n# Aggregate using the min() function\nplot_raster(aggregate(r16, fun = \"min\"))\n```\n\n## Disaggregating a raster\n\nIf aggregating is the process of combining pixels, disaggregating is the process of **splitting** pixels into smaller ones. This operation is done with `disagg()`. Using the original 4 x 4 `r16`raster, each pixel will be disaggregated into 16 smaller pixels, once again using the `fact` argument.\n\n```{r}\nr256 <- disagg(r16, fact = 4)\nr256\n```\n\nHere, each pixel of the original `r16` raster is divided into 16 smaller pixels (4 x 4), giving a total of 256 pixels (16 x 16).\n\n```{r}\nplot_raster(r256)\n```\n\n## Resampling\n\nResampling is the process of transferring the values from a raster into another raster that does not have the same geometry (i.e. cell size). This is often the case when working with remote-sensing products that are derived from sources with different spatial resolutions. For the following examples, I will use data from Sentinel-2 (10 meters resolution) and Landsat-8 (30 meters resolution). Both scenes are from the same area and [https://www.gisagmaps.com/l8-s2-comparison-and-download/](taken 15 minutes apart). Raster files can be downloaded on [https://www.gisagmaps.com/l8-s2-comparison-and-download/L8_S2_080415_Comparison.zip](www.gisagmaps.com). Images contain the top of atmosphere (TOA) reflectance and we will use the RGB bands.\n\n\n```{r}\ns2 <- rast(fs::dir_ls(\"data/L8_S2_080415_Comparison/S2_080415_TOA\"))\ns2\n\nl8 <- rast(fs::dir_ls(\"data/L8_S2_080415_Comparison/L8_080415_TOA\"))\nl8\n```\n\nWe can easily see the difference in spatial resolution between the two images.\n\n```{r}\npar(mar = c(1, 1, 3, 1), oma = c(1, 1, 3, 1))\nplotRGB(s2, 3, 2, 1, stretch = \"lin\")\nmtext(\"Sentinel-2 (10 meters)\", side = 3)\n\npar(mar = c(1, 1, 3, 1), oma = c(1, 1, 3, 1))\nplotRGB(l8, 3, 2, 1, stretch = \"lin\")\nmtext(\"Landsat-8 (30 meters)\", side = 3)\n```\n\nBecause the two rasters (`s2` and `l8`) do not have the same geometry, algebra operations can not be performed.\n\n```{r, error=TRUE}\nl8 - s2\n```\n\nGiven that the pixel resolution of the Landsat-8 image is exactly a factor of 3 compared to Sentinel-2, one can be tempted to use `disagg()` to get the 10 m pixel resolution from the Landsat-8 so it matches the resolution of the Sentinel-2 image.\n\n```{r, error = TRUE}\nl8_10m <- disagg(l8, fact = 3)\nl8_10m\n\nres(s2)\n\nres(l8_10m)\n```\n\nHowever, this is still not working because the two rasters do not have the exact extent.\n\n```{r, error = TRUE}\nl8_10m - s2\n```\n\nThe solution is to use `resample()` to transfer the values of `l8` into the same geometry of `s2`.\n\n```{r}\nl8_resampled <- resample(l8, s2)\n\nl8_resampled\n\npar(mar = c(1, 1, 3, 1), oma = c(1, 1, 3, 1))\nplotRGB(l8_resampled, 3, 2, 1, stretch = \"lin\")\nmtext(\"Landsat-8 (resampled to 10 meters)\", side = 3)\n```\n\nNow, we can perform raster operations.\n\n```{r}\nl8_resampled - s2\n```\n\n### UPDATE:  `r Sys.Date()`\n\n[Michael Sumner](https://twitter.com/mdsumner) on Twitter pointed out that the same resampling operation could be done using `project()`.\n\n<blockquote class=\"twitter-tweet\"><p lang=\"en\" dir=\"ltr\">project(l8, s2, method = &quot;&quot;) uses the warper, resample() is a subset<br><br>bilinear is default method, gdal calls it -r resample, default there is &quot;near&quot;</p>&mdash; Michael Sumner (@mdsumner) <a href=\"https://twitter.com/mdsumner/status/1529101265279795200?ref_src=twsrc%5Etfw\">May 24, 2022</a></blockquote> <script async src=\"https://platform.twitter.com/widgets.js\" charset=\"utf-8\"></script> \n\nLet's try resampling `l8` onto the same grid as `s2`.\n\n```{r}\nl8_resampled_project <- project(l8, s2)\n\nl8_resampled_project\nl8_resampled\n```\n\nIndeed, this is working perfectly fine and we can see that `l8_resampled_project` is now on the same 10 m by 10 m grid as `s2`.\n\nWhereas this is working fine, I thought it was worth mentioning that if you **only want to reproject a raster** and not change the dimensions of the grid, one should use the destination CRS rather than the raster itself. Here both `l8` and `s2` have the same CRS and hence only reprojecting (i.e. without resampling) will not change the coordinate system.\n\n```{r}\nidentical(crs(l8), crs(s2))\n```\n\nHowever, let's do it for demonstration purposes.\n\n```{r}\nproject(l8, crs(s2))\n```\n\nAs we can see, using `project(l8, crs(s2))` instead of `project(l8, s2)` will not change the pixel resolution of the reprojected raster. The reprojected `l8` raster still has a pixel resolution of 30 m by 30 m.\n\n<details>\n  \n<summary>Session info</summary>\n\n```{r sessioninfo, echo = FALSE}\n## Reproducibility info\noptions(width = 120)\ndevtools::session_info()\n```\n\n</details>\n","srcMarkdownNoYaml":"\n\nLately, I was working on a project and I needed to change the spatial resolution of a GeoTIFF to match that of another one. After looking around, I posted [a question on Stackoverflow](https://stackoverflow.com/questions/72044284/how-to-change-a-raster-to-a-specific-spatial-resolution/72044772#72044772). After experimenting around, I decided to blog about my experience of changing the spatial resolution of GeoTIFF rasters.\n\nIn this post, we will explore two ways to change the spatial resolution of a raster:\n\n1. Aggregating/disaggregating pixels.\n2. Resampling pixels from one geometry to another one.\n\n![Shimmering blues and greens accentuate the textures of the Sierra de Velasco Mountains of northern Argentina. The urban area (pinkish circle) near the lower left part of the mountain range is La Rioja, the capital of the province of La Rioja. Follow the foothills to the upper right, where the city of San Fernando del Valle de Catamarca lies near extensive vineyards and fruit-growing areas (blue blocky shapes).](img/preview.png){width=75%}\n<center>Photo by <a href=\"https://unsplash.com/@usgs?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText\">USGS</a> on <a href=\"https://unsplash.com/s/photos/landsat?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText\">Unsplash</a></center>\n\n## Aggregating a raster\n\nI like to think that aggregating is the process of combining/merging the pixels of a raster and hence **reducing its spatial resolution**. When combining a set of neighbour pixels into a single pixel, one needs to define the statistical summary to be applied to the ensemble of the combined pixel. Such function can be the mean, median, min, maximum or any other function that produces a single numerical value.\n\nLet's see how aggregation works using the `terra` R package. First, I will make a function that will be used to quickly display the pixel values of a raster.\n\n```{r}\nplot_raster <- function(r) {\n  plot(r, axes = FALSE, legend = FALSE)\n  plot(as.polygons(r, dissolve = FALSE, trunc = FALSE), add = TRUE)\n  text(r, digits = 2)\n}\n```\n\nFor simplicity purposes, I will create a 4 by 4 raster containing values between 1 and 16.\n\n```{r}\nlibrary(terra)\n\n# Create a 4 x 4 matrix\nm <- matrix(1:16, ncol = 4, nrow = 4)\n\n# Convert the matrix into a raster\nr16 <- rast(m)\n\nr16\n```\n\nUsing `plot_raster()`, we can display the value of each pixel within the raster. \n\n```{r}\nplot_raster(r16)\n```\n\nImagine now that we would like to aggregate the raster `r16` so it becomes a raster of 2 by 2 (i.e. 4 pixels). To achieve this, we can combine pixels 2 by 2 (horizontally and vertically) using the `aggregate()` function and the argument `fact = 2`.\n\n```{r}\n# Aggregate the raster using 2 pixels within the horizontal and the vertical directions\nr4 <- aggregate(r16, fact = 2)\n\nr4\n\nplot_raster(r4)\n```\n\nWhat happened is that, by default, the `aggregate()` function is using the `mean()` function to summarize the pixel values. Hence, the upper left pixel has a value of 3.5 which correspond to the average of 4 pixels `(1 + 5 + 2 + 6) / 4 = 3.5`. As mentioned previously, one can use any function that returns a single value such as the `min()` function. \n\n```{r}\n# Aggregate using the min() function\nplot_raster(aggregate(r16, fun = \"min\"))\n```\n\n## Disaggregating a raster\n\nIf aggregating is the process of combining pixels, disaggregating is the process of **splitting** pixels into smaller ones. This operation is done with `disagg()`. Using the original 4 x 4 `r16`raster, each pixel will be disaggregated into 16 smaller pixels, once again using the `fact` argument.\n\n```{r}\nr256 <- disagg(r16, fact = 4)\nr256\n```\n\nHere, each pixel of the original `r16` raster is divided into 16 smaller pixels (4 x 4), giving a total of 256 pixels (16 x 16).\n\n```{r}\nplot_raster(r256)\n```\n\n## Resampling\n\nResampling is the process of transferring the values from a raster into another raster that does not have the same geometry (i.e. cell size). This is often the case when working with remote-sensing products that are derived from sources with different spatial resolutions. For the following examples, I will use data from Sentinel-2 (10 meters resolution) and Landsat-8 (30 meters resolution). Both scenes are from the same area and [https://www.gisagmaps.com/l8-s2-comparison-and-download/](taken 15 minutes apart). Raster files can be downloaded on [https://www.gisagmaps.com/l8-s2-comparison-and-download/L8_S2_080415_Comparison.zip](www.gisagmaps.com). Images contain the top of atmosphere (TOA) reflectance and we will use the RGB bands.\n\n\n```{r}\ns2 <- rast(fs::dir_ls(\"data/L8_S2_080415_Comparison/S2_080415_TOA\"))\ns2\n\nl8 <- rast(fs::dir_ls(\"data/L8_S2_080415_Comparison/L8_080415_TOA\"))\nl8\n```\n\nWe can easily see the difference in spatial resolution between the two images.\n\n```{r}\npar(mar = c(1, 1, 3, 1), oma = c(1, 1, 3, 1))\nplotRGB(s2, 3, 2, 1, stretch = \"lin\")\nmtext(\"Sentinel-2 (10 meters)\", side = 3)\n\npar(mar = c(1, 1, 3, 1), oma = c(1, 1, 3, 1))\nplotRGB(l8, 3, 2, 1, stretch = \"lin\")\nmtext(\"Landsat-8 (30 meters)\", side = 3)\n```\n\nBecause the two rasters (`s2` and `l8`) do not have the same geometry, algebra operations can not be performed.\n\n```{r, error=TRUE}\nl8 - s2\n```\n\nGiven that the pixel resolution of the Landsat-8 image is exactly a factor of 3 compared to Sentinel-2, one can be tempted to use `disagg()` to get the 10 m pixel resolution from the Landsat-8 so it matches the resolution of the Sentinel-2 image.\n\n```{r, error = TRUE}\nl8_10m <- disagg(l8, fact = 3)\nl8_10m\n\nres(s2)\n\nres(l8_10m)\n```\n\nHowever, this is still not working because the two rasters do not have the exact extent.\n\n```{r, error = TRUE}\nl8_10m - s2\n```\n\nThe solution is to use `resample()` to transfer the values of `l8` into the same geometry of `s2`.\n\n```{r}\nl8_resampled <- resample(l8, s2)\n\nl8_resampled\n\npar(mar = c(1, 1, 3, 1), oma = c(1, 1, 3, 1))\nplotRGB(l8_resampled, 3, 2, 1, stretch = \"lin\")\nmtext(\"Landsat-8 (resampled to 10 meters)\", side = 3)\n```\n\nNow, we can perform raster operations.\n\n```{r}\nl8_resampled - s2\n```\n\n### UPDATE:  `r Sys.Date()`\n\n[Michael Sumner](https://twitter.com/mdsumner) on Twitter pointed out that the same resampling operation could be done using `project()`.\n\n<blockquote class=\"twitter-tweet\"><p lang=\"en\" dir=\"ltr\">project(l8, s2, method = &quot;&quot;) uses the warper, resample() is a subset<br><br>bilinear is default method, gdal calls it -r resample, default there is &quot;near&quot;</p>&mdash; Michael Sumner (@mdsumner) <a href=\"https://twitter.com/mdsumner/status/1529101265279795200?ref_src=twsrc%5Etfw\">May 24, 2022</a></blockquote> <script async src=\"https://platform.twitter.com/widgets.js\" charset=\"utf-8\"></script> \n\nLet's try resampling `l8` onto the same grid as `s2`.\n\n```{r}\nl8_resampled_project <- project(l8, s2)\n\nl8_resampled_project\nl8_resampled\n```\n\nIndeed, this is working perfectly fine and we can see that `l8_resampled_project` is now on the same 10 m by 10 m grid as `s2`.\n\nWhereas this is working fine, I thought it was worth mentioning that if you **only want to reproject a raster** and not change the dimensions of the grid, one should use the destination CRS rather than the raster itself. Here both `l8` and `s2` have the same CRS and hence only reprojecting (i.e. without resampling) will not change the coordinate system.\n\n```{r}\nidentical(crs(l8), crs(s2))\n```\n\nHowever, let's do it for demonstration purposes.\n\n```{r}\nproject(l8, crs(s2))\n```\n\nAs we can see, using `project(l8, crs(s2))` instead of `project(l8, s2)` will not change the pixel resolution of the reprojected raster. The reprojected `l8` raster still has a pixel resolution of 30 m by 30 m.\n\n<details>\n  \n<summary>Session info</summary>\n\n```{r sessioninfo, echo = FALSE}\n## Reproducibility info\noptions(width = 120)\ndevtools::session_info()\n```\n\n</details>\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":8,"fig-height":5,"fig-format":"png","fig-dpi":600,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"message":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"center","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":true,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true,"format-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../styles.css"],"highlight-style":"arrow","output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.3.433","knitr":{"opts_chunk":{"collapse":true,"comment":"#>"}},"comments":{"utterances":{"repo":"pmassicotte/PMassicotte.github.io"}},"theme":{"light":"flatly","dark":"darkly"},"mainfont":"Montserrat","fig-asp":0.618,"title-block-banner":true,"title":" Changing spatial resolution of a raster with terra","author":"Philippe Massicotte","date":"2022-04-28","categories":["R","Geospatial"],"image":"img/preview.png"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}