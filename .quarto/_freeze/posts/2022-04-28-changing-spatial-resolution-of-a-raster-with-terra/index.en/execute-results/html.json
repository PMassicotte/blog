{
  "hash": "9fffd02101f4e3b090b5527c954f53cd",
  "result": {
    "markdown": "---\ntitle: \" Changing spatial resolution of a raster with terra\"\nauthor: \"Philippe Massicotte\"\ndate: \"2021-04-28\"\ncategories: [R, geospatial]\nimage: \"images/usgs-nSOZqxCIEAs-unsplash.jpg\"\n---\n\n\n\n\nLately, I was working on a project and I needed to change the spatial resolution of a GeoTIFF to match that of another one. After looking around, I posted [a question on Stackoverflow](https://stackoverflow.com/questions/72044284/how-to-change-a-raster-to-a-specific-spatial-resolution/72044772#72044772). After experimenting around, I decided to blog about my experience of changing the spatial resolution of GeoTIFF rasters.\n\nIn this post, we will explore two ways to change the spatial resolution of a raster:\n\n1. Aggregating/disaggregating pixels.\n2. Resampling pixels from one geometry to another one.\n\n![Shimmering blues and greens accentuate the textures of the Sierra de Velasco Mountains of northern Argentina. The urban area (pinkish circle) near the lower left part of the mountain range is La Rioja, the capital of the province of La Rioja. Follow the foothills to the upper right, where the city of San Fernando del Valle de Catamarca lies near extensive vineyards and fruit-growing areas (blue blocky shapes).](images/usgs-nSOZqxCIEAs-unsplash.jpg){width=75%}\n<center>Photo by <a href=\"https://unsplash.com/@usgs?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText\">USGS</a> on <a href=\"https://unsplash.com/s/photos/landsat?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText\">Unsplash</a></center>\n\n## Aggregating a raster\n\nI like to think that aggregating is the process of combining/merging the pixels of a raster and hence **reducing its spatial resolution**. When combining a set of neighbour pixels into a single pixel, one needs to define the statistical summary to be applied to the ensemble of the combined pixel. Such function can be the mean, median, min, maximum or any other function that produces a single numerical value.\n\nLet's see how aggregation works using the `terra` R package. First, I will make a function that will be used to quickly display the pixel values of a raster.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nplot_raster <- function(r) {\n  plot(r, axes = FALSE, legend = FALSE)\n  plot(as.polygons(r, dissolve = FALSE, trunc = FALSE), add = TRUE)\n  text(r, digits = 2)\n}\n```\n:::\n\n\nFor simplicity purposes, I will create a 4 by 4 raster containing values between 1 and 16.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(terra)\n\n# Create a 4 x 4 matrix\nm <- matrix(1:16, ncol = 4, nrow = 4)\n\n# Convert the matrix into a raster\nr16 <- rast(m)\n\nr16\n#> class       : SpatRaster \n#> dimensions  : 4, 4, 1  (nrow, ncol, nlyr)\n#> resolution  : 1, 1  (x, y)\n#> extent      : 0, 4, 0, 4  (xmin, xmax, ymin, ymax)\n#> coord. ref. :  \n#> source      : memory \n#> name        : lyr.1 \n#> min value   :     1 \n#> max value   :    16\n```\n:::\n\n\nUsing `plot_raster()`, we can display the value of each pixel within the raster. \n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nplot_raster(r16)\n```\n\n::: {.cell-output-display}\n![](index.en_files/figure-html/unnamed-chunk-3-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\nImagine now that we would like to aggregate the raster `r16` so it becomes a raster of 2 by 2 (i.e. 4 pixels). To achieve this, we can combine pixels 2 by 2 (horizontally and vertically) using the `aggregate()` function and the argument `fact = 2`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Aggregate the raster using 2 pixels within the horizontal and the vertical directions\nr4 <- aggregate(r16, fact = 2)\n\nr4\n#> class       : SpatRaster \n#> dimensions  : 2, 2, 1  (nrow, ncol, nlyr)\n#> resolution  : 2, 2  (x, y)\n#> extent      : 0, 4, 0, 4  (xmin, xmax, ymin, ymax)\n#> coord. ref. :  \n#> source      : memory \n#> name        : lyr.1 \n#> min value   :   3.5 \n#> max value   :  13.5\n\nplot_raster(r4)\n```\n\n::: {.cell-output-display}\n![](index.en_files/figure-html/unnamed-chunk-4-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\nWhat happened is that, by default, the `aggregate()` function is using the `mean()` function to summarize the pixel values. Hence, the upper left pixel has a value of 3.5 which correspond to the average of 4 pixels `(1 + 5 + 2 + 6) / 4 = 3.5`. As mentioned previously, one can use any function that returns a single value such as the `min()` function. \n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Aggregate using the min() function\nplot_raster(aggregate(r16, fun = \"min\"))\n```\n\n::: {.cell-output-display}\n![](index.en_files/figure-html/unnamed-chunk-5-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n## Disaggregating a raster\n\nIf aggregating is the process of combining pixels, disaggregating is the process of **splitting** pixels into smaller ones. This operation is done with `disagg()`. Using the original 4 x 4 `r16`raster, each pixel will be disaggregated into 16 smaller pixels, once again using the `fact` argument.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nr256 <- disagg(r16, fact = 4)\nr256\n#> class       : SpatRaster \n#> dimensions  : 16, 16, 1  (nrow, ncol, nlyr)\n#> resolution  : 0.25, 0.25  (x, y)\n#> extent      : 0, 4, 0, 4  (xmin, xmax, ymin, ymax)\n#> coord. ref. :  \n#> source      : memory \n#> name        : lyr.1 \n#> min value   :     1 \n#> max value   :    16\n```\n:::\n\n\nHere, each pixel of the original `r16` raster is divided into 16 smaller pixels (4 x 4), giving a total of 256 pixels (16 x 16).\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nplot_raster(r256)\n```\n\n::: {.cell-output-display}\n![](index.en_files/figure-html/unnamed-chunk-7-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\n## Resampling\n\nResampling is the process of transferring the values from a raster into another raster that does not have the same geometry (i.e. cell size). This is often the case when working with remote-sensing products that are derived from sources with different spatial resolutions. For the following examples, I will use data from Sentinel-2 (10 meters resolution) and Landsat-8 (30 meters resolution). Both scenes are from the same area and [https://www.gisagmaps.com/l8-s2-comparison-and-download/](taken 15 minutes apart). Raster files can be downloaded on [https://www.gisagmaps.com/l8-s2-comparison-and-download/L8_S2_080415_Comparison.zip](www.gisagmaps.com). Images contain the top of atmosphere (TOA) reflectance and we will use the RGB bands.\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ns2 <- rast(fs::dir_ls(\"data/L8_S2_080415_Comparison/S2_080415_TOA\"))\ns2\n#> class       : SpatRaster \n#> dimensions  : 451, 451, 3  (nrow, ncol, nlyr)\n#> resolution  : 10, 10  (x, y)\n#> extent      : 282040, 286550, 4564930, 4569440  (xmin, xmax, ymin, ymax)\n#> coord. ref. : WGS 84 / UTM zone 17N (EPSG:32617) \n#> sources     : S2_B2_10m_080415_TOA.tif  \n#>               S2_B3_10m_080415_TOA.tif  \n#>               S2_B4_10m_080415_TOA.tif  \n#> names       : S2_B2_10m_080415_TOA, S2_B3_10m_080415_TOA, S2_B4_10m_080415_TOA\n\nl8 <- rast(fs::dir_ls(\"data/L8_S2_080415_Comparison/L8_080415_TOA\"))\nl8\n#> class       : SpatRaster \n#> dimensions  : 150, 150, 3  (nrow, ncol, nlyr)\n#> resolution  : 30, 30  (x, y)\n#> extent      : 282045, 286545, 4564935, 4569435  (xmin, xmax, ymin, ymax)\n#> coord. ref. : WGS 84 / UTM zone 17N (EPSG:32617) \n#> sources     : L8_B2_080415_TOA.tif  \n#>               L8_B3_080415_TOA.tif  \n#>               L8_B4_080415_TOA.tif  \n#> names       : L8_B2_080415_TOA, L8_B3_080415_TOA, L8_B4_080415_TOA\n```\n:::\n\n\nWe can easily see the difference in spatial resolution between the two images.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\npar(mar = c(1, 1, 3, 1), oma = c(1, 1, 3, 1))\nplotRGB(s2, 3, 2, 1, stretch = \"lin\")\nmtext(\"Sentinel-2 (10 meters)\", side = 3)\n\npar(mar = c(1, 1, 3, 1), oma = c(1, 1, 3, 1))\nplotRGB(l8, 3, 2, 1, stretch = \"lin\")\nmtext(\"Landsat-8 (30 meters)\", side = 3)\n```\n\n::: {.cell-output-display}\n![](index.en_files/figure-html/unnamed-chunk-9-1.png){fig-align='center' width=100%}\n:::\n\n::: {.cell-output-display}\n![](index.en_files/figure-html/unnamed-chunk-9-2.png){fig-align='center' width=100%}\n:::\n:::\n\n\nBecause the two rasters (`s2` and `l8`) do not have the same geometry, algebra operations can not be performed.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nl8 - s2\n#> Error: [-] extents do not match\n```\n:::\n\n\nGiven that the pixel resolution of the Landsat-8 image is exactly a factor of 3 compared to Sentinel-2, one can be tempted to use `disagg()` to get the 10 m pixel resolution from the Landsat-8 so it matches the resolution of the Sentinel-2 image.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nl8_10m <- disagg(l8, fact = 3)\nl8_10m\n#> class       : SpatRaster \n#> dimensions  : 450, 450, 3  (nrow, ncol, nlyr)\n#> resolution  : 10, 10  (x, y)\n#> extent      : 282045, 286545, 4564935, 4569435  (xmin, xmax, ymin, ymax)\n#> coord. ref. : WGS 84 / UTM zone 17N (EPSG:32617) \n#> source      : memory \n#> names       : L8_B2_080415_TOA, L8_B3_080415_TOA, L8_B4_080415_TOA \n#> min values  :       0.07772131,       0.05887134,       0.03377673 \n#> max values  :        0.2687978,        0.3173852,        0.3191263\n\nres(s2)\n#> [1] 10 10\n\nres(l8_10m)\n#> [1] 10 10\n```\n:::\n\n\nHowever, this is still not working because the two rasters do not have the exact extent.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nl8_10m - s2\n#> Error: [-] extents do not match\n```\n:::\n\n\nThe solution is to use `resample()` to transfer the values of `l8` into the same geometry of `s2`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nl8_resampled <- resample(l8, s2)\n\nl8_resampled\n#> class       : SpatRaster \n#> dimensions  : 451, 451, 3  (nrow, ncol, nlyr)\n#> resolution  : 10, 10  (x, y)\n#> extent      : 282040, 286550, 4564930, 4569440  (xmin, xmax, ymin, ymax)\n#> coord. ref. : WGS 84 / UTM zone 17N (EPSG:32617) \n#> source      : memory \n#> names       : L8_B2_080415_TOA, L8_B3_080415_TOA, L8_B4_080415_TOA \n#> min values  :       0.07844353,       0.06003592,       0.03450089 \n#> max values  :        0.2486627,        0.2781480,        0.2809660\n\npar(mar = c(1, 1, 3, 1), oma = c(1, 1, 3, 1))\nplotRGB(l8_resampled, 3, 2, 1, stretch = \"lin\")\nmtext(\"Landsat-8 (resampled to 10 meters)\", side = 3)\n```\n\n::: {.cell-output-display}\n![](index.en_files/figure-html/unnamed-chunk-13-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\nNow, we can perform raster operations.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nl8_resampled - s2\n#> class       : SpatRaster \n#> dimensions  : 451, 451, 3  (nrow, ncol, nlyr)\n#> resolution  : 10, 10  (x, y)\n#> extent      : 282040, 286550, 4564930, 4569440  (xmin, xmax, ymin, ymax)\n#> coord. ref. : WGS 84 / UTM zone 17N (EPSG:32617) \n#> source      : memory \n#> names       : L8_B2_080415_TOA, L8_B3_080415_TOA, L8_B4_080415_TOA \n#> min values  :       -0.2693594,       -0.2698378,       -0.2766064 \n#> max values  :        0.1274634,        0.1734840,        0.1898374\n```\n:::\n\n\n### UPDATE:  2022-07-30\n\n[Michael Sumner](https://twitter.com/mdsumner) on Twitter pointed out that the same resampling operation could be done using `project()`.\n\n<center>\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n```{=html}\n{{% tweet \"1529101265279795200\" %}}\n```\n:::\n:::\n\n</center>\n\nLet's try resampling `l8` onto the same grid as `s2`.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nl8_resampled_project <- project(l8, s2)\n\nl8_resampled_project\n#> class       : SpatRaster \n#> dimensions  : 451, 451, 3  (nrow, ncol, nlyr)\n#> resolution  : 10, 10  (x, y)\n#> extent      : 282040, 286550, 4564930, 4569440  (xmin, xmax, ymin, ymax)\n#> coord. ref. : WGS 84 / UTM zone 17N (EPSG:32617) \n#> source      : memory \n#> names       : L8_B2_080415_TOA, L8_B3_080415_TOA, L8_B4_080415_TOA \n#> min values  :       0.07844353,       0.06003592,       0.03450089 \n#> max values  :        0.2486627,        0.2781480,        0.2809660\nl8_resampled\n#> class       : SpatRaster \n#> dimensions  : 451, 451, 3  (nrow, ncol, nlyr)\n#> resolution  : 10, 10  (x, y)\n#> extent      : 282040, 286550, 4564930, 4569440  (xmin, xmax, ymin, ymax)\n#> coord. ref. : WGS 84 / UTM zone 17N (EPSG:32617) \n#> source      : memory \n#> names       : L8_B2_080415_TOA, L8_B3_080415_TOA, L8_B4_080415_TOA \n#> min values  :       0.07844353,       0.06003592,       0.03450089 \n#> max values  :        0.2486627,        0.2781480,        0.2809660\n```\n:::\n\n\nIndeed, this is working perfectly fine and we can see that `l8_resampled_project` is now on the same 10 m by 10 m grid as `s2`.\n\nWhereas this is working fine, I thought it was worth mentioning that if you **only want to reproject a raster** and not change the dimensions of the grid, one should use the destination CRS rather than the raster itself. Here both `l8` and `s2` have the same CRS and hence only reprojecting (i.e. without resampling) will not change the coordinate system.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nidentical(crs(l8), crs(s2))\n#> [1] TRUE\n```\n:::\n\n\nHowever, let's do it for demonstration purposes.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nproject(l8, crs(s2))\n#> class       : SpatRaster \n#> dimensions  : 150, 150, 3  (nrow, ncol, nlyr)\n#> resolution  : 30, 30  (x, y)\n#> extent      : 282045, 286545, 4564935, 4569435  (xmin, xmax, ymin, ymax)\n#> coord. ref. : WGS 84 / UTM zone 17N (EPSG:32617) \n#> source      : memory \n#> names       : L8_B2_080415_TOA, L8_B3_080415_TOA, L8_B4_080415_TOA \n#> min values  :       0.07772131,       0.05887134,       0.03377673 \n#> max values  :        0.2687978,        0.3173852,        0.3191263\n```\n:::\n\n\nAs we can see, using `project(l8, crs(s2))` instead of `project(l8, s2)` will not change the pixel resolution of the reprojected raster. The reprojected `l8` raster still has a pixel resolution of 30 m by 30 m.\n\n<details>\n  \n<summary>Session info</summary>\n\n\n::: {.cell layout-align=\"center\"}\n\n```\n#> ─ Session info ───────────────────────────────────────────────────────────────────────────────────────────────────────\n#>  setting  value\n#>  version  R version 4.2.1 (2022-06-23)\n#>  os       Ubuntu 22.04 LTS\n#>  system   x86_64, linux-gnu\n#>  ui       X11\n#>  language en_CA:en\n#>  collate  en_CA.UTF-8\n#>  ctype    en_CA.UTF-8\n#>  tz       America/Toronto\n#>  date     2022-07-30\n#>  pandoc   2.18 @ /usr/lib/rstudio/bin/quarto/bin/tools/ (via rmarkdown)\n#> \n#> ─ Packages ───────────────────────────────────────────────────────────────────────────────────────────────────────────\n#>  package     * version date (UTC) lib source\n#>  blogdown      1.10    2022-05-10 [1] CRAN (R 4.2.1)\n#>  cachem        1.0.6   2021-08-19 [1] RSPM (R 4.2.0)\n#>  callr         3.7.1   2022-07-13 [1] RSPM (R 4.2.0)\n#>  cli           3.3.0   2022-04-25 [1] RSPM (R 4.2.0)\n#>  codetools     0.2-18  2020-11-04 [2] CRAN (R 4.2.1)\n#>  crayon        1.5.1   2022-03-26 [1] RSPM (R 4.2.0)\n#>  devtools      2.4.4   2022-07-20 [1] RSPM (R 4.2.0)\n#>  digest        0.6.29  2021-12-01 [1] RSPM (R 4.2.0)\n#>  ellipsis      0.3.2   2021-04-29 [1] RSPM (R 4.2.0)\n#>  evaluate      0.15    2022-02-18 [1] RSPM (R 4.2.0)\n#>  fastmap       1.1.0   2021-01-25 [1] RSPM (R 4.2.0)\n#>  fs            1.5.2   2021-12-08 [1] RSPM (R 4.2.0)\n#>  glue          1.6.2   2022-02-24 [1] RSPM (R 4.2.0)\n#>  htmltools     0.5.3   2022-07-18 [1] RSPM (R 4.2.0)\n#>  htmlwidgets   1.5.4   2021-09-08 [1] RSPM (R 4.2.0)\n#>  httpuv        1.6.5   2022-01-05 [1] RSPM (R 4.2.0)\n#>  jsonlite      1.8.0   2022-02-22 [1] RSPM (R 4.2.0)\n#>  knitr         1.39    2022-04-26 [1] RSPM (R 4.2.0)\n#>  later         1.3.0   2021-08-18 [1] CRAN (R 4.2.1)\n#>  lifecycle     1.0.1   2021-09-24 [1] RSPM (R 4.2.0)\n#>  magrittr      2.0.3   2022-03-30 [1] RSPM (R 4.2.0)\n#>  memoise       2.0.1   2021-11-26 [1] RSPM (R 4.2.0)\n#>  mime          0.12    2021-09-28 [1] RSPM (R 4.2.0)\n#>  miniUI        0.1.1.1 2018-05-18 [1] RSPM (R 4.2.0)\n#>  pkgbuild      1.3.1   2021-12-20 [1] RSPM (R 4.2.0)\n#>  pkgload       1.3.0   2022-06-27 [1] RSPM (R 4.2.0)\n#>  prettyunits   1.1.1   2020-01-24 [1] RSPM (R 4.2.0)\n#>  processx      3.7.0   2022-07-07 [1] RSPM (R 4.2.0)\n#>  profvis       0.3.7   2020-11-02 [1] RSPM (R 4.2.0)\n#>  promises      1.2.0.1 2021-02-11 [1] RSPM (R 4.2.0)\n#>  ps            1.7.1   2022-06-18 [1] RSPM (R 4.2.0)\n#>  purrr         0.3.4   2020-04-17 [1] RSPM (R 4.2.0)\n#>  R6            2.5.1   2021-08-19 [1] RSPM (R 4.2.0)\n#>  Rcpp          1.0.9   2022-07-08 [1] RSPM (R 4.2.0)\n#>  remotes       2.4.2   2021-11-30 [1] CRAN (R 4.2.1)\n#>  rlang         1.0.4   2022-07-12 [1] RSPM (R 4.2.0)\n#>  rmarkdown     2.14    2022-04-25 [1] RSPM (R 4.2.0)\n#>  rspm          0.1.0.3 2022-07-27 [1] Github (Enchufa2/rspm@ba091ae)\n#>  rstudioapi    0.13    2020-11-12 [1] RSPM (R 4.2.0)\n#>  sessioninfo   1.2.2   2021-12-06 [1] RSPM (R 4.2.0)\n#>  shiny         1.7.2   2022-07-19 [1] RSPM (R 4.2.0)\n#>  stringi       1.7.8   2022-07-11 [1] RSPM (R 4.2.0)\n#>  stringr       1.4.0   2019-02-10 [1] RSPM (R 4.2.0)\n#>  terra       * 1.6-3   2022-07-25 [1] RSPM (R 4.2.0)\n#>  urlchecker    1.0.1   2021-11-30 [1] RSPM (R 4.2.0)\n#>  usethis       2.1.6   2022-05-25 [1] CRAN (R 4.2.1)\n#>  xfun          0.31    2022-05-10 [1] RSPM (R 4.2.0)\n#>  xtable        1.8-4   2019-04-21 [1] CRAN (R 4.2.1)\n#>  yaml          2.3.5   2022-02-21 [1] RSPM (R 4.2.0)\n#> \n#>  [1] /home/filoche/R/x86_64-pc-linux-gnu-library/4.2\n#>  [2] /opt/R/4.2.1/lib/R/library\n#> \n#> ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────\n```\n:::\n\n\n</details>\n",
    "supporting": [
      "index.en_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}