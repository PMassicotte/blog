{
  "hash": "563394b03ebcaaa77c84339170612b55",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: 'Speeding up spatial manipulation with geos'\nauthor:\n  - name: Philippe Massicotte\n    url: https://example.com/norajones\n    affiliation: Spacely Sprockets\n    affiliation-url: https://example.com/spacelysprokets\ncitation: true\ndate: '2023-06-03'\ncategories: [R, Geospatial]\n# The preview file needs to be named preview.png\n# mogrify -format png preview.jpg\n# https://quarto.org/docs/websites/website-tools.html#preview-images\nimage: 'img/preview.png'\neditor_options:\n  chunk_output_type: console\ndraft: true\n---\n\n\n\n\n\n\n<!-- ![Let's crop something! Photo by <a href=\"https://unsplash.com/@rozetsky?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText\">Ant Rozetsky</a> on <a href=\"https://unsplash.com/s/photos/crop?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText\">Unsplash</a>](img/preview.png){fig-alt=\"Close up on a grain field\" fig-align=\"center\"} -->\n\nAs the volume of spatial data continues to increase, it becomes more important than ever to use the right tools to manage, analyze, and visualize geospatial data effectively. I have been using the `sf` [package](https://r-spatial.github.io/sf/) for most of my vector operations. While this is working fine most of the time, I came up in a situation where I needed to determine how many points were intersecting a polygon which can be simply done with the `sf::st_intersects()` function.\n\nThe problem I had, however, was that I needed to work with a rather large dataset containing approximately 3.5 millions of points and the `sf::st_intersects()` function was taking way too long to do the operation. This is why I started to explore different approaches that could speed up the process. In this blog post, we will rapidly explore the `geos` [package](https://github.com/paleolimbot/geos/) to work with (large) spatial. The `geos` package provides bindings to the GEOS (Geometry Engine - Open Source) library. GEOS is a C++ library that provides functions for performing advanced spatial operations, such as geometry creation, transformation, validation, and analysis.\n\n- First approach was to use the `sf` library. However it took way to long to execute.\n- Then, I came across the `geos` [package](https://github.com/paleolimbot/geos/) which I found to be much much faster.\n\n## Making up some data\n\nFor this example, I will generate random points and see those that fall over the land using the world map.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(geos)\nlibrary(rnaturalearth)\nlibrary(rnaturalearthdata)\nlibrary(geosphere)\nlibrary(sf)\nlibrary(ggplot2)\nsf_use_s2(FALSE)\n\nmap <- ne_countries(returnclass = \"sf\", scale = \"medium\") |>\n  st_make_valid()\n\nggplot() +\n  geom_sf(data = map)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png)\n:::\n:::\n\n\nNow, we can generate\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbbox <- st_bbox(map)\n\nn <- 1e3\nlon <- runif(n, bbox[1], bbox[3])\nlat <- runif(n, bbox[2], bbox[4])\n\npts <- st_as_sf(\n  as.data.frame(cbind(lon, lat)),\n  coords = c(\"lon\", \"lat\"), crs = 4326\n)\n\nhead(pts)\n#> Simple feature collection with 6 features and 0 fields\n#> Geometry type: POINT\n#> Dimension:     XY\n#> Bounding box:  xmin: -123.9343 ymin: -63.38356 xmax: 165.1145 ymax: 45.61978\n#> Geodetic CRS:  WGS 84\n#>                     geometry\n#> 1 POINT (165.1145 -41.12996)\n#> 2 POINT (94.72628 -63.38356)\n#> 3  POINT (10.87592 6.746091)\n#> 4 POINT (-123.9343 45.61978)\n#> 5 POINT (115.8849 -55.94893)\n#> 6 POINT (59.92484 -2.034669)\n\nggplot() +\n  geom_sf(data = pts, size = 0.2) +\n  geom_sf(data = map, alpha = 0.5, fill = \"red\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png)\n:::\n:::\n\n\n- We can create a geometry column using the `geos_make_point()` function.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npts_geos <- pts |>\n  as_geos_geometry()\n\nhead(pts_geos)\n#> <geos_geometry[6] with CRS=WGS 84>\n#> [1] <POINT (165.1145 -41.12996)>  <POINT (94.72628 -63.38356)> \n#> [3] <POINT (10.87592 6.74609)>    <POINT (-123.93428 45.61978)>\n#> [5] <POINT (115.88487 -55.94893)> <POINT (59.92484 -2.03467)>\n\nmap_geos <- as_geos_geometry(map)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmicrobenchmark::microbenchmark(\n  res_sf <- st_intersects(pts, map),\n  res_geos <- geos_contains_matrix(map_geos, pts_geos),\n  times = 1\n)\n#> Unit: milliseconds\n#>                                                  expr       min        lq\n#>                     res_sf <- st_intersects(pts, map) 24.260764 24.260764\n#>  res_geos <- geos_contains_matrix(map_geos, pts_geos)  4.997904  4.997904\n#>       mean    median        uq       max neval\n#>  24.260764 24.260764 24.260764 24.260764     1\n#>   4.997904  4.997904  4.997904  4.997904     1\n\nsum(lengths(res_sf) > 0)\n#> [1] 354\n\nlength(unlist(res_geos))\n#> [1] 354\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\np <- ggplot() +\n  geom_sf(data = map, size = 0.25) +\n  geom_sf(data = st_as_sf(pts_geos), size = 0.25) +\n  coord_sf(\n    xlim = c(-180, 0),\n    ylim = c(40, 90)\n  )\n\np\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png)\n:::\n\n```{.r .cell-code}\n\nmap_geos <- as_geos_geometry(map)\nres <- unlist(res_geos)\n\n# This gives the index of the points over the polygon\nhead(res)\n#> [1] 684 519 765 577 155 991\n\nlength(res)\n#> [1] 354\n\npts_over <- pts |>\n  dplyr::slice(res) |>\n  st_as_sf()\n\np +\n  geom_sf(data = pts_over, color = \"red\") +\n  coord_sf(\n    xlim = c(-180, 0),\n    ylim = c(40, 90)\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-2.png)\n:::\n:::\n\n\n<details>\n  \n<summary>Session info</summary>\n\n\n::: {.cell}\n\n```\n#> ─ Session info ───────────────────────────────────────────────────────────────────────────────────────────────────────\n#>  setting  value\n#>  version  R version 4.4.0 (2024-04-24)\n#>  os       Ubuntu 24.04 LTS\n#>  system   x86_64, linux-gnu\n#>  ui       X11\n#>  language en_CA:en\n#>  collate  en_CA.UTF-8\n#>  ctype    en_CA.UTF-8\n#>  tz       America/Toronto\n#>  date     2024-05-02\n#>  pandoc   3.1.3 @ /usr/bin/ (via rmarkdown)\n#> \n#> ─ Packages ───────────────────────────────────────────────────────────────────────────────────────────────────────────\n#>  ! package           * version    date (UTC) lib source\n#>  P cachem              1.0.8      2023-05-01 [?] RSPM (R 4.4.0)\n#>  P class               7.3-22     2023-05-03 [?] CRAN (R 4.4.0)\n#>  P classInt            0.4-10     2023-09-05 [?] RSPM (R 4.4.0)\n#>  P cli                 3.6.2      2023-12-11 [?] RSPM (R 4.4.0)\n#>  P codetools           0.2-20     2024-03-31 [?] CRAN (R 4.4.0)\n#>  P colorspace          2.1-0      2023-01-23 [?] RSPM (R 4.4.0)\n#>  P DBI                 1.2.2      2024-02-16 [?] RSPM (R 4.4.0)\n#>  P devtools            2.4.5      2022-10-11 [?] RSPM\n#>  P digest              0.6.35     2024-03-11 [?] RSPM (R 4.4.0)\n#>  P dplyr             * 1.1.4      2023-11-17 [?] RSPM (R 4.4.0)\n#>  P e1071               1.7-14     2023-12-06 [?] RSPM (R 4.4.0)\n#>  P ellipsis            0.3.2      2021-04-29 [?] RSPM (R 4.4.0)\n#>  P evaluate            0.23       2023-11-01 [?] RSPM (R 4.4.0)\n#>  P extrafont           0.19       2023-01-18 [?] RSPM (R 4.4.0)\n#>  P extrafontdb         1.0        2012-06-11 [?] RSPM (R 4.4.0)\n#>  P fansi               1.0.6      2023-12-08 [?] RSPM (R 4.4.0)\n#>  P farver              2.1.1      2022-07-06 [?] CRAN (R 4.4.0)\n#>  P fastmap             1.1.1      2023-02-24 [?] RSPM (R 4.4.0)\n#>  P forcats           * 1.0.0      2023-01-29 [?] RSPM (R 4.4.0)\n#>  P fs                  1.6.4      2024-04-25 [?] CRAN (R 4.4.0)\n#>  P generics            0.1.3      2022-07-05 [?] RSPM (R 4.4.0)\n#>  P geos              * 0.2.4      2023-11-30 [?] RSPM\n#>  P geosphere         * 1.5-18     2022-11-15 [?] RSPM\n#>  P ggplot2           * 3.5.1      2024-04-23 [?] RSPM (R 4.4.0)\n#>  P ggpmthemes        * 0.0.2      2024-05-02 [?] Github (pmassicotte/ggpmthemes@993d61e)\n#>  P glue                1.7.0      2024-01-09 [?] RSPM (R 4.4.0)\n#>  P gtable              0.3.5      2024-04-22 [?] RSPM (R 4.4.0)\n#>  P hms                 1.1.3      2023-03-21 [?] RSPM (R 4.4.0)\n#>  P htmltools           0.5.8.1    2024-04-04 [?] RSPM (R 4.4.0)\n#>  P htmlwidgets         1.6.4      2023-12-06 [?] RSPM\n#>  P httpuv              1.6.15     2024-03-26 [?] RSPM (R 4.4.0)\n#>  P httr                1.4.7      2023-08-15 [?] RSPM (R 4.4.0)\n#>  P jsonlite            1.8.8      2023-12-04 [?] RSPM (R 4.4.0)\n#>  P KernSmooth          2.23-22    2023-07-10 [?] CRAN (R 4.4.0)\n#>  P knitr               1.46       2024-04-06 [?] RSPM (R 4.4.0)\n#>  P later               1.3.2      2023-12-06 [?] RSPM (R 4.4.0)\n#>  P lattice             0.22-6     2024-03-20 [?] CRAN (R 4.4.0)\n#>  P libgeos             3.11.1-2   2023-11-29 [?] RSPM\n#>  P lifecycle           1.0.4      2023-11-07 [?] RSPM (R 4.4.0)\n#>  P lubridate         * 1.9.3      2023-09-27 [?] RSPM (R 4.4.0)\n#>  P magrittr            2.0.3      2022-03-30 [?] RSPM (R 4.4.0)\n#>  P memoise             2.0.1      2021-11-26 [?] RSPM (R 4.4.0)\n#>  P microbenchmark      1.4.10     2023-04-28 [?] RSPM\n#>  P mime                0.12       2021-09-28 [?] RSPM (R 4.4.0)\n#>  P miniUI              0.1.1.1    2018-05-18 [?] RSPM (R 4.4.0)\n#>  P munsell             0.5.1      2024-04-01 [?] CRAN (R 4.4.0)\n#>  R nvimcom           * 0.9.41     <NA>       [?] <NA>\n#>  P pillar              1.9.0      2023-03-22 [?] RSPM (R 4.4.0)\n#>  P pkgbuild            1.4.4      2024-03-17 [?] RSPM (R 4.4.0)\n#>  P pkgconfig           2.0.3      2019-09-22 [?] RSPM (R 4.4.0)\n#>  P pkgload             1.3.4      2024-01-16 [?] RSPM\n#>  P processx            3.8.4      2024-03-16 [?] RSPM (R 4.4.0)\n#>  P profvis             0.3.8      2023-05-02 [?] RSPM\n#>  P promises            1.3.0      2024-04-05 [?] RSPM (R 4.4.0)\n#>  P proxy               0.4-27     2022-06-09 [?] RSPM (R 4.4.0)\n#>  P ps                  1.7.6      2024-01-18 [?] RSPM (R 4.4.0)\n#>  P purrr             * 1.0.2      2023-08-10 [?] RSPM (R 4.4.0)\n#>  P quarto            * 1.4        2024-03-06 [?] RSPM\n#>  P R.cache             0.16.0     2022-07-21 [?] RSPM\n#>  P R.methodsS3         1.8.2      2022-06-13 [?] RSPM\n#>  P R.oo                1.26.0     2024-01-24 [?] RSPM\n#>  P R.utils             2.12.3     2023-11-18 [?] RSPM\n#>  P R6                  2.5.1      2021-08-19 [?] RSPM (R 4.4.0)\n#>  P Rcpp                1.0.12     2024-01-09 [?] RSPM (R 4.4.0)\n#>  P readr             * 2.1.5      2024-01-10 [?] RSPM (R 4.4.0)\n#>  P remotes             2.5.0      2024-03-17 [?] RSPM\n#>  P renv                1.0.7      2024-04-11 [?] RSPM (R 4.4.0)\n#>  P rlang               1.1.3      2024-01-10 [?] RSPM (R 4.4.0)\n#>  P rmarkdown           2.26       2024-03-05 [?] RSPM (R 4.4.0)\n#>  P rnaturalearth     * 1.0.1      2023-12-15 [?] RSPM\n#>  P rnaturalearthdata * 1.0.0.9000 2024-05-02 [?] Github (ropensci/rnaturalearthdata@d0e161e)\n#>  P rstudioapi          0.16.0     2024-03-24 [?] RSPM\n#>  P Rttf2pt1            1.3.12     2023-01-22 [?] RSPM (R 4.4.0)\n#>  P scales              1.3.0      2023-11-28 [?] CRAN (R 4.4.0)\n#>  P sessioninfo         1.2.2      2021-12-06 [?] RSPM\n#>  P sf                * 1.0-16     2024-03-24 [?] RSPM (R 4.4.0)\n#>  P shiny               1.8.1.1    2024-04-02 [?] RSPM (R 4.4.0)\n#>  P sp                  2.1-4      2024-04-30 [?] RSPM\n#>  P stringi             1.8.3      2023-12-11 [?] RSPM (R 4.4.0)\n#>  P stringr           * 1.5.1      2023-11-14 [?] RSPM (R 4.4.0)\n#>  P styler            * 1.10.3     2024-04-07 [?] RSPM\n#>  P terra               1.7-71     2024-01-31 [?] CRAN (R 4.4.0)\n#>  P tibble            * 3.2.1      2023-03-20 [?] RSPM (R 4.4.0)\n#>  P tidyr             * 1.3.1      2024-01-24 [?] RSPM (R 4.4.0)\n#>  P tidyselect          1.2.1      2024-03-11 [?] RSPM (R 4.4.0)\n#>  P tidyverse         * 2.0.0      2023-02-22 [?] RSPM (R 4.4.0)\n#>  P timechange          0.3.0      2024-01-18 [?] RSPM (R 4.4.0)\n#>  P tzdb                0.4.0      2023-05-12 [?] RSPM (R 4.4.0)\n#>  P units               0.8-5      2023-11-28 [?] RSPM (R 4.4.0)\n#>  P urlchecker          1.0.1      2021-11-30 [?] RSPM\n#>  P usethis             2.2.3      2024-02-19 [?] RSPM\n#>  P utf8                1.2.4      2023-10-22 [?] RSPM (R 4.4.0)\n#>  P vctrs               0.6.5      2023-12-01 [?] RSPM (R 4.4.0)\n#>  P withr               3.0.0      2024-01-16 [?] RSPM (R 4.4.0)\n#>  P wk                  0.9.1      2023-11-29 [?] RSPM (R 4.4.0)\n#>  P xfun                0.43       2024-03-25 [?] RSPM (R 4.4.0)\n#>  P xtable              1.8-4      2019-04-21 [?] RSPM (R 4.4.0)\n#>  P yaml                2.3.8      2023-12-11 [?] RSPM (R 4.4.0)\n#> \n#>  [1] /tmp/RtmpamKAy9/renv-use-libpath-2f876f2389f9a0\n#>  [2] /home/filoche/.cache/R/renv/sandbox/linux-ubuntu-noble/R-4.4/x86_64-pc-linux-gnu/a71ef467\n#> \n#>  P ── Loaded and on-disk path mismatch.\n#>  R ── Package was removed from disk.\n#> \n#> ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────\n```\n:::\n\n\n</details>\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}