{
  "hash": "79a6ecf366f106fa281a6e0fa855d388",
  "result": {
    "markdown": "---\ntitle: \"How to read AMSR2 sea ice data with terra\"\nauthor: \"Philippe Massicotte\"\ndate: \"2022-08-11\"\ncategories: [R, Geospatial]\n# https://quarto.org/docs/websites/website-tools.html#preview-images\nimage: \"img/preview.png\" \neditor_options: \n  chunk_output_type: console\n---\n\n\nToday I was trying to read [AMSR2](https://www.ospo.noaa.gov/Products/atmosphere/gpds/about_amsr2.html) sea ice [data](ftp://ftp-projects.cen.uni-hamburg.de/seaice/AMSR2/3.125km). I was surprised to discover that the files do not include coordinates or projection information. Data and coordinates are contained in different files! Maybe to save some disk space ‚ÅâÔ∏è The sea ice data is (for example) in a file named **Arc_20201010_res3.125_pyres.nc.gz** whereas the coordinates are included in a file name **LongitudeLatitudeGrid_3.125km_Arctic.nc**. Furthermore, I found that the provided coordinates are provided in long/lat format whereas the gridded data are projected üò†\n\n![](img/preview.png){fig-align=\"center\"}\n\nPhoto by <a href=\"https://unsplash.com/@willianjusten?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText\">Willian Justen de Vasconcellos</a> on <a href=\"https://unsplash.com/s/photos/arctic?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText\">Unsplash</a>\n\nIf I read the data directly, one can see that there are no coordinates or projection information.\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(terra)\nlibrary(ggplot2)\nlibrary(tidyterra)\n\nr <- rast(\n  \"/vsigzip//vsicurl/ftp://ftp-projects.cen.uni-hamburg.de/seaice/AMSR2/3.125km/Arc_20201010_res3.125_pyres.nc.gz\",\n  \"sea_ice_concentration\"\n)\n\n# No projection information\nr\n#> class       : SpatRaster \n#> dimensions  : 3584, 2432, 1  (nrow, ncol, nlyr)\n#> resolution  : 1, 1  (x, y)\n#> extent      : 0.5, 2432.5, 0.5, 3584.5  (xmin, xmax, ymin, ymax)\n#> coord. ref. :  \n#> source      : Arc_20201010_res3.125_pyres.nc.gz:sea_ice_concentration \n#> varname     : sea_ice_concentration (daily averaged total ice concentration) \n#> name        : sea_ice_concentration \n#> unit        :                     % \n#> time        : 2020-10-10 12:00:00 UTC\n```\n:::\n\n\nFortunately, I found [this post](https://rstudio-pubs-static.s3.amazonaws.com/271229_1e3acab94bc8470f8e8154bef5cc0a5a.html) by [Michael Sumner](https://twitter.com/mdsumner) which guided me on how to manipulate this data. What we have to do is to set the extent and the proper projection after the file is read. This can be done using the `ext()` and `crs()` function from the `terra` package. Based on the [documentation](https://polarwatch.noaa.gov/erddap/info/nsidcCDRice_nh_grid/index.html), we can manually set the proper values.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Set the extent\next(r) <- ext(-3837500, 3762500, -5362500, 5837500)\n\n# Set the polar stereographic projection\ncrs(r) <- \"EPSG:3411\"\n```\n:::\n\n\nNow, if we take a look at the raster, we can see that it is correctly projected and has a resolution of 3.125 km as [expected](ftp://ftp-projects.cen.uni-hamburg.de/seaice/AMSR2/README.txt) ‚úåÔ∏è\n\n\n::: {.cell}\n\n```{.r .cell-code}\nr\n#> class       : SpatRaster \n#> dimensions  : 3584, 2432, 1  (nrow, ncol, nlyr)\n#> resolution  : 3125, 3125  (x, y)\n#> extent      : -3837500, 3762500, -5362500, 5837500  (xmin, xmax, ymin, ymax)\n#> coord. ref. : WGS 84 / NSIDC Sea Ice Polar Stereographic North (EPSG:3413) \n#> source      : Arc_20201010_res3.125_pyres.nc.gz:sea_ice_concentration \n#> varname     : sea_ice_concentration (daily averaged total ice concentration) \n#> name        : sea_ice_concentration \n#> unit        :                     % \n#> time        : 2020-10-10 12:00:00 UTC\n```\n:::\n\n\nFinally, visualize the raster.\n\n\n::: {.cell layout-align=\"center\" crop='true'}\n\n```{.r .cell-code}\n# Set values of 0 to NA\nNAflag(r) <- 0\n\nggplot() +\n  geom_spatraster(data = r / 100) +\n  scale_fill_viridis_c(\n    na.value = \"transparent\",\n    labels = scales::label_percent(),\n    breaks = scales::breaks_pretty(n = 6),\n    guide = guide_colorbar(\n      title.position = \"top\",\n      title.hjust = 0.5,\n      barwidth = unit(5, \"cm\"),\n      barheight = unit(0.2, \"cm\")\n    )\n  ) +\n  labs(\n    fill = \"Sea ice concentration\"\n  ) +\n  theme_minimal() +\n  theme(\n    legend.position = \"top\",\n    panel.grid = element_line(size = 0.25)\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/sic-plot-1.png){fig-align='center' width=45%}\n:::\n:::\n\n\n<details>\n\n<summary>Session info</summary>\n\n\n::: {.cell}\n\n```\n#> ‚ïê Session info ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n#> ‚îÄ Packages ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n#>  ! package     * version date (UTC) lib source\n#>  P assertthat    0.2.1   2019-03-21 [?] RSPM\n#>  P cachem        1.0.6   2021-08-19 [?] RSPM (R 4.2.0)\n#>  P callr         3.7.1   2022-07-13 [?] RSPM (R 4.2.1)\n#>  P class         7.3-20  2022-01-13 [?] RSPM (R 4.2.0)\n#>  P classInt      0.4-7   2022-06-10 [?] RSPM (R 4.2.0)\n#>  P cli           3.3.0   2022-04-25 [?] RSPM (R 4.2.0)\n#>  P codetools     0.2-18  2020-11-04 [?] RSPM (R 4.2.0)\n#>  P colorspace    2.0-3   2022-02-21 [?] RSPM (R 4.2.0)\n#>  P crayon        1.5.1   2022-03-26 [?] RSPM (R 4.2.0)\n#>  P data.table    1.14.2  2021-09-27 [?] RSPM\n#>  P DBI           1.1.3   2022-06-18 [?] RSPM (R 4.2.0)\n#>  P devtools      2.4.4   2022-07-20 [?] RSPM (R 4.2.0)\n#>  P digest        0.6.29  2021-12-01 [?] RSPM\n#>  P dplyr       * 1.0.9   2022-04-28 [?] RSPM (R 4.2.0)\n#>  P e1071         1.7-11  2022-06-07 [?] RSPM (R 4.2.0)\n#>  P ellipsis      0.3.2   2021-04-29 [?] RSPM\n#>  P evaluate      0.15    2022-02-18 [?] RSPM (R 4.2.0)\n#>  P fansi         1.0.3   2022-03-24 [?] RSPM (R 4.2.0)\n#>  P farver        2.1.1   2022-07-06 [?] RSPM (R 4.2.1)\n#>  P fastmap       1.1.0   2021-01-25 [?] RSPM\n#>  P fs            1.5.2   2021-12-08 [?] RSPM\n#>  P generics      0.1.3   2022-07-05 [?] RSPM (R 4.2.1)\n#>  P ggplot2     * 3.3.6   2022-05-03 [?] RSPM (R 4.2.0)\n#>  P glue          1.6.2   2022-02-24 [?] RSPM (R 4.2.0)\n#>  P gtable        0.3.0   2019-03-25 [?] RSPM\n#>  P htmltools     0.5.3   2022-07-18 [?] RSPM (R 4.2.1)\n#>  P htmlwidgets   1.5.4   2021-09-08 [?] RSPM (R 4.2.0)\n#>  P httpuv        1.6.5   2022-01-05 [?] RSPM (R 4.2.0)\n#>  P jsonlite      1.8.0   2022-02-22 [?] RSPM (R 4.2.0)\n#>  P KernSmooth    2.23-20 2021-05-03 [?] RSPM (R 4.2.0)\n#>  P knitr         1.39    2022-04-26 [?] RSPM (R 4.2.0)\n#>  P later         1.3.0   2021-08-18 [?] RSPM (R 4.2.0)\n#>  P lifecycle     1.0.1   2021-09-24 [?] RSPM\n#>  P magick        2.7.3   2021-08-18 [?] CRAN (R 4.2.0)\n#>  P magrittr      2.0.3   2022-03-30 [?] RSPM (R 4.2.0)\n#>  P memoise       2.0.1   2021-11-26 [?] CRAN (R 4.2.0)\n#>  P mime          0.12    2021-09-28 [?] RSPM\n#>  P miniUI        0.1.1.1 2018-05-18 [?] RSPM (R 4.2.0)\n#>  P munsell       0.5.0   2018-06-12 [?] RSPM\n#>  P pillar        1.8.0   2022-07-18 [?] RSPM (R 4.2.1)\n#>  P pkgbuild      1.3.1   2021-12-20 [?] CRAN (R 4.2.0)\n#>  P pkgconfig     2.0.3   2019-09-22 [?] RSPM\n#>  P pkgload       1.3.0   2022-06-27 [?] RSPM (R 4.2.0)\n#>  P prettyunits   1.1.1   2020-01-24 [?] RSPM\n#>  P processx      3.7.0   2022-07-07 [?] RSPM (R 4.2.1)\n#>  P profvis       0.3.7   2020-11-02 [?] RSPM (R 4.2.0)\n#>  P promises      1.2.0.1 2021-02-11 [?] RSPM (R 4.2.0)\n#>  P proxy         0.4-27  2022-06-09 [?] RSPM (R 4.2.0)\n#>  P ps            1.7.1   2022-06-18 [?] RSPM (R 4.2.0)\n#>  P purrr         0.3.4   2020-04-17 [?] RSPM\n#>  P R6            2.5.1   2021-08-19 [?] RSPM\n#>  P Rcpp          1.0.9   2022-07-08 [?] RSPM (R 4.2.1)\n#>  P remotes       2.4.2   2021-11-30 [?] CRAN (R 4.2.0)\n#>    renv          0.15.5  2022-05-26 [1] RSPM (R 4.2.0)\n#>  P rlang         1.0.4   2022-07-12 [?] RSPM (R 4.2.1)\n#>  P rmarkdown     2.14    2022-04-25 [?] RSPM (R 4.2.0)\n#>  P rstudioapi    0.13    2020-11-12 [?] RSPM\n#>  P s2            1.1.0   2022-07-18 [?] RSPM (R 4.2.0)\n#>  P scales        1.2.0   2022-04-13 [?] RSPM (R 4.2.0)\n#>  P sessioninfo   1.2.2   2021-12-06 [?] CRAN (R 4.2.0)\n#>  P sf            1.0-8   2022-07-14 [?] RSPM (R 4.2.0)\n#>  P shiny         1.7.2   2022-07-19 [?] RSPM (R 4.2.1)\n#>  P stringi       1.7.8   2022-07-11 [?] RSPM (R 4.2.1)\n#>  P stringr       1.4.0   2019-02-10 [?] RSPM\n#>  P terra       * 1.6-3   2022-07-25 [?] RSPM (R 4.2.0)\n#>  P tibble      * 3.1.8   2022-07-22 [?] RSPM (R 4.2.1)\n#>  P tidyr       * 1.2.0   2022-02-01 [?] RSPM (R 4.2.0)\n#>  P tidyselect    1.1.2   2022-02-21 [?] RSPM (R 4.2.0)\n#>  P tidyterra   * 0.2.0   2022-06-21 [?] RSPM (R 4.2.1)\n#>  P units         0.8-0   2022-02-05 [?] RSPM (R 4.2.0)\n#>  P urlchecker    1.0.1   2021-11-30 [?] RSPM (R 4.2.0)\n#>  P usethis       2.1.6   2022-05-25 [?] RSPM (R 4.2.0)\n#>  P utf8          1.2.2   2021-07-24 [?] RSPM\n#>  P vctrs         0.4.1   2022-04-13 [?] RSPM (R 4.2.0)\n#>  P viridisLite   0.4.0   2021-04-13 [?] RSPM\n#>  P withr         2.5.0   2022-03-03 [?] RSPM (R 4.2.0)\n#>  P wk            0.6.0   2022-01-03 [?] RSPM (R 4.2.0)\n#>  P xfun          0.31    2022-05-10 [?] RSPM (R 4.2.0)\n#>  P xtable        1.8-4   2019-04-21 [?] RSPM (R 4.2.0)\n#>  P yaml          2.3.5   2022-02-21 [?] RSPM (R 4.2.0)\n#> \n#>  [1] /media/LaCie16TB/work/r-blog/renv/library/R-4.2/x86_64-pc-linux-gnu\n#>  [2] /usr/lib/R/library\n#> \n#>  P ‚îÄ‚îÄ Loaded and on-disk path mismatch.\n#> \n#> ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n```\n:::\n\n\n</details>\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}