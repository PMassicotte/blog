{
  "hash": "347e664f18ece5c970b82c2904970850",
  "result": {
    "markdown": "---\ntitle: \"Arrow partitioning and fast querying\"\nauthor: \"Philippe Massicotte\"\ndate: \"2022-10-11\"\ncategories: [R, Arrow]\n# The preview file needs to be named preview.png\n# mogrify -format png preview.jpg\n# https://quarto.org/docs/websites/website-tools.html#preview-images\nimage: \"img/preview.png\" \neditor_options: \n  chunk_output_type: console\ndraft: true\n---\n\n\n\n\n## Downloading data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# https://s3.amazonaws.com/tripdata/index.html\n\ntmpfile <- tempfile(fileext = \".zip\")\nurl <- \"https://s3.amazonaws.com/tripdata/201307-201402-citibike-tripdata.zip\"\n\ndownload.file(url, tmpfile)\nfiles <- unzip(tmpfile, list = TRUE)\n\nds <- open_dataset(unzip(tmpfile, files$Name, exdir = tempdir()), format = \"csv\")\n\nds\n#> FileSystemDataset with 8 csv files\n#> tripduration: int64\n#> starttime: timestamp[s]\n#> stoptime: timestamp[s]\n#> start station id: int64\n#> start station name: string\n#> start station latitude: double\n#> start station longitude: double\n#> end station id: int64\n#> end station name: string\n#> end station latitude: double\n#> end station longitude: double\n#> bikeid: int64\n#> usertype: string\n#> birth year: string\n#> gender: int64\nnrow(ds)\n#> [1] 5562321\n```\n:::\n\n\n![Photo by <a href=\"https://unsplash.com/@possessedphotography?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText\">Possessed Photography</a> on <a href=\"https://unsplash.com/s/photos/arrow?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText\">Unsplash</a>](img/preview.png){fig-alt=\"A bunch of arrows on a wall\" fig-align=\"center\"}\n\n## Data processing\n\nLet's now calculate the age of each user based on the current date and their birth year.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nds <- ds |>\n  select(\n    birth_year = `birth year`,\n    tripduration\n  ) |>\n  filter(str_detect(birth_year, \"\\\\d{4}\")) |>\n  mutate(birth_year = as.integer(birth_year)) |> \n  mutate(user_age = lubridate::year(Sys.Date()) - birth_year) |>\n  na.omit(birth_year)\n\nds |>\n  head() |>\n  collect()\n#> # A tibble: 6 × 3\n#>   birth_year tripduration user_age\n#>        <int>        <int>    <int>\n#> 1       1979         1015       43\n#> 2       1970          962       52\n#> 3       1982          768       40\n#> 4       1976          218       46\n#> 5       1983          550       39\n#> 6       1975          102       47\n\n# Number of observations\nnrow(ds)\n#> [1] 4881484\n```\n:::\n\n\n\nOverview of the data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nds |>\n  head() |>\n  collect()\n#> # A tibble: 6 × 3\n#>   birth_year tripduration user_age\n#>        <int>        <int>    <int>\n#> 1       1986          471       36\n#> 2       1963         1494       59\n#> 3       1991          464       31\n#> 4       1989          373       33\n#> 5       1990          660       32\n#> 6       1987          330       35\n```\n:::\n\n\nExport\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlow_partition <- \"~/Desktop/low_partition\" \nhigh_partition <- \"~/Desktop/high_partition\" \n\nwrite_dataset(ds, low_partition, existing_data_behavior = \"overwrite\")\n\nwrite_dataset(ds, high_partition, existing_data_behavior = \"overwrite\", partitioning = \"birth_year\", )\n```\n:::\n\n\nSize of the folder\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfs::dir_info(low_partition)$size\n#> 21.3M\nsum(fs::dir_info(high_partition, recurse = TRUE)$size)\n#> 62.4M\n```\n:::\n\n\n## Benchmarks\n\n\n::: {.cell}\n\n```{.r .cell-code}\nf <- function(path) {\n  open_dataset(path) |>\n    group_by(user_age) |>\n    summarise(mean_duration = mean(tripduration, na.rm = TRUE), n = n()) |>\n    collect()\n}\n\nres <- microbenchmark::microbenchmark(\n  low_partition = f(low_partition),\n  high_partition = f(high_partition),\n  times = 10\n)\n\nres\n#> Unit: milliseconds\n#>            expr       min        lq      mean    median        uq      max\n#>   low_partition  48.14952  50.60068  61.19986  52.62624  53.11071 128.1082\n#>  high_partition 844.73374 847.56141 871.53738 854.15297 883.08718 972.1908\n#>  neval\n#>     10\n#>     10\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nf(low_partition) |>\n  ggplot(aes(x = user_age, y = mean_duration)) +\n  geom_area()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png)\n:::\n:::\n\n\n<details>\n  \n<summary>Session info</summary>\n\n\n::: {.cell}\n\n```\n#> ─ Session info ───────────────────────────────────────────────────────────────────────────────────────────────────────\n#>  setting  value\n#>  version  R version 4.2.2 (2022-10-31)\n#>  os       Ubuntu 22.10\n#>  system   x86_64, linux-gnu\n#>  ui       X11\n#>  language en_CA:en\n#>  collate  en_CA.UTF-8\n#>  ctype    en_CA.UTF-8\n#>  tz       America/Toronto\n#>  date     2022-11-05\n#>  pandoc   2.17.1.1 @ /usr/bin/ (via rmarkdown)\n#> \n#> ─ Packages ───────────────────────────────────────────────────────────────────────────────────────────────────────────\n#>  ! package        * version date (UTC) lib source\n#>    arrow          * 9.0.0.2 2022-10-02 [1] RSPM (R 4.2.1)\n#>  P assertthat       0.2.1   2019-03-21 [?] CRAN (R 4.2.1)\n#>  P backports        1.4.1   2021-12-13 [?] CRAN (R 4.2.1)\n#>  P bit              4.0.4   2020-08-04 [?] CRAN (R 4.2.1)\n#>  P bit64            4.0.5   2020-08-30 [?] CRAN (R 4.2.1)\n#>  P broom            1.0.0   2022-07-01 [?] CRAN (R 4.2.1)\n#>  P cachem           1.0.6   2021-08-19 [?] CRAN (R 4.2.1)\n#>  P callr            3.7.1   2022-07-13 [?] RSPM (R 4.2.0)\n#>  P cellranger       1.1.0   2016-07-27 [?] CRAN (R 4.2.1)\n#>  P cli              3.3.0   2022-04-25 [?] CRAN (R 4.2.1)\n#>  P colorspace       2.0-3   2022-02-21 [?] CRAN (R 4.2.1)\n#>  P crayon           1.5.1   2022-03-26 [?] CRAN (R 4.2.1)\n#>  P curl             4.3.2   2021-06-23 [?] CRAN (R 4.2.1)\n#>  P DBI              1.1.3   2022-06-18 [?] CRAN (R 4.2.1)\n#>  P dbplyr           2.2.1   2022-06-27 [?] CRAN (R 4.2.1)\n#>  P devtools         2.4.4   2022-07-20 [?] RSPM (R 4.2.0)\n#>  P digest           0.6.29  2021-12-01 [?] CRAN (R 4.2.1)\n#>  P dplyr          * 1.0.9   2022-04-28 [?] CRAN (R 4.2.1)\n#>  P ellipsis         0.3.2   2021-04-29 [?] CRAN (R 4.2.1)\n#>  P evaluate         0.16    2022-08-09 [?] CRAN (R 4.2.1)\n#>  P fansi            1.0.3   2022-03-24 [?] CRAN (R 4.2.1)\n#>  P farver           2.1.1   2022-07-06 [?] CRAN (R 4.2.1)\n#>  P fastmap          1.1.0   2021-01-25 [?] CRAN (R 4.2.1)\n#>  P forcats        * 0.5.1   2021-01-27 [?] RSPM (R 4.2.0)\n#>  P fs               1.5.2   2021-12-08 [?] CRAN (R 4.2.1)\n#>  P gargle           1.2.0   2021-07-02 [?] CRAN (R 4.2.1)\n#>  P generics         0.1.3   2022-07-05 [?] CRAN (R 4.2.1)\n#>  P ggplot2        * 3.3.6   2022-05-03 [?] CRAN (R 4.2.1)\n#>  P glue             1.6.2   2022-02-24 [?] CRAN (R 4.2.1)\n#>  P googledrive      2.0.0   2021-07-08 [?] CRAN (R 4.2.1)\n#>  P googlesheets4    1.0.1   2022-08-13 [?] CRAN (R 4.2.1)\n#>  P gtable           0.3.0   2019-03-25 [?] CRAN (R 4.2.1)\n#>  P haven            2.5.0   2022-04-15 [?] RSPM (R 4.2.0)\n#>  P hms              1.1.1   2021-09-26 [?] RSPM (R 4.2.0)\n#>  P htmltools        0.5.3   2022-07-18 [?] CRAN (R 4.2.1)\n#>  P htmlwidgets      1.5.4   2021-09-08 [?] CRAN (R 4.2.1)\n#>  P httpuv           1.6.5   2022-01-05 [?] RSPM (R 4.2.0)\n#>  P httr             1.4.4   2022-08-17 [?] CRAN (R 4.2.1)\n#>  P jsonlite         1.8.2   2022-10-02 [?] RSPM (R 4.2.0)\n#>  P knitr            1.39    2022-04-26 [?] RSPM (R 4.2.0)\n#>  P labeling         0.4.2   2020-10-20 [?] CRAN (R 4.2.1)\n#>  P later            1.3.0   2021-08-18 [?] CRAN (R 4.2.1)\n#>  P lifecycle        1.0.1   2021-09-24 [?] CRAN (R 4.2.1)\n#>  P lubridate        1.8.0   2021-10-07 [?] CRAN (R 4.2.1)\n#>  P magrittr         2.0.3   2022-03-30 [?] CRAN (R 4.2.1)\n#>  P memoise          2.0.1   2021-11-26 [?] CRAN (R 4.2.1)\n#>  P microbenchmark   1.4.9   2021-11-09 [?] RSPM (R 4.2.0)\n#>  P mime             0.12    2021-09-28 [?] CRAN (R 4.2.1)\n#>  P miniUI           0.1.1.1 2018-05-18 [?] RSPM (R 4.2.0)\n#>  P modelr           0.1.8   2020-05-19 [?] RSPM (R 4.2.0)\n#>  P munsell          0.5.0   2018-06-12 [?] CRAN (R 4.2.1)\n#>  P pillar           1.8.0   2022-07-18 [?] RSPM (R 4.2.0)\n#>  P pkgbuild         1.3.1   2021-12-20 [?] RSPM (R 4.2.0)\n#>  P pkgconfig        2.0.3   2019-09-22 [?] CRAN (R 4.2.1)\n#>  P pkgload          1.3.0   2022-06-27 [?] RSPM (R 4.2.0)\n#>  P prettyunits      1.1.1   2020-01-24 [?] CRAN (R 4.2.1)\n#>  P processx         3.7.0   2022-07-07 [?] CRAN (R 4.2.1)\n#>  P profvis          0.3.7   2020-11-02 [?] RSPM (R 4.2.0)\n#>  P promises         1.2.0.1 2021-02-11 [?] CRAN (R 4.2.1)\n#>  P ps               1.7.1   2022-06-18 [?] CRAN (R 4.2.1)\n#>  P purrr          * 0.3.4   2020-04-17 [?] CRAN (R 4.2.1)\n#>  P R6               2.5.1   2021-08-19 [?] CRAN (R 4.2.1)\n#>  P Rcpp             1.0.9   2022-07-08 [?] CRAN (R 4.2.1)\n#>  P readr          * 2.1.2   2022-01-30 [?] CRAN (R 4.2.1)\n#>  P readxl           1.4.1   2022-08-17 [?] CRAN (R 4.2.1)\n#>  P remotes          2.4.2   2021-11-30 [?] RSPM (R 4.2.0)\n#>    renv             0.15.5  2022-05-26 [1] CRAN (R 4.2.2)\n#>  P reprex           2.0.2   2022-08-17 [?] CRAN (R 4.2.1)\n#>  P rlang            1.0.4   2022-07-12 [?] CRAN (R 4.2.1)\n#>  P rmarkdown        2.17    2022-10-07 [?] RSPM (R 4.2.0)\n#>  P rvest            1.0.2   2021-10-16 [?] RSPM (R 4.2.0)\n#>  P scales           1.2.0   2022-04-13 [?] RSPM (R 4.2.0)\n#>  P sessioninfo      1.2.2   2021-12-06 [?] RSPM (R 4.2.0)\n#>  P shiny            1.7.2   2022-07-19 [?] RSPM (R 4.2.0)\n#>  P showtext       * 0.9-5   2022-02-09 [?] RSPM (R 4.2.0)\n#>  P showtextdb     * 3.0     2020-06-04 [?] RSPM (R 4.2.0)\n#>  P stringi          1.7.8   2022-07-11 [?] CRAN (R 4.2.1)\n#>  P stringr        * 1.4.0   2019-02-10 [?] RSPM (R 4.2.0)\n#>  P sysfonts       * 0.8.8   2022-03-13 [?] RSPM (R 4.2.0)\n#>  P tibble         * 3.1.8   2022-07-22 [?] CRAN (R 4.2.1)\n#>  P tidyr          * 1.2.0   2022-02-01 [?] CRAN (R 4.2.1)\n#>  P tidyselect       1.1.2   2022-02-21 [?] CRAN (R 4.2.1)\n#>  P tidyverse      * 1.3.2   2022-07-18 [?] CRAN (R 4.2.1)\n#>  P tzdb             0.3.0   2022-03-28 [?] CRAN (R 4.2.1)\n#>  P urlchecker       1.0.1   2021-11-30 [?] RSPM (R 4.2.0)\n#>  P usethis          2.1.6   2022-05-25 [?] RSPM (R 4.2.0)\n#>  P utf8             1.2.2   2021-07-24 [?] CRAN (R 4.2.1)\n#>  P vctrs            0.4.1   2022-04-13 [?] CRAN (R 4.2.1)\n#>  P withr            2.5.0   2022-03-03 [?] CRAN (R 4.2.1)\n#>  P xfun             0.32    2022-08-10 [?] CRAN (R 4.2.1)\n#>  P xml2             1.3.3   2021-11-30 [?] CRAN (R 4.2.1)\n#>  P xtable           1.8-4   2019-04-21 [?] RSPM (R 4.2.0)\n#>  P yaml             2.3.5   2022-02-21 [?] CRAN (R 4.2.1)\n#> \n#>  [1] /media/work/r-blog/renv/library/R-4.2/x86_64-pc-linux-gnu\n#>  [2] /usr/local/lib/R/library\n#> \n#>  P ── Loaded and on-disk path mismatch.\n#> \n#> ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────\n```\n:::\n\n\n</details>\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}